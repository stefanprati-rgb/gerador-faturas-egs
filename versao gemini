<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Faturas - EGS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --ink: #0B1220;
            --bg: #F7F8FA;
            --card: #FFFFFF;
            --line: #E7EBF0;
            --pdf-dark-bg: #191948;
            --pdf-dark-box: #12123B;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--ink);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 14px;
            box-shadow: 0 1px 2px rgba(16, 24, 40, .04);
            padding: 24px;
            margin-bottom: 24px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #191948;
            color: #FFFFFF;
        }

        .btn-primary:hover {
            background: #12123B;
        }

        .loader {
            border: 4px solid #e0e0e0;
            border-top: 4px solid #191948;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #drop-zone.drop-active {
            border-color: #191948;
            background: #eef2ff;
        }

        .page-break {
            page-break-before: always;
        }
    </style>
</head>

<body class="p-4 lg:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p id="loading-status" class="mt-4 text-gray-700 font-semibold">Carregando ambiente...</p>
    </div>

    <div class="w-full max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <svg class="mx-auto mb-4 h-12 w-auto" viewBox="0 0 200 50" fill="#191948"
                xmlns="http://www.w3.org/2000/svg">
                <text x="5" y="35" font-family="Poppins, sans-serif" font-size="30" font-weight="bold">EGS</text>
                <text x="65" y="35" font-family="Poppins, sans-serif" font-size="30">energia</text>
            </svg>
            <h1 class="text-4xl font-bold text-gray-800">Gerador de Faturas</h1>
            <p class="text-gray-600 mt-2">Gere as faturas personalizadas dos clientes a partir do relatório.</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-5 gap-6">
            <div class="md:col-span-2">
                <div class="card">
                    <h2 class="text-xl font-semibold">1. Carregar Relatório</h2>
                    <input id="file-upload" type="file" class="hidden" accept=".xlsm,.xlsx,.xls">
                    <div id="drop-zone"
                        class="mt-4 rounded-lg border-2 border-dashed border-gray-300 p-6 text-center text-gray-500 cursor-pointer">
                        <i class="fas fa-cloud-arrow-up text-3xl"></i>
                        <p class="font-semibold mt-2">Arraste e solte ou clique</p>
                    </div>
                    <p id="file-selected" class="mt-3 text-sm font-semibold text-green-700 hidden"></p>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold">2. Selecionar Mês</h2>
                    <input type="month" id="mes-referencia" class="mt-2 w-full rounded-lg border border-gray-300 p-2.5">
                </div>

                <button id="process-btn" class="w-full btn btn-primary text-lg py-3" disabled>
                    <i class="fas fa-cogs mr-2"></i> Processar Relatório
                </button>
            </div>

            <div class="md:col-span-3 card">
                <h2 class="text-xl font-semibold">3. Gerar Faturas</h2>
                <div id="search-container" class="relative mt-4 hidden">
                    <input type="text" id="search-client" placeholder="Procurar cliente..."
                        class="w-full rounded-lg border border-gray-300 p-2 pl-10">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i
                            class="fas fa-search text-gray-400"></i></span>
                </div>
                <div id="result-list" class="mt-4 space-y-2 max-h-96 overflow-y-auto">
                    <div id="empty-state" class="text-center text-gray-500 py-10">
                        <i class="fas fa-users text-3xl mb-2 text-gray-300"></i>
                        <p class="font-semibold">Aguardando processamento</p>
                    </div>
                </div>
                <div id="download-all-area" class="mt-4 hidden">
                    <button id="download-all-btn" class="w-full btn bg-gray-700 text-white hover:bg-gray-900 py-2">
                        <i class="fas fa-file-archive mr-2"></i> Baixar Todas (ZIP)
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Template Oculto para Geração do PDF -->
    <div class="fixed -left-[9999px] top-0 opacity-0">
        <div id="pdf-container">
            <!-- PÁGINA 1 -->
            <div id="pdf-page-1"
                style="width: 210mm; height: 297mm; background-color: white; color: var(--ink); padding: 40px; font-family: 'Poppins', sans-serif; display: flex; flex-direction: column;">
                <header class="flex justify-between items-start">
                    <div><svg viewBox="0 0 200 50" class="h-10" fill="#191948"><text x="5" y="35"
                                font-family="Poppins, sans-serif" font-size="30" font-weight="bold">EGS</text><text
                                x="65" y="35" font-family="Poppins, sans-serif" font-size="30">energia</text></svg>
                    </div>
                    <div id="pdf-titulo-p1" class="text-2xl font-semibold text-center text-gray-800">Sua contribuição de
                        [Mês] chegou</div>
                    <div class="w-1/3 text-right text-sm">
                        <p id="pdf-nome-cliente-p1" class="font-bold">[Nome Cliente]</p>
                        <p id="pdf-cpf-p1" class="text-gray-600">[CPF]</p>
                        <p id="pdf-endereco-p1" class="text-gray-600">[Endereço]</p>
                    </div>
                </header>
                <div class="flex-grow flex items-center">
                    <div class="w-full grid grid-cols-12 gap-6 items-center">
                        <div class="col-span-7">
                            <div class="p-8 rounded-2xl text-white" style="background-color: var(--pdf-dark-box);">
                                <p class="text-lg">Total a pagar</p>
                                <p id="pdf-total-pagar" class="text-6xl font-bold my-4">R$ 0,00</p>
                                <p class="text-sm">Data de vencimento</p>
                                <p id="pdf-vencimento-p1" class="text-lg font-semibold">[Data]</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full grid grid-cols-2 gap-8 text-lg mb-8">
                    <div>
                        <p>Economia Mês</p>
                        <p id="pdf-economia-mes" class="font-bold">R$ 0,00</p>
                        <p class="mt-4">Economia acumulada</p>
                        <p id="pdf-economia-acumulada" class="font-bold">R$ 0,00</p>
                    </div>
                    <div class="text-right">
                        <p>Árvores preservadas</p>
                        <p id="pdf-arvores" class="font-bold">0.00</p>
                        <p class="mt-4">CO2 poupados</p>
                        <p id="pdf-co2" class="font-bold">0.00 kg</p>
                    </div>
                </div>
                <div class="w-full grid grid-cols-2 gap-8 text-sm mb-4">
                    <div></div>
                    <div class="text-right">
                        <p>Código Instalação: <span id="pdf-instalacao-p1" class="font-bold">[Instalação]</span></p>
                        <p>Número da conta: <span id="pdf-numconta-p1" class="font-bold">[Num Conta]</span></p>
                        <p>Emissão: <span id="pdf-emissao-p1" class="font-bold">[Emissão]</span></p>
                    </div>
                </div>
                <div class="w-full text-sm mb-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-300">
                                <th class="text-left font-semibold pb-1">EGS Energia</th>
                                <th class="text-left font-semibold pb-1">Referência</th>
                                <th class="text-left font-semibold pb-1">Valor</th>
                                <th class="text-left font-semibold pb-1">Vencimento</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="pt-1">CNPJ:55.306.053/0001-27</td>
                                <td id="pdf-ref-tabela" class="pt-1">[Ref]</td>
                                <td id="pdf-valor-tabela" class="pt-1">[Valor]</td>
                                <td id="pdf-venc-tabela" class="pt-1">[Venc]</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <footer class="text-center text-xs text-gray-500">
                    <p class="mb-4">Em caso de atraso será cobrado uma multa de 2% e juros de 1% ao mês. Os boletos são
                        expirados após 10 dias corridos do vencimento.</p>
                    <p class="font-bold">Alguma dúvida? Entre em contato conosco</p>
                    <p>(31) 99761-8480 | sac@eraverdeenergia.com.br | https://eraverdeenergia.com.br/</p>
                    <div class="mt-4 p-2 rounded-lg font-bold text-white"
                        style="background-color: var(--pdf-dark-box);">Atenção! Você ainda precisa pagar a conta da
                        distribuidora.</div>
                </footer>
            </div>
            <!-- PÁGINA 2 -->
            <div id="pdf-page-2" class="page-break"
                style="width: 210mm; height: 297mm; background-color: white; color: var(--ink); padding: 40px; font-family: 'Poppins', sans-serif; display: flex; flex-direction: column;">
                <header class="flex justify-between items-start mb-8"><svg viewBox="0 0 200 50" class="h-10"
                        fill="#191948"><text x="5" y="35" font-family="Poppins, sans-serif" font-size="30"
                            font-weight="bold">EGS</text><text x="65" y="35" font-family="Poppins, sans-serif"
                            font-size="30">energia</text></svg></header>
                <div>
                    <h1 class="text-2xl font-bold">Detalhamento da sua Contribuição</h1>
                    <p class="text-gray-500">Aqui você pode verificar o detalhamento da sua contribuição desse mês.</p>
                </div>
                <table class="w-full mt-4 text-sm">
                    <thead>
                        <tr class="border-b border-gray-300">
                            <th class="text-left p-2">Descrição</th>
                            <th class="text-right p-2">Quantidade</th>
                            <th class="text-right p-2">Tarifa de referência</th>
                            <th class="text-right p-2">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-gray-200">
                            <td class="p-2">Crédito de Energia</td>
                            <td id="pdf-det-credito-qtd" class="text-right p-2"></td>
                            <td id="pdf-det-credito-tar" class="text-right p-2"></td>
                            <td id="pdf-det-credito-total" class="text-right p-2"></td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="p-2">Desconto extra</td>
                            <td class="text-right p-2"></td>
                            <td class="text-right p-2">0,00</td>
                            <td class="text-right p-2">R$ 0,00</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="p-2">Ajuste retroativo</td>
                            <td class="text-right p-2"></td>
                            <td class="text-right p-2"></td>
                            <td class="text-right p-2">R$ 0,00</td>
                        </tr>
                        <tr class="font-bold">
                            <td class="p-2">Total da sua contribuição</td>
                            <td class="text-right p-2"></td>
                            <td class="text-right p-2"></td>
                            <td id="pdf-det-total-contrib" class="text-right p-2"></td>
                        </tr>
                    </tbody>
                </table>
                <div class="grid grid-cols-2 gap-8 mt-8 flex-grow">
                    <div>
                        <h2 class="text-lg font-bold">Detalhamento da fatura com a Distribuidora</h2>
                        <p class="text-sm text-gray-500">Aqui você pode verificar como fica sua fatura da distribuidora
                            com os créditos gerados.</p>
                        <table class="w-full mt-4 text-sm">
                            <thead>
                                <tr class="border-b border-gray-300">
                                    <th class="text-left p-2">Descrição</th>
                                    <th class="text-right p-2">Quantidade</th>
                                    <th class="text-right p-2">Tarifa</th>
                                    <th class="text-right p-2">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-gray-200">
                                    <td class="p-2">Energia Elétrica Consumida</td>
                                    <td id="pdf-dist-consumo-qtd" class="text-right p-2"></td>
                                    <td id="pdf-dist-consumo-tar" class="text-right p-2"></td>
                                    <td id="pdf-dist-consumo-total" class="text-right p-2"></td>
                                </tr>
                                <tr class="border-b border-gray-200">
                                    <td class="p-2">Energia Elétrica Compensada</td>
                                    <td id="pdf-dist-comp-qtd" class="text-right p-2"></td>
                                    <td id="pdf-dist-comp-tar" class="text-right p-2"></td>
                                    <td id="pdf-dist-comp-total" class="text-right p-2"></td>
                                </tr>
                                <tr class="border-b border-gray-200">
                                    <td class="p-2">Contrib. Ilum. Pública e Outros</td>
                                    <td class="text-right p-2"></td>
                                    <td class="text-right p-2"></td><id="pdf-dist-outros" class="text-right p-2"></td>
                                </tr>
                                <tr class="font-bold">
                                    <td class="p-2">Total a pagar na sua fatura da distribuidora</td>
                                    <td class="text-right p-2"></td>
                                    <td class="text-right p-2"></td>
                                    <td id="pdf-dist-total" class="text-right p-2"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="text-sm">
                        <h2 class="text-lg font-bold">Como verificar o valor que você paga na assinatura</h2>
                        <p class="text-gray-500">Aqui você consegue entender a sua economia com esta solução.</p>
                        <div class="mt-4 p-4 rounded-lg text-white" style="background-color: var(--pdf-dark-box);">
                            <p class="font-bold">Consumindo da Distribuidora</p>
                            <p>(Tarifa <span id="pdf-econ-tarifa-dist"></span> x Qtd. <span
                                    id="pdf-econ-qtd-dist"></span>) + Outros <span id="pdf-econ-outros"></span> = <span
                                    id="pdf-econ-total-sem" class="font-bold"></span></p>
                        </div>
                        <div class="mt-2 p-4 rounded-lg text-white" style="background-color: var(--pdf-dark-box);">
                            <p class="font-bold">Contribuição Mensal</p>
                            <p>(Tarifa <span id="pdf-econ-tarifa-ev"></span> x Qtd. <span id="pdf-econ-qtd-ev"></span>)
                                + Total Distribuidora <span id="pdf-econ-total-dist"></span> = <span
                                    id="pdf-econ-total-com" class="font-bold"></span></p>
                        </div>
                        <div class="mt-2 p-4 rounded-lg text-center text-white"
                            style="background-color: var(--pdf-dark-box);">
                            <p class="font-bold text-lg">Total da sua Economia</p>
                            <p id="pdf-econ-economia-final" class="text-2xl font-bold"></p>
                        </div>
                    </div>
                </div>
                <footer class="text-center text-xs mt-auto text-gray-500">
                    <p class="font-bold">Alguma dúvida? Entre em contato conosco</p>
                    <p>(31) 99761-8480 | sac@eraverdeenergia.com.br | https://eraverdeenergia.com.br/</p>
                    <div class="mt-4 p-2 rounded-lg font-bold text-white"
                        style="background-color: var(--pdf-dark-box);">Atenção! Você ainda precisa pagar a conta da
                        distribuidora.</div>
                </footer>
            </div>
        </div>
    </div>


    <script type="text/python">
import pandas as pd
import io
import re
import unicodedata
import json
from datetime import datetime

def processar_relatorio_para_fatura(file_content, mes_referencia_str):
    import pandas as pd, io, json
    from datetime import datetime

    CO2_PER_KWH = 0.07
    TREES_PER_TON_CO2 = 8
    Fallback_Tarifa_Dist = 0.916370
    Fallback_Tarifa_Comp_Dist = 0.826009
    Fallback_Tarifa_Comp_EV = 0.716045
    Dias_Padrao_Venc = 15

    try:
        xls = pd.ExcelFile(io.BytesIO(file_content), engine='openpyxl')

        def find_sheet_and_header(xls, key_cols, prefer_name=None, max_rows=30):
            sheet_names = list(xls.sheet_names)
            if prefer_name and prefer_name in sheet_names:
                sheet_names.insert(0, sheet_names.pop(sheet_names.index(prefer_name)))
            for sheet_name in sheet_names:
                try:
                    df_sample = pd.read_excel(xls, sheet_name=sheet_name, header=None, nrows=max_rows)
                    for i, row in df_sample.iterrows():
                        row_as_string = ' '.join(str(v) for v in row.dropna().values)
                        if all(k in row_as_string for k in key_cols):
                            return sheet_name, i
                except Exception:
                    continue
            return None, -1

        aba_consumo, header_consumo = find_sheet_and_header(xls, ["REF"], prefer_name="Detalhe Por UC")
        if not aba_consumo or header_consumo < 0:
            return json.dumps({"error": "Aba com dados de consumo não encontrada."})

        df = pd.read_excel(xls, sheet_name=aba_consumo, header=header_consumo)
        df.columns = [str(c).strip() for c in df.columns]

        def _norm(s):
            import unicodedata, re
            s = str(s or "")
            s = "".join(c for c in unicodedata.normalize("NFD", s) if unicodedata.category(c) != "Mn")
            return re.sub(r"\s+", " ", s).strip().upper()
        def pick_col(df, *alternativas):
            cols_norm = {_norm(c): c for c in df.columns}
            for alt in alternativas:
                key = _norm(alt)
                if key in cols_norm: return cols_norm[key]
            for k, original in cols_norm.items():
                if any(_norm(a) in k for a in alternativas): return original
            return None
        def to_num(x):
            import re, pandas as pd
            if pd.isna(x): return 0.0
            if isinstance(x, (int, float)): return float(x)
            s = str(x).replace("\u00a0", " ").strip()
            s = re.sub(r"[Rr]\$|\%", "", s).replace(" ", "")
            if s.count(",") == 1 and s.count(".") >= 1: s = s.replace(".", "").replace(",", ".")
            elif s.count(",") == 1 and s.count(".") == 0: s = s.replace(",", ".")
            try: return float(s)
            except Exception: return 0.0

        col_ref = pick_col(df, "REF (sempre dia 01 de cada mês)", "REF")
        col_inst = pick_col(df, "Instalação", "Nº Instalação")
        col_nome = pick_col(df, "Nome Cliente", "Nome/Razão Social")
        col_doc = pick_col(df, "Documento", "CPF/CNPJ")
        col_consumo_qtd = pick_col(df, "CONSUMO_FP")
        col_comp_qtd = pick_col(df, "CRÉD. CONSUMIDO_FP")
        col_tarifa_consumo = pick_col(df, "TARIFA FP")
        col_tarifa_comp_ev = pick_col(df, "TARIFA_Comp_FP")
        col_tarifa_comp_dist = pick_col(df, "TARIFA DE ENERGIA COMPENSADA")
        col_outros = pick_col(df, "OUTROS")
        col_boleto_ev = pick_col(df, "Boleto Hube definido para a ref. Mensal")
        col_num_conta = pick_col(df, "Número da conta")
        col_endereco = pick_col(df, "Endereço")
        col_bairro = pick_col(df, "Bairro")
        col_cidade = pick_col(df, "Cidade")
        
        if not col_ref:
            return json.dumps({"error": "Coluna de referência (REF) não encontrada."})

        # --- OPTIMIZATION START ---
        df_calc = df.copy()
        
        col_map = {
            '_cons': col_consumo_qtd, '_comp': col_comp_qtd,
            '_tcons': col_tarifa_consumo, '_tcomp_e': col_tarifa_comp_ev,
            '_tcomp_d': col_tarifa_comp_dist, '_out': col_outros,
            '_boleto': col_boleto_ev
        }
        
        fallback_map = {
            '_tcons': Fallback_Tarifa_Dist, '_tcomp_e': Fallback_Tarifa_Comp_EV,
            '_tcomp_d': Fallback_Tarifa_Comp_Dist
        }

        for new_col, old_col in col_map.items():
            fallback_val = fallback_map.get(new_col, 0.0)
            if old_col and old_col in df_calc.columns:
                df_calc[new_col] = pd.to_numeric(df_calc[old_col].apply(to_num), errors='coerce').fillna(fallback_val)
            else:
                df_calc[new_col] = fallback_val

        ct_series = df_calc['_cons'] * df_calc['_tcons']
        cd_series = df_calc['_comp'] * df_calc['_tcomp_d']
        dtl_series = ct_series - cd_series + df_calc['_out']
        cl_series = df_calc['_boleto'].where(df_calc['_boleto'] > 0, df_calc['_comp'] * df_calc['_tcomp_e'])
        econ_total_sem_series = ct_series + df_calc['_out']
        econ_total_com_series = dtl_series + cl_series
        
        df_calc['_econ_mes'] = (econ_total_sem_series - econ_total_com_series).clip(lower=0)
        
        if col_inst and col_ref and col_inst in df_calc.columns and col_ref in df_calc.columns:
            df_calc[col_ref] = pd.to_datetime(df_calc[col_ref], errors='coerce')
            df_calc = df_calc.sort_values(by=[col_inst, col_ref])
            df_calc['_econ_acum'] = df_calc.groupby(col_inst)['_econ_mes'].cumsum().fillna(0)
        else:
            df_calc['_econ_acum'] = df_calc['_econ_mes']
        # --- OPTIMIZATION END ---

        df_calc[col_ref] = pd.to_datetime(df_calc[col_ref], errors="coerce")
        df_calc["_ref_month"] = df_calc[col_ref].dt.to_period("M")

        mes_referencia_dt = pd.to_datetime(mes_referencia_str)
        df_mes = df_calc[df_calc["_ref_month"] == mes_referencia_dt.to_period("M")].copy()
        
        if df_mes.empty:
            return json.dumps({"error": f"Nenhum dado para o mês {mes_referencia_str}."})
        
        clientes = []
        for _, row in df_mes.iterrows():
            consumo_qtd = row.get('_cons', 0)
            comp_qtd = row.get('_comp', 0)
            tarifa_consumo = row.get('_tcons', Fallback_Tarifa_Dist)
            tarifa_comp_ev = row.get('_tcomp_e', Fallback_Tarifa_Comp_EV)
            tarifa_comp_dist = row.get('_tcomp_d', Fallback_Tarifa_Comp_Dist)
            dist_outros_val = row.get('_out', 0)
            boleto_ev = row.get('_boleto', 0)
            
            consumo_total_val = consumo_qtd * tarifa_consumo
            comp_total_val_dist = comp_qtd * tarifa_comp_dist
            dist_total = consumo_total_val - comp_total_val_dist + dist_outros_val
            
            if boleto_ev > 0:
                contrib_total = boleto_ev
                det_credito_tar = tarifa_comp_ev if tarifa_comp_ev > 0 else None
                det_credito_total = contrib_total if det_credito_tar is None else comp_qtd * det_credito_tar
            else:
                det_credito_tar = tarifa_comp_ev
                det_credito_total = comp_qtd * det_credito_tar
                contrib_total = det_credito_total
            
            econ_total_sem = consumo_total_val + dist_outros_val
            econ_total_com = dist_total + contrib_total
            
            economia_mes_calc = row.get('_econ_mes', 0)
            economia_acum = row.get('_econ_acum', economia_mes_calc)

            co2_kg = comp_qtd * CO2_PER_KWH
            emissao_iso = datetime.now().strftime('%Y-%m-%d')
            vencimento_iso = (pd.Timestamp.today() + pd.Timedelta(days=Dias_Padrao_Venc)).strftime('%Y-%m-%d')

            clientes.append({
                "nome": str(row.get(col_nome, "")), "documento": str(row.get(col_doc, "")),
                "endereco": " ".join(filter(None, [str(row.get(col_endereco, "")), str(row.get(col_bairro, "")), str(row.get(col_cidade, ""))])).strip(),
                "instalacao": str(row.get(col_inst, "")), "num_conta": str(row.get(col_num_conta, "")),
                "emissao_iso": emissao_iso, "vencimento_iso": vencimento_iso,
                "totalPagar": contrib_total,
                "economiaMes": economia_mes_calc, "economiaTotal": economia_acum,
                "co2Evitado": co2_kg, "arvoresEquivalentes": (co2_kg / 1000.0) * TREES_PER_TON_CO2,
                "det_credito_qtd": comp_qtd, "det_credito_tar": det_credito_tar if det_credito_tar is not None else 0.0, "det_credito_total": det_credito_total,
                "dist_consumo_qtd": consumo_qtd, "dist_consumo_tar": tarifa_consumo, "dist_consumo_total": consumo_total_val,
                "dist_comp_qtd": comp_qtd, "dist_comp_tar": tarifa_comp_dist, "dist_comp_total": -comp_total_val_dist,
                "dist_outros": dist_outros_val, "dist_total": dist_total,
                "econ_total_sem": econ_total_sem, "econ_total_com": econ_total_com,
            })
        return json.dumps(clientes)
    except Exception as e:
        return json.dumps({"error": f"Erro inesperado no Python: {str(e)}"})
</script>

    <script>
        const loadingOverlay = document.getElementById('loading-overlay');
        const fileUpload = document.getElementById('file-upload');
        const dropZone = document.getElementById('drop-zone');
        const fileSelectedEl = document.getElementById('file-selected');
        const mesReferenciaEl = document.getElementById('mes-referencia');
        const processBtn = document.getElementById('process-btn');
        const resultList = document.getElementById('result-list');
        const emptyState = document.getElementById('empty-state');
        const downloadAllArea = document.getElementById('download-all-area');
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('search-client');
        const downloadAllBtn = document.getElementById('download-all-btn');

        let pyodide, pythonLoaded = false, selectedFile = null, clientData = [];

        async function initPyodide() {
            try {
                pyodide = await loadPyodide();
                document.getElementById('loading-status').textContent = 'Carregando pacotes...';
                await pyodide.loadPackage(['pandas', 'micropip']);
                document.getElementById('loading-status').textContent = 'Instalando dependências...';
                await pyodide.pyimport('micropip').install('openpyxl');
                pyodide.runPython(document.querySelector('script[type="text/python"]').textContent);
                pythonLoaded = true;
            } catch (e) {
                document.getElementById('loading-status').textContent = 'Falha ao carregar.';
                console.error("Erro no Pyodide:", e);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function setActionsEnabled(enabled) {
            processBtn.disabled = !enabled;
            downloadAllBtn.disabled = !enabled;
            resultList.querySelectorAll('.generate-pdf-btn').forEach(b => b.disabled = !enabled);
        }

        function validateForm() {
            const isReady = selectedFile && mesReferenciaEl.value;
            processBtn.disabled = !isReady;
            processBtn.classList.toggle('opacity-50', !isReady);
        }

        function setSelectedFile(file) {
            selectedFile = file;
            fileSelectedEl.classList.remove('hidden');
            fileSelectedEl.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            validateForm();
        }

        function formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function formatNumber(value, decimals = 2) { return (value || 0).toFixed(decimals).replace('.', ','); }
        function safe(s = '') { return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9_\-]+/gi, '_'); }

        async function populateAndGeneratePdfBlob(client) {
            const refDate = new Date(mesReferenciaEl.value + '-02T00:00:00');
            const emissao = new Date(client.emissao_iso + 'T00:00:00');
            const venc = new Date(client.vencimento_iso + 'T00:00:00');

            const mesNome = refDate.toLocaleDateString('pt-BR', { month: 'long', timeZone: 'UTC' });
            const mesCap = mesNome.charAt(0).toUpperCase() + mesNome.slice(1);
            document.getElementById('pdf-titulo-p1').textContent = `Sua contribuição de ${mesCap} chegou`;

            document.getElementById('pdf-total-pagar').textContent = formatCurrency(client.totalPagar);
            document.getElementById('pdf-vencimento-p1').textContent = venc.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric', timeZone: 'UTC' });
            document.getElementById('pdf-economia-mes').textContent = formatCurrency(client.economiaMes);
            document.getElementById('pdf-economia-acumulada').textContent = formatCurrency(client.economiaTotal);
            document.getElementById('pdf-arvores').textContent = formatNumber(client.arvoresEquivalentes);
            document.getElementById('pdf-co2').textContent = `${formatNumber(client.co2Evitado)} kg`;
            document.getElementById('pdf-nome-cliente-p1').textContent = client.nome;
            document.getElementById('pdf-cpf-p1').textContent = `CPF/CNPJ: ${client.documento}`;
            document.getElementById('pdf-endereco-p1').textContent = client.endereco;
            document.getElementById('pdf-instalacao-p1').textContent = client.instalacao;
            document.getElementById('pdf-numconta-p1').textContent = client.num_conta || '';
            document.getElementById('pdf-emissao-p1').textContent = emissao.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            document.getElementById('pdf-ref-tabela').textContent = refDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric', timeZone: 'UTC' });
            document.getElementById('pdf-valor-tabela').textContent = formatCurrency(client.totalPagar);
            document.getElementById('pdf-venc-tabela').textContent = venc.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            document.getElementById('pdf-det-credito-qtd').textContent = formatNumber(client.det_credito_qtd);
            document.getElementById('pdf-det-credito-tar').textContent = formatCurrency(client.det_credito_tar);
            document.getElementById('pdf-det-credito-total').textContent = formatCurrency(client.det_credito_total);
            document.getElementById('pdf-det-total-contrib').textContent = formatCurrency(client.totalPagar);
            document.getElementById('pdf-dist-consumo-qtd').textContent = `${formatNumber(client.dist_consumo_qtd)} kWh`;
            document.getElementById('pdf-dist-consumo-tar').textContent = formatCurrency(client.dist_consumo_tar);
            document.getElementById('pdf-dist-consumo-total').textContent = formatCurrency(client.dist_consumo_total);
            document.getElementById('pdf-dist-comp-qtd').textContent = `${formatNumber(client.dist_comp_qtd)} kWh`;
            document.getElementById('pdf-dist-comp-tar').textContent = formatCurrency(client.dist_comp_tar);
            document.getElementById('pdf-dist-comp-total').textContent = `${client.dist_comp_total < 0 ? '-' : ''} ${formatCurrency(Math.abs(client.dist_comp_total))}`;
            document.getElementById('pdf-dist-outros').textContent = formatCurrency(client.dist_outros);
            document.getElementById('pdf-dist-total').textContent = formatCurrency(client.dist_total);
            document.getElementById('pdf-econ-tarifa-dist').textContent = `R$ ${formatNumber(client.dist_consumo_tar, 6)}`;
            document.getElementById('pdf-econ-qtd-dist').textContent = `${formatNumber(client.dist_consumo_qtd)} kWh`;
            document.getElementById('pdf-econ-outros').textContent = formatCurrency(client.dist_outros);
            document.getElementById('pdf-econ-total-sem').textContent = formatCurrency(client.econ_total_sem);
            document.getElementById('pdf-econ-tarifa-ev').textContent = `R$ ${formatNumber(client.det_credito_tar, 6)}`;
            document.getElementById('pdf-econ-qtd-ev').textContent = `${formatNumber(client.det_credito_qtd)}`;
            document.getElementById('pdf-econ-total-dist').textContent = formatCurrency(client.dist_total);
            document.getElementById('pdf-econ-total-com').textContent = formatCurrency(client.econ_total_com);
            document.getElementById('pdf-econ-economia-final').textContent = formatCurrency(client.economiaMes);

            const element = document.getElementById('pdf-container');
            const filename = `Fatura_${safe(String(client.instalacao))}_${mesReferenciaEl.value}.pdf`;
            const opt = { margin: 0, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };

            const blob = await html2pdf().from(element).set(opt).output('blob');
            return { blob, filename };
        }

        function renderClientList(clientsToRender) {
            resultList.innerHTML = '';
            if (clientsToRender.length === 0) {
                resultList.innerHTML = `<p class="text-gray-500 p-4 text-center">Nenhum cliente encontrado.</p>`;
                return;
            }
            clientsToRender.forEach((client) => {
                const clientDiv = document.createElement('div');
                clientDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
                clientDiv.innerHTML = `
                <div>
                    <p class="text-sm font-medium">${client.nome}</p>
                    <p class="text-xs text-gray-500">Instalação: ${String(client.instalacao || '')}</p>
                </div>
                <button data-instalacao="${client.instalacao}" class="btn btn-primary btn-sm generate-pdf-btn">
                    <i class="fas fa-file-pdf mr-1"></i> Gerar PDF
                </button>
            `;
                resultList.appendChild(clientDiv);
            });
        }

        processBtn.addEventListener('click', async () => {
            if (!pythonLoaded || processBtn.disabled) return;

            setActionsEnabled(false);
            processBtn.innerHTML = '<div class="loader"></div> Processando...';

            const fileContent = await selectedFile.arrayBuffer();

            pyodide.globals.set('file_content_js', pyodide.toPy(new Uint8Array(fileContent)));
            pyodide.globals.set('mes_referencia_js', mesReferenciaEl.value + '-01');

            const resultJson = await pyodide.runPythonAsync('processar_relatorio_para_fatura(file_content_js, mes_referencia_js)');
            clientData = JSON.parse(resultJson);

            if (clientData.error) {
                resultList.innerHTML = `<p class="text-red-500 p-4">${clientData.error}</p>`;
                [searchContainer, downloadAllArea].forEach(el => el.classList.add('hidden'));
            } else if (clientData.length > 0) {
                emptyState.style.display = 'none';
                [searchContainer, downloadAllArea].forEach(el => el.classList.remove('hidden'));
                renderClientList(clientData);
            } else {
                resultList.innerHTML = `<p class="text-gray-500 p-4 text-center">Nenhum cliente para o mês.</p>`;
                [searchContainer, downloadAllArea].forEach(el => el.classList.add('hidden'));
            }

            processBtn.innerHTML = '<i class="fas fa-cogs mr-2"></i> Processar Relatório';
            setActionsEnabled(true);
            validateForm();
        });

        resultList.addEventListener('click', (e) => {
            const button = e.target.closest('.generate-pdf-btn');
            if (button) {
                const instalacao = button.dataset.instalacao;
                const client = clientData.find(c => String(c.instalacao) === String(instalacao));
                if (client) {
                    button.disabled = true;
                    button.innerHTML = '<div class="loader !w-4 !h-4 !border-2"></div>';
                    populateAndGeneratePdfBlob(client).then(({ blob, filename }) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    }).finally(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-file-pdf mr-1"></i> Gerar PDF';
                    });
                }
            }
        });

        function norm(s = '') { return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase(); }
        searchInput.addEventListener('input', (e) => {
            const q = norm(e.target.value);
            const filtered = clientData.filter(c => norm(c.nome).includes(q) || norm(String(c.instalacao)).includes(q));
            renderClientList(filtered);
        });

        downloadAllBtn.addEventListener('click', async () => {
            setActionsEnabled(false);
            downloadAllBtn.innerHTML = '<div class="loader"></div> Gerando ZIP... (0%)';

            const zip = new JSZip();
            let count = 0;

            for (const client of clientData) {
                try {
                    const { blob, filename } = await populateAndGeneratePdfBlob(client);
                    zip.file(filename, blob);
                    count++;
                    const progress = Math.round((count / clientData.length) * 100);
                    downloadAllBtn.innerHTML = `<div class="loader"></div> Gerando ZIP... (${progress}%)`;
                } catch (error) {
                    console.error(`Falha ao gerar PDF para ${client.nome}:`, error);
                }
            }

            zip.generateAsync({ type: "blob" }).then(function (content) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `Faturas_${mesReferenciaEl.value}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).finally(() => {
                downloadAllBtn.innerHTML = '<i class="fas fa-file-archive mr-2"></i> Baixar Todas as Faturas (ZIP)';
                setActionsEnabled(true);
            });
        });

        dropZone.addEventListener('click', () => fileUpload.click());
        fileUpload.addEventListener('change', (e) => setSelectedFile(e.target.files[0]));
        mesReferenciaEl.addEventListener('change', validateForm);
        ['dragenter', 'dragover'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.add('drop-active'); }));
        ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.remove('drop-active'); }));
        dropZone.addEventListener('drop', e => setSelectedFile(e.dataTransfer.files[0]));

        document.addEventListener('DOMContentLoaded', () => {
            // Improvement: Set the default month to the previous month for better UX
            const today = new Date();
            today.setMonth(today.getMonth() - 1);
            const previousMonth = today.toISOString().slice(0, 7);
            mesReferenciaEl.value = previousMonth;

            initPyodide();
        });
    </script>
</body>

</html>