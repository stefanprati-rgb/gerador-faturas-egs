<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Faturas HUBE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
          --brand: #00ED64;
          --ink: #0B1220;
          --bg: #F7F8FA;
          --card: #FFFFFF;
          --line: #E7EBF0;
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--ink); }
        .card {
            background: var(--card); border: 1px solid var(--line);
            border-radius: 14px; box-shadow: 0 1px 2px rgba(16,24,40,.04);
            padding: 24px; margin-bottom: 24px;
        }
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--brand); color: #052b18; }
        .btn-primary:hover { background: #00c754; }
        .loader {
            border: 4px solid #e0e0e0; border-top: 4px solid var(--brand);
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #drop-zone.drop-active { border-color: var(--brand); background: #f0fff6; }

        #pdf-template {
            width: 800px; font-family: 'Poppins', sans-serif; color: #333;
            background: white; border: 1px solid #eee;
        }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p id="loading-status" class="mt-4 text-gray-700 font-semibold">Carregando ambiente...</p>
    </div>

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <img src="https://hube.energy/wp-content/uploads/2024/10/Logo-1.svg" alt="HUBE Energy Logo" class="mx-auto mb-4 h-16 w-auto">
            <h1 class="text-4xl font-bold">Gerador de Faturas PDF</h1>
            <p class="text-gray-600 mt-2">Use o relatório para gerar as faturas de consumo e economia dos clientes.</p>
        </header>

        <main>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Coluna de Controles -->
                <div>
                    <div class="card">
                        <h2 class="text-xl font-semibold">1. Carregar Relatório</h2>
                        <input id="file-upload" type="file" class="hidden" accept=".xlsm,.xlsx,.xls">
                        <div id="drop-zone" class="mt-4 rounded-lg border-2 border-dashed border-gray-300 p-6 text-center text-gray-500 cursor-pointer">
                          <i class="fas fa-cloud-arrow-up text-3xl"></i>
                          <p class="font-semibold mt-2">Arraste e solte ou clique aqui</p>
                        </div>
                        <p id="file-selected" class="mt-3 text-sm font-semibold text-green-700 hidden"></p>
                    </div>
                    
                    <div class="card">
                        <h2 class="text-xl font-semibold">2. Selecionar Mês</h2>
                        <input type="month" id="mes-referencia" class="mt-2 w-full rounded-lg border border-[var(--line)] p-2.5">
                    </div>

                    <button id="process-btn" class="w-full btn btn-primary text-lg py-3" disabled>
                        <i class="fas fa-cogs mr-2"></i> Processar Relatório
                    </button>
                </div>

                <!-- Coluna de Resultados -->
                <div class="card">
                    <h2 class="text-xl font-semibold">3. Gerar Faturas</h2>
                    <div id="search-container" class="relative mt-4 hidden">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fas fa-search text-gray-400"></i>
                        </span>
                        <input type="text" id="search-client" placeholder="Procurar por nome ou instalação..." class="w-full rounded-lg border border-[var(--line)] p-2 pl-10 focus:ring-1 focus:ring-[var(--brand)] focus:border-[var(--brand)]">
                    </div>
                    <div id="result-list" class="mt-4 space-y-2 max-h-80 overflow-y-auto">
                        <div id="empty-state" class="text-center text-gray-500 py-10">
                            <i class="fas fa-users text-3xl mb-2 text-gray-300"></i>
                            <p class="font-semibold">Aguardando processamento</p>
                            <p class="text-sm">Os clientes aparecerão aqui.</p>
                        </div>
                    </div>
                    <div id="download-all-area" class="mt-4 hidden">
                         <button id="download-all-btn" class="w-full btn bg-gray-800 text-white hover:bg-gray-700 py-2">
                            <i class="fas fa-file-archive mr-2"></i> Baixar Todas as Faturas (ZIP)
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Template Oculto para Geração do PDF -->
    <div class="fixed -left-[10000px] top-0">
        <div id="pdf-template" class="p-12">
            <header class="flex justify-between items-center border-b pb-8 border-gray-200">
                <img src="https://hube.energy/wp-content/uploads/2024/10/Logo-1.svg" class="h-12" crossorigin="anonymous">
                <div class="text-right">
                    <h1 class="text-3xl font-bold text-gray-800">Demonstrativo de Economia</h1>
                    <p id="pdf-mes-referencia" class="text-gray-500"></p>
                </div>
            </header>
            <section class="grid grid-cols-2 gap-8 mt-8">
                <div>
                    <h2 class="text-sm font-semibold text-gray-500 uppercase">CLIENTE</h2>
                    <p id="pdf-nome-cliente" class="font-bold text-lg"></p>
                    <p id="pdf-documento" class="text-gray-600"></p>
                    <p id="pdf-endereco" class="text-gray-600 text-sm"></p>
                </div>
                <div class="text-right">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase">INSTALAÇÃO</h2>
                    <p id="pdf-instalacao" class="font-bold text-lg"></p>
                    <p id="pdf-data-emissao" class="text-gray-600 text-sm"></p>
                </div>
            </section>
            <section class="mt-10 grid grid-cols-5 gap-4 text-center">
                <div class="bg-green-50 p-4 rounded-lg"><p class="text-sm text-green-800">Economia no Mês</p><p id="pdf-economia-mes" class="text-2xl font-bold text-green-600"></p></div>
                <div class="bg-green-50 p-4 rounded-lg"><p class="text-sm text-green-800">Economia Acumulada</p><p id="pdf-economia-total" class="text-2xl font-bold text-green-600"></p></div>
                <div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-blue-800">CO² Evitado</p><p id="pdf-co2" class="text-2xl font-bold text-blue-600"></p></div>
                <div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-blue-800">Árvores Preservadas</p><p id="pdf-arvores" class="text-2xl font-bold text-blue-600"></p></div>
                <div class="bg-amber-50 p-4 rounded-lg"><p class="text-sm text-amber-800">Total a Pagar</p><p id="pdf-total-pagar" class="text-2xl font-bold text-amber-600"></p></div>
            </section>
            <section class="mt-12">
                 <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Detalhamento do Consumo</h2>
                 <div class="grid grid-cols-5 gap-6">
                    <div class="col-span-2">
                        <table class="w-full">
                            <thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Descrição</th><th class="px-4 py-2 text-right text-xs font-semibold text-gray-500 uppercase">Quantidade</th></tr></thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr><td class="px-4 py-3 font-medium">Energia Consumida da Rede</td><td id="pdf-consumo-rede" class="px-4 py-3 text-right"></td></tr>
                                <tr><td class="px-4 py-3 font-medium text-green-600">Energia Injetada (Créditos)</td><td id="pdf-energia-injetada" class="px-4 py-3 text-right font-semibold text-green-600"></td></tr>
                            </tbody>
                        </table>
                    </div><div class="col-span-3"><canvas id="consumptionChart"></canvas></div>
                 </div>
            </section>
        </div>
    </div>


<script type="text/python">
import pandas as pd
import io
import re
import unicodedata
import json

def _norm(s):
    s = str(s or "")
    s = "".join(c for c in unicodedata.normalize("NFD", s) if unicodedata.category(c) != "Mn")
    return re.sub(r"\s+", " ", s).strip().upper()

def pick_col(df, *alternativas):
    cols_norm = {_norm(c): c for c in df.columns}
    for alt in alternativas:
        key = _norm(alt)
        if key in cols_norm: return cols_norm[key]
    for k, original in cols_norm.items():
        if any(_norm(a) in k for a in alternativas): return original
    return None

def to_num(x):
    if pd.isna(x): return 0.0
    if isinstance(x, (int, float)): return float(x)
    s = str(x).replace("\u00a0", " ").strip()
    s = re.sub(r"[Rr]\$|\%", "", s).replace(" ", "")
    if s.count(",") == 1 and s.count(".") >= 1: s = s.replace(".", "").replace(",", ".")
    elif s.count(",") == 1 and s.count(".") == 0: s = s.replace(",", ".")
    try: return float(s)
    except Exception: return 0.0

def processar_relatorio_para_fatura(file_content, mes_referencia_str):
    import pandas as pd, io, json

    try:
        xls = pd.ExcelFile(io.BytesIO(file_content), engine='openpyxl')

        def find_sheet_and_header(xls, key_cols, prefer_name=None, max_rows=30):
            if prefer_name and prefer_name in xls.sheet_names:
                try:
                    df_sample = pd.read_excel(xls, sheet_name=prefer_name, header=None, nrows=max_rows)
                    for i, row in df_sample.iterrows():
                        row_as_string = ' '.join(str(v) for v in row.dropna().values)
                        if all(k in row_as_string for k in key_cols):
                            return prefer_name, i
                    return prefer_name, 7
                except:
                    pass
            for sheet_name in xls.sheet_names:
                try:
                    df_sample = pd.read_excel(xls, sheet_name=sheet_name, header=None, nrows=max_rows)
                    for i, row in df_sample.iterrows():
                        row_as_string = ' '.join(str(v) for v in row.dropna().values)
                        if all(k in row_as_string for k in key_cols):
                            return sheet_name, i
                except:
                    continue
            return None, -1

        aba_consumo, header_consumo = find_sheet_and_header(xls, ["REF"], prefer_name="Detalhe Por UC")
        if not aba_consumo or header_consumo < 0:
            return json.dumps({"error": "Aba com dados de consumo não encontrada."})

        df = pd.read_excel(xls, sheet_name=aba_consumo, header=header_consumo)
        df.columns = [str(c).strip() for c in df.columns]

        col_ref        = pick_col(df, "REF (sempre dia 01 de cada mês)", "REF")
        col_inst       = pick_col(df, "Instalação", "Nº Instalação", "Numero de Instalação", "INSTALACAO")
        col_nome       = pick_col(df, "Nome Cliente", "Nome/Razão Social", "Nome", "Razão Social")
        col_doc        = pick_col(df, "Documento", "CPF/CNPJ", "CPF", "CNPJ")
        col_consumo    = pick_col(df, "CONSUMO_FP", "CONSUMO")
        col_injetada   = pick_col(df, "CRÉD. CONSUMIDO_FP", "CREDITO CONSUMIDO_FP", "CRÉD. CONSUMIDO")
        col_ganho_mes  = pick_col(df, "Ganho Total (R$) Padrão", "Ganho total Padrão", "Ganho energia compensada (R$) Final")
        col_boleto     = pick_col(df, "Boleto Hube definido para a ref. Mensal")

        if not col_ref or not col_ganho_mes:
            return json.dumps({"error": "Colunas 'REF' ou 'Ganho do mês' não encontradas."})

        df[col_ref] = pd.to_datetime(df[col_ref], errors="coerce")
        df["_ref_month"] = df[col_ref].dt.to_period("M")
        df["_ganho_mes"] = df[col_ganho_mes].map(to_num)

        if col_inst:
            df[col_inst] = df[col_inst].astype(str)
            df_sorted = df.sort_values([col_inst, col_ref])
            df_sorted["_ganho_acum"] = df_sorted.groupby(col_inst)["_ganho_mes"].cumsum()
            df = df.merge(df_sorted[[col_inst, col_ref, "_ganho_acum"]], on=[col_inst, col_ref], how="left")
        else:
            df = df.sort_values(col_ref)
            df["_ganho_acum"] = df["_ganho_mes"].cumsum()

        mes_referencia_dt = pd.to_datetime(mes_referencia_str)
        df_mes = df[df["_ref_month"] == mes_referencia_dt.to_period("M")].copy()
        if df_mes.empty:
            return json.dumps({"error": f"Nenhum dado para o mês {mes_referencia_str}."})

        CO2_PER_KWH = 0.07
        TREES_PER_TON_CO2 = 8

        clientes = []
        for _, row in df_mes.iterrows():
            energia_injetada = to_num(row.get(col_injetada, 0))
            co2_kg = energia_injetada * CO2_PER_KWH
            
            clientes.append({
                "nome": str(row.get(col_nome, "") or "").strip(),
                "documento": str(row.get(col_doc, "") or "").strip(),
                "endereco": "",
                "instalacao": str(row.get(col_inst, "") or "").strip(),
                "economiaMes": to_num(row.get(col_ganho_mes, 0)),
                "economiaTotal": to_num(row.get("_ganho_acum", 0)),
                "consumoRede": to_num(row.get(col_consumo, 0)),
                "energiaInjetada": energia_injetada,
                "co2Evitado": co2_kg,
                "arvoresEquivalentes": (co2_kg / 1000.0) * TREES_PER_TON_CO2,
                "totalPagar": to_num(row.get(col_boleto, 0)) if col_boleto else 0,
                "email": ""
            })

        return json.dumps(clientes)

    except Exception as e:
        return json.dumps({"error": f"Erro inesperado no Python: {str(e)}"})
</script>

<script>
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingStatus = document.getElementById('loading-status');
    const fileUpload = document.getElementById('file-upload');
    const dropZone = document.getElementById('drop-zone');
    const fileSelectedEl = document.getElementById('file-selected');
    const mesReferenciaEl = document.getElementById('mes-referencia');
    const processBtn = document.getElementById('process-btn');
    const resultList = document.getElementById('result-list');
    const emptyState = document.getElementById('empty-state');
    const downloadAllArea = document.getElementById('download-all-area');
    const searchContainer = document.getElementById('search-container');
    const searchInput = document.getElementById('search-client');
    const downloadAllBtn = document.getElementById('download-all-btn');

    let pyodide;
    let pythonLoaded = false;
    let selectedFile = null;
    let clientData = [];
    let myChart;

    async function initPyodide() {
        try {
            pyodide = await loadPyodide();
            loadingStatus.textContent = 'Carregando pacotes...';
            await pyodide.loadPackage(['pandas', 'micropip']);
            loadingStatus.textContent = 'Instalando dependências...';
            await pyodide.pyimport('micropip').install('openpyxl');
            const pythonCode = document.querySelector('script[type="text/python"]').textContent;
            pyodide.runPython(pythonCode);
            pythonLoaded = true;
        } catch (e) {
             loadingStatus.textContent = 'Falha ao carregar o ambiente.';
             console.error("Erro no Pyodide:", e);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    function setActionsEnabled(enabled) {
      processBtn.disabled = !enabled;
      downloadAllBtn.disabled = !enabled;
      resultList.querySelectorAll('.generate-pdf-btn').forEach(b => b.disabled = !enabled);
      processBtn.classList.toggle('opacity-50', !enabled);
      downloadAllBtn.classList.toggle('opacity-50', !enabled);
    }

    function validateForm() {
        const isReady = selectedFile && mesReferenciaEl.value;
        processBtn.disabled = !isReady;
        processBtn.classList.toggle('opacity-50', !isReady);
        processBtn.classList.toggle('cursor-not-allowed', !isReady);
    }

    function setSelectedFile(file) {
      selectedFile = file;
      const dt = new DataTransfer();
      dt.items.add(file);
      fileUpload.files = dt.files;
      fileSelectedEl.classList.remove('hidden');
      fileSelectedEl.textContent = `${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
      validateForm();
    }
    
    dropZone.addEventListener('click', () => fileUpload.click());
    fileUpload.addEventListener('change', (e) => setSelectedFile(e.target.files[0]));
    ['dragenter','dragover'].forEach(evName => dropZone.addEventListener(evName, e => {e.preventDefault(); dropZone.classList.add('drop-active');}));
    ['dragleave','drop'].forEach(evName => dropZone.addEventListener(evName, e => {e.preventDefault(); dropZone.classList.remove('drop-active');}));
    dropZone.addEventListener('drop', e => setSelectedFile(e.dataTransfer.files[0]));
    mesReferenciaEl.addEventListener('change', validateForm);

    function formatCurrency(value) {
        return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    
    function sanitizeFilename(s) {
      return (s || "").normalize('NFD').replace(/[\u0300-\u036f]/g,'')
              .replace(/[^a-z0-9_\-]+/gi,'_')
              .replace(/^_+|_+$/g,'');
    }

    async function populateAndGeneratePdfBlob(client) {
        document.getElementById('pdf-mes-referencia').textContent = new Date(mesReferenciaEl.value + '-02').toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        document.getElementById('pdf-nome-cliente').textContent = client.nome;
        document.getElementById('pdf-documento').textContent = `CPF/CNPJ: ${client.documento}`;
        document.getElementById('pdf-endereco').textContent = client.endereco;
        document.getElementById('pdf-instalacao').textContent = client.instalacao;
        document.getElementById('pdf-data-emissao').textContent = `Emitido em: ${new Date().toLocaleDateString('pt-BR')}`;
        document.getElementById('pdf-economia-mes').textContent = formatCurrency(client.economiaMes);
        document.getElementById('pdf-economia-total').textContent = formatCurrency(client.economiaTotal);
        document.getElementById('pdf-co2').textContent = `${(client.co2Evitado || 0).toFixed(2)} kg`;
        document.getElementById('pdf-arvores').textContent = (client.arvoresEquivalentes || 0).toFixed(2);
        document.getElementById('pdf-consumo-rede').textContent = `${(client.consumoRede || 0).toFixed(2)} kWh`;
        document.getElementById('pdf-energia-injetada').textContent = `${(client.energiaInjetada || 0).toFixed(2)} kWh`;
        document.getElementById('pdf-total-pagar').textContent = typeof client.totalPagar === 'number' ? formatCurrency(client.totalPagar) : 'N/A';

        const ctx = document.getElementById('consumptionChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'bar', data: { labels: ['Energia'], datasets: [ { label: 'Consumido da Rede (kWh)', data: [Number(client.consumoRede || 0)], backgroundColor: '#FFB1C1', borderRadius: 5, }, { label: 'Injetado na Rede (kWh)', data: [Number(client.energiaInjetada || 0)], backgroundColor: '#A8E6CF', borderRadius: 5, } ] }, options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } } });
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const element = document.getElementById('pdf-template');
        const filename = `Fatura_${sanitizeFilename(client.nome)}_${mesReferenciaEl.value}.pdf`;
        const opt = { margin: 0, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas:  { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };

        const blob = await html2pdf().from(element).set(opt).output('blob');
        return { blob, filename };
    }

    function renderClientList(clientsToRender) {
        resultList.innerHTML = '';
        if (clientsToRender.length === 0) {
            resultList.innerHTML = `<p class="text-gray-500 p-4 text-center">Nenhum cliente encontrado.</p>`;
            return;
        }
        clientsToRender.forEach((client) => {
            const clientDiv = document.createElement('div');
            clientDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
            clientDiv.innerHTML = `
                <div>
                    <p class="text-sm font-medium">${client.nome}</p>
                    <p class="text-xs text-gray-500">Instalação: ${String(client.instalacao || '')}</p>
                </div>
                <button data-instalacao="${client.instalacao}" class="btn btn-primary btn-sm generate-pdf-btn">
                    <i class="fas fa-file-pdf mr-1"></i> Gerar PDF
                </button>
            `;
            resultList.appendChild(clientDiv);
        });
    }

    processBtn.addEventListener('click', async () => {
        if (!pythonLoaded || processBtn.disabled) return;
        
        setActionsEnabled(false);
        processBtn.innerHTML = '<div class="loader"></div> Processando...';

        const fileContent = await selectedFile.arrayBuffer();
        
        pyodide.globals.set('file_content_js', pyodide.toPy(new Uint8Array(fileContent)));
        pyodide.globals.set('mes_referencia_js', mesReferenciaEl.value + '-01');
        
        const resultJson = await pyodide.runPythonAsync('processar_relatorio_para_fatura(file_content_js, mes_referencia_js)');
        clientData = JSON.parse(resultJson);

        if (clientData.error) {
            resultList.innerHTML = `<p class="text-red-500 p-4">${clientData.error}</p>`;
            searchContainer.classList.add('hidden');
            downloadAllArea.classList.add('hidden');
        } else if (clientData.length > 0) {
            emptyState.style.display = 'none';
            searchContainer.classList.remove('hidden');
            downloadAllArea.classList.remove('hidden');
            renderClientList(clientData);
        } else {
             resultList.innerHTML = `<p class="text-gray-500 p-4 text-center">Nenhum cliente encontrado para o mês selecionado.</p>`;
             searchContainer.classList.add('hidden');
             downloadAllArea.classList.add('hidden');
        }
        
        processBtn.innerHTML = '<i class="fas fa-cogs mr-2"></i> Processar Relatório';
        setActionsEnabled(true);
        validateForm();
    });

    resultList.addEventListener('click', (e) => {
        const button = e.target.closest('.generate-pdf-btn');
        if (button) {
            const instalacao = button.dataset.instalacao;
            const client = clientData.find(c => String(c.instalacao) === String(instalacao));
            if (client) {
                button.innerHTML = '<div class="loader !w-4 !h-4 !border-2"></div>';
                populateAndGeneratePdfBlob(client).then(({blob, filename}) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                }).finally(() => {
                    button.innerHTML = '<i class="fas fa-file-pdf mr-1"></i> Gerar PDF';
                });
            }
        }
    });
    
    function norm(s='') {
        return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
    }

    searchInput.addEventListener('input', (e) => {
        const q = norm(e.target.value);
        const filteredClients = clientData.filter(c => 
            norm(c.nome).includes(q) || norm(String(c.instalacao)).includes(q)
        );
        renderClientList(filteredClients);
    });

    downloadAllBtn.addEventListener('click', async () => {
        setActionsEnabled(false);
        downloadAllBtn.innerHTML = '<div class="loader"></div> Gerando ZIP... (0%)';

        const zip = new JSZip();
        let count = 0;

        for (const client of clientData) {
            try {
                const {blob, filename} = await populateAndGeneratePdfBlob(client);
                zip.file(filename, blob);
                count++;
                const progress = Math.round((count / clientData.length) * 100);
                downloadAllBtn.innerHTML = `<div class="loader"></div> Gerando ZIP... (${progress}%)`;
            } catch (error) {
                console.error(`Falha ao gerar PDF para ${client.nome}:`, error);
            }
        }

        zip.generateAsync({type:"blob"}).then(function(content) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `Faturas_${mesReferenciaEl.value}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }).finally(() => {
            downloadAllBtn.innerHTML = '<i class="fas fa-file-archive mr-2"></i> Baixar Todas as Faturas (ZIP)';
            setActionsEnabled(true);
        });
    });

    document.addEventListener('DOMContentLoaded', initPyodide);
</script>
</body>
</html>

