<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta de Processamento HUBE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
      :root {
        --brand-primary: #01244A; /* EGS Blue */
        --brand-secondary: #00ED64; /* HUBE Green */
        --brand-blue: rgb(1, 36, 74); /* EGS */
        --brand-green: rgb(94, 177, 86); /* energia */
        --ink: #0B1220;
        --bg: #F7F8FA;
        --card: #FFFFFF;
        --line: #E7EBF0;
      }
      body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--ink); }
      .card {
        background: var(--card); border: 1px solid var(--line);
        border-radius: 14px; box-shadow: 0 1px 2px rgba(16,24,40,.04);
        padding: 24px; margin-bottom: 24px;
      }
      .btn {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600;
        transition: all 0.2s; cursor: pointer;
      }
      .btn-primary { background: var(--brand-primary); color: #fff; }
      .btn-primary:hover:not(:disabled) { background: #001a35; }
      .btn-secondary { background: #e2e8f0; color: #1e293b; }
      .btn-secondary:hover:not(:disabled) { background: #cbd5e1; }
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }
      .loader {
        border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--brand-secondary);
        border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;
      }
      .loader.dark { border-top-color: var(--brand-primary); }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      #drop-zone.drop-active { border-color: var(--brand-primary); background: #f0f9ff; }
      .toast {
          position: fixed; bottom: -100px; left: 50%;
          transform: translateX(-50%); padding: 1rem 1.5rem;
          background-color: var(--ink); color: white;
          border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2);
          transition: all 0.5s ease-in-out; z-index: 100;
          display: flex; align-items: center; gap: 8px;
      }
      .toast.show { bottom: 20px; }
      #pdf-page * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      #result-content.collapsed { max-height: 0; overflow: hidden; padding-top: 0; padding-bottom: 0; margin-top: 0; transition: all 0.3s ease-out; }
      #result-content { transition: all 0.3s ease-in; }
    </style>
</head>
<body class="p-4 lg:p-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50">
      <div class="loader dark"></div>
      <p id="loading-status" class="mt-4 text-gray-700 font-semibold">Inicializando ambiente...</p>
      <div class="mt-4 w-72">
        <div class="h-2 w-full bg-gray-200 rounded">
          <div id="loading-progress" class="h-2 bg-emerald-500 rounded" style="width: 0%"></div>
        </div>
        <p id="loading-tip" class="mt-2 text-xs text-gray-600 text-center"></p>
      </div>
    </div>

    <div class="w-full max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <img src="https://hube.energy/wp-content/uploads/2024/10/Logo-1.svg" alt="HUBE Energy Logo" class="mx-auto mb-4 h-16 w-auto">
            <h1 class="text-4xl font-bold text-gray-800">Ferramenta de Processamento</h1>
            <p class="text-gray-600 mt-2">Carregue um arquivo, defina os parâmetros e escolha a ação desejada.</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-5 gap-6">
            <!-- Coluna de Inputs (Esquerda) -->
            <div class="md:col-span-2">
                <div class="card">
                    <h2 class="text-xl font-semibold">1. Entradas</h2>
                    <input id="file-upload" type="file" class="hidden" accept=".xlsx,.xlsm,.xls,.csv">
                    <div id="drop-zone" role="button" tabindex="0" class="mt-4 rounded-lg border-2 border-dashed border-gray-300 p-6 text-center text-gray-500 cursor-pointer" aria-label="Área para carregar arquivo. Clique ou arraste um arquivo para cá.">
                        <i class="fas fa-cloud-arrow-up text-3xl"></i>
                        <p class="font-semibold mt-2">Arraste e solte ou clique</p>
                    </div>
                    <p id="file-selected" class="mt-3 text-sm font-semibold text-green-700 hidden"></p>
                    <div id="file-error" class="text-red-600 text-sm mt-2 hidden"></div>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-semibold">2. Parâmetros</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="mes-referencia" class="block text-sm font-medium text-gray-700 mb-1">Mês de Referência <span class="text-red-500">*</span></label>
                            <input type="month" id="mes-referencia" class="w-full rounded-lg border border-gray-300 p-2.5" required>
                            <p id="mes-referencia-error" class="text-red-500 text-xs mt-1 hidden">Campo obrigatório</p>
                        </div>
                        <div>
                            <label for="data-vencimento" class="block text-sm font-medium text-gray-700 mb-1">Data de Vencimento <span class="text-red-500">*</span></label>
                            <input type="date" id="data-vencimento" class="w-full rounded-lg border border-gray-300 p-2.5" required>
                            <p id="data-vencimento-error" class="text-red-500 text-xs mt-1 hidden">Campo obrigatório</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold">3. Ações</h2>
                    <div class="space-y-4 mt-4">
                        <button id="process-faturas-btn" class="w-full btn btn-primary text-lg py-3" disabled title="Carregue um arquivo e preencha as datas para habilitar">
                            <i class="fas fa-file-invoice-dollar mr-2"></i> Gerar Faturas
                        </button>
                        <button id="process-planilha-btn" class="w-full btn btn-secondary text-lg py-3" disabled title="Carregue um arquivo e preencha as datas para habilitar">
                            <i class="fas fa-file-excel mr-2"></i> Processar Planilha
                        </button>
                        <button id="reset-btn" class="w-full btn btn-secondary text-sm py-2 mt-2 hidden">
                            <i class="fas fa-redo mr-2"></i> Resetar e Processar Novamente
                        </button>
                    </div>
                </div>
            </div>

            <!-- Coluna de Resultados (Direita) -->
            <div class="md:col-span-3 card" id="result-card">
                 <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-semibold">Resultado</h2>
                    <button id="toggle-result" class="text-sm text-gray-500 hover:text-gray-700" title="Recolher/Expandir">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                
                <div id="result-content">
                    <!-- Container para Gerador de Faturas -->
                    <div id="output-gerador" class="hidden">
                        <div id="search-container" class="relative mt-4 hidden">
                            <input type="text" id="search-client" placeholder="Procurar cliente..." class="w-full rounded-lg border border-gray-300 p-2 pl-10">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                        </div>
                        <div id="result-list" class="mt-4 space-y-2 max-h-[40vh] overflow-y-auto border-t border-b border-gray-200 py-2"></div>
                        <div id="download-all-area" class="mt-4 hidden">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <button id="download-all-zip-btn" class="w-full btn btn-secondary py-2">
                                    <i class="fas fa-file-archive mr-2"></i> Baixar Todas (ZIP)
                                </button>
                                <button id="download-all-individual-btn" class="w-full btn text-black py-2" style="background: var(--brand-secondary);">
                                    <i class="fas fa-folder-download mr-2"></i> Baixar Todas (Pasta)
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Container para Processador de Planilha -->
                    <div id="output-processador" class="hidden">
                        <div id="res-log" class="hidden mt-4 p-4 bg-gray-50 rounded-lg text-sm font-mono whitespace-pre-wrap h-64 overflow-y-auto"></div>
                        <div id="res-error" class="hidden mt-4 bg-red-50 border border-red-200 text-red-700 rounded-lg p-3 text-sm"></div>
                        <div id="download-area" class="mt-4 text-center hidden">
                             <a id="download-link" class="btn btn-primary text-base px-6 py-3">
                                <i class="fas fa-download mr-2"></i> Baixar Resultado
                            </a>
                         </div>
                    </div>
                    
                    <!-- Estado Vazio Comum -->
                    <div id="empty-state" class="text-center text-gray-500 py-10">
                        <i class="fas fa-cogs text-3xl mb-2 text-gray-300"></i>
                        <p class="font-semibold">Aguardando processamento</p>
                        <p class="text-sm">Carregue um arquivo e preencha as datas.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Template Oculto para Geração do PDF (do Gerador de Faturas) -->
    <div class="fixed -left-[9999px] top-0 opacity-0" id="pdf-template-container">
        <div id="pdf-page" style="width:210mm; min-height:296.8mm; background:#fff; color:#0B1220; padding:16mm 14mm; display:grid; grid-template-rows: auto auto auto auto auto auto; row-gap: 5mm; font-family:'Helvetica', Arial, sans-serif; font-size:10.5px; line-height:1.25; box-sizing:border-box; overflow:hidden;">
            <header class="flex justify-between items-start" style="margin-bottom:0;">
              <div style="display:flex; flex-direction:column; gap:4mm; max-width:120mm;">
                <div style="font-weight:700; font-size:34px; letter-spacing:0.5px; text-align:left;">
                  <span style="color: var(--brand-blue);">EGS</span>
                  <span style="color: var(--brand-green);"> energia</span>
                </div>
                <div id="pdf-titulo-p1" style="font-weight:600; font-size:13px; text-align:left;">Sua contribuição de [Mês] chegou</div>
              </div>
              <div class="text-right" style="font-size:10px; max-width:72mm;">
                <p id="pdf-nome-cliente-p1" class="font-bold" style="font-size:12px;">[Nome Cliente]</p>
                <p id="pdf-cpf-p1" class="text-gray-600">[CPF/CNPJ]</p>
                <p id="pdf-endereco-p1" class="text-gray-600">[Endereço]</p>
                <p class="mt-1">Código Instalação: <span id="pdf-instalacao-p1" class="font-bold">[Instalação]</span></p>
                <p>Emissão: <span id="pdf-emissao-p1" class="font-bold">[Emissão]</span></p>
              </div>
            </header>
            <section style="display:grid; grid-template-columns: 1.2fr 1fr; gap:6mm; align-items:stretch;">
              <div class="p-6 rounded-xl" style="background:var(--brand-primary); color:#fff;">
                <p style="font-size:12px;">Total a pagar</p>
                <p id="pdf-total-pagar" class="font-bold" style="font-size:40px; margin:6px 0 8px;">R$ 0,00</p>
                <p style="font-size:10px;">Data de vencimento</p>
                <p id="pdf-vencimento-p1" style="font-size:12px; font-weight:600;">[Data]</p>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5mm;">
                <div class="p-3 rounded-lg" style="background:var(--brand-primary); color:#fff;">
                  <p id="pdf-economia-mes" class="font-bold" style="font-size:16px;">R$ 0,00</p>
                  <p style="opacity:.9;">Economia Mês</p>
                </div>
                <div class="p-3 rounded-lg" style="background:var(--brand-primary); color:#fff;">
                  <p id="pdf-economia-acumulada" class="font-bold" style="font-size:16px;">R$ 0,00</p>
                  <p style="opacity:.9;">Economia acumulada</p>
                </div>
                <div class="p-3 rounded-lg" style="background:var(--brand-primary); color:#fff;">
                  <p id="pdf-arvores" class="font-bold" style="font-size:16px;">0,00</p>
                  <p style="opacity:.9;">Árvores preservadas</p>
                </div>
                <div class="p-3 rounded-lg" style="background:var(--brand-primary); color:#fff;">
                  <p id="pdf-co2" class="font-bold" style="font-size:16px;"></p>
                  <p style="opacity:.9;">CO2 poupados</p>
                </div>
              </div>
            </section>
            <section id="pdf-resumo-economia" style="margin:0;">
              <div class="rounded-lg" style="background:#F3F4F6; padding:8px 10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700; font-size:12px;">Resumo da sua economia</div>
                  <div style="text-align:right;">
                    <div id="pdf-econ-mes-valor" style="font-size:18px; font-weight:800; color:var(--brand-green);">R$ 0,00</div>
                    <div style="font-size:10px; color:#374151; margin-top:2px;">
                      Sem GD: <span id="pdf-econ-sem-gd">R$ 0,00</span> &nbsp; • &nbsp;
                      Com GD: <span id="pdf-econ-com-gd">R$ 0,00</span>
                    </div>
                  </div>
                </div>
              </div>
            </section>
            <section style="display:grid; grid-template-columns: 1fr 1fr; gap:6mm; font-size:10px;">
              <div>
                <h2 class="font-bold" style="font-size:11px; margin-bottom:2mm;">Como calculamos sua contribuição</h2>
                <table class="w-full" style="width:100%; border-collapse:collapse;">
                  <colgroup><col style="width:44%"><col style="width:16%"><col style="width:20%"><col style="width:20%"></colgroup>
                  <thead><tr style="border-bottom:1px solid #D1D5DB;"><th class="text-left" style="padding:6px 4px;">Descrição</th><th class="text-right" style="padding:6px 4px;">Quantidade</th><th class="text-right" style="padding:6px 4px;">Tarifa de referência</th><th class="text-right" style="padding:6px 4px;">Total</th></tr></thead>
                  <tbody>
                    <tr style="border-bottom:1px solid #E5E7EB;"><td id="pdf-det-credito-label" style="padding:5px 4px;">Crédito de Energia</td><td id="pdf-det-credito-qtd" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td id="pdf-det-credito-tar" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td id="pdf-det-credito-total" class="text-right" style="padding:5px 4px; font-weight:600; white-space:nowrap;"></td></tr>
                    <tr style="border-bottom:1px solid #E5E7EB;"><td style="padding:5px 4px;">Desconto extra</td><td class="text-right" style="padding:5px 4px; white-space:nowrap;">0,00</td><td class="text-right" style="padding:5px 4px; white-space:nowrap;">R$ 0,00</td><td class="text-right" style="padding:5px 4px; font-weight:600; white-space:nowrap;">R$ 0,00</td></tr>
                    <tr style="border-bottom:1px solid #E5E7EB;"><td style="padding:5px 4px;">Ajuste retroativo</td><td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td class="text-right" style="padding:5px 4px; font-weight:600; white-space:nowrap;">R$ 0,00</td></tr>
                    <tr style="background:#F3F4F6;"><td style="padding:5px 4px; font-weight:700;">Total da sua contribuição</td><td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td id="pdf-det-total-contrib" class="text-right" style="padding:5px 4px; font-weight:700; white-space:nowrap;"></td></tr>
                  </tbody>
                </table>
              </div>
              <div>
                <h2 class="font-bold" style="font-size:11px; margin-bottom:2mm;">Como ficou sua conta da distribuidora</h2>
                <table class="w-full" style="width:100%; border-collapse:collapse;">
                  <colgroup><col style="width:44%"><col style="width:16%"><col style="width:20%"><col style="width:20%"></colgroup>
                  <thead><tr style="border-bottom:1px solid #D1D5DB;"><th class="text-left" style="padding:6px 4px; font-weight:600;">Descrição</th><th class="text-right" style="padding:6px 4px; font-weight:600;">Quantidade</th><th class="text-right" style="padding:6px 4px; font-weight:600;">Tarifa</th><th class="text-right" style="padding:6px 4px; font-weight:600;">Total</th></tr></thead>
                  <tbody>
                    <tr style="border-bottom:1px solid #E5E7EB;"><td style="padding:5px 4px;">Energia Consumida</td><td id="pdf-dist-consumo-qtd" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td id="pdf-dist-consumo-tar" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td id="pdf-dist-consumo-total" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td></tr>
                    <tr style="border-bottom:1px solid #E5E7EB;"><td style="padding:5px 4px;">Energia Compensada</td><td id="pdf-dist-comp-qtd" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td id="pdf-dist-comp-tar" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td id="pdf-dist-comp-total" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td></tr>
                    <tr style="border-bottom:1px solid #E5E7EB;"><td style="padding:5px 4px;">Contrib. Ilum. Pública e Outros</td><td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td id="pdf-dist-outros" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td></tr>
                    <tr style="background:#F3F4F6;"><td style="padding:5px 4px; font-weight:700;">Total a pagar na sua fatura da distribuidora</td><td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td><td id="pdf-dist-total" class="text-right" style="padding:5px 4px; font-weight:700; white-space:nowrap;"></td></tr>
                  </tbody>
                </table>
              </div>
            </section>
            <section style="margin:0;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6mm;">
                <div class="rounded-lg" style="background:#F3F4F6; padding:10px; display:flex; justify-content:space-between; align-items:baseline;">
                  <div class="font-bold">Se fosse só distribuidora</div>
                  <div class="text-right">
                    <span id="pdf-econ-total-sem" class="font-bold" style="font-size:12px;">R$ 0,00</span><br>
                    <span class="text-gray-600">(Tarifa <span id="pdf-econ-tarifa-dist"></span> x Qtd. <span id="pdf-econ-qtd-dist"></span>) + Outros <span id="pdf-econ-outros"></span></span>
                  </div>
                </div>
                <div class="rounded-lg" style="background:#F3F4F6; padding:10px; display:flex; justify-content:space-between; align-items:baseline;">
                  <div class="font-bold">Com EGS</div>
                  <div class="text-right">
                    <span id="pdf-econ-total-com" class="font-bold" style="font-size:12px;">R$ 0,00</span><br>
                    <span id="pdf-econ-exp-ev" class="text-gray-600"></span>
                  </div>
                </div>
              </div>
            </section>
            <footer style="margin-top:0; font-size:14px; color:#6B7280; text-align:center;">
              <div id="pdf-footer-warning" class="rounded-lg font-bold" style="display:inline-block; background: var(--brand-green); color: #000; margin-bottom: 6px; padding: 10px 16px;">Atenção! Você ainda precisa pagar a conta da distribuidora.</div>
              <div style="display:grid; grid-template-columns: 1fr; gap:4mm;">
                <div>
                  <table style="width:100%; border-collapse:collapse;">
                    <thead><tr style="border-bottom:1px solid #D1D5DB;"><th class="text-center" style="padding:6px 4px; font-weight:600;">Referência</th><th class="text-center" style="padding:6px 4px; font-weight:600;">Valor</th><th class="text-center" style="padding:6px 4px; font-weight:600;">Vencimento</th></tr></thead>
                    <tbody><tr><td id="pdf-ref-foot" style="padding:5px 4px;">[Ref]</td><td id="pdf-valor-foot" style="padding:5px 4px;">[Valor]</td><td id="pdf-venc-foot" style="padding:5px 4px;">[Venc]</td></tr></tbody>
                  </table>
                </div>
              </div>
              <div style="margin-top:4mm;">
                <div class="rounded-lg" style="background:#F3F4F6; padding:8px 10px; display:flex; align-items:center; gap:14px; flex-wrap:wrap; justify-content:center;">
                  <div style="display:flex; align-items:center; gap:6px; font-size:10.5px; color:#0B1220;"><i class="fa-solid fa-envelope" aria-hidden="true" style="font-size:12px; color: var(--brand-primary);"></i><span><strong>E-mail:</strong> atendimento@egsenergia.com.br</span></div>
                  <div style="width:1px; height:14px; background:#D1D5DB;"></div>
                  <div style="display:flex; align-items:center; gap:6px; font-size:10.5px; color:#0B1220;"><i class="fa-brands fa-whatsapp" aria-hidden="true" style="font-size:12px; color:var(--brand-green);"></i><span><strong>WhatsApp:</strong> (11) 99670-3826</span></div>
                </div>
              </div>
            </footer>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>


<!-- UNIFIED PYTHON SCRIPT -->
<script type="text/python">
import pandas as pd
import io, re, json, unicodedata
from datetime import datetime

# ============================================
# SEÇÃO DE UTILITÁRIOS COMUNS
# ============================================

def _norm(s: str) -> str:
    s = str(s or "")
    s = "".join(c for c in unicodedata.normalize("NFD", s) if unicodedata.category(c) != "Mn")
    return re.sub(r"\s+", " ", s).strip().upper()

def to_num(x) -> float:
    if pd.isna(x): return 0.0
    if isinstance(x, (int, float)): return float(x)
    s = str(x).replace("\u00a0", " ").strip()
    neg = False
    if s.startswith('(') and s.endswith(')'):
        neg = True
        s = s[1:-1]
    s = re.sub(r"[Rr]\$|\%", "", s).replace(" ", "")
    s = s.replace('—', '0').replace('--', '0').replace('-', '-').strip()
    if s in {"", "--", "---"}: return 0.0
    s = s.replace("+", "")
    if s.count(",") == 1 and s.count(".") >= 1: s = s.replace(".", "").replace(",", ".")
    elif s.count(",") == 1 and s.count(".") == 0: s = s.replace(",", ".")
    try: v = float(s)
    except Exception: v = 0.0
    return -v if neg else v

def pick_col(df: pd.DataFrame, *alternativas) -> str:
    cols_norm = {_norm(c): c for c in df.columns}
    for alt in alternativas:
        key = _norm(alt)
        if key in cols_norm: return cols_norm[key]
    for k, original in cols_norm.items():
        if any(_norm(a) in k for a in alternativas): return original
    # FIX: Return None instead of raising an error if column is not found
    return None

def find_sheet_and_header(xls: pd.ExcelFile, key_cols, prefer_name=None, max_rows=30):
    sheet_names = list(xls.sheet_names)
    if prefer_name and prefer_name in sheet_names:
        sheet_names.insert(0, sheet_names.pop(sheet_names.index(prefer_name)))
    for sheet_name in sheet_names:
        try:
            df_sample = pd.read_excel(xls, sheet_name=sheet_name, header=None, nrows=max_rows)
            for i, row in df_sample.iterrows():
                row_as_string = " ".join(str(v) for v in row.dropna().values)
                if all(k in row_as_string for k in key_cols):
                    return sheet_name, i
        except Exception:
            continue
    return None, -1

def safe_parse_date_column(series):
    def parse_single(val):
        if pd.isna(val): return pd.NaT
        if isinstance(val, (int, float)):
            try: return pd.to_datetime('1899-12-30') + pd.to_timedelta(val, 'D')
            except: return pd.NaT
        try: return pd.to_datetime(str(val)[:10], errors='coerce')
        except: return pd.NaT
    return series.apply(parse_single)

# ============================================
# LÓGICA DO PROCESSADOR DE PLANILHAS
# ============================================
def processar_planilha_py(file_content, mes_referencia_str, vencimento_str):
    log = []
    try:
        log.append("Iniciando processador de planilhas...")
        xls = pd.ExcelFile(io.BytesIO(file_content), engine='openpyxl')
        
        aba, header_row = find_sheet_and_header(xls, ("REF",), prefer_name="Detalhe Por UC")
        if not aba:
            log.append("ERRO: Nenhuma aba válida encontrada."); return None, "\n".join(log)
        log.append(f"Aba selecionada: '{aba}', cabeçalho na linha {header_row + 1}.")
        
        df_origem = pd.read_excel(xls, sheet_name=aba, header=header_row)
        df_origem.columns = [str(c).strip() for c in df_origem.columns]
        log.append(f"Linhas no bruto: {len(df_origem)}")
        
        col_ref = pick_col(df_origem, "REF (sempre dia 01 de cada mês)", "REF", "REFERENCIA")
        if not col_ref: raise KeyError("Coluna de Referência (REF) não encontrada.")
        df_origem[col_ref] = pd.to_datetime(df_origem[col_ref], errors="coerce")
        mes_referencia_dt = pd.to_datetime(mes_referencia_str)
        df = df_origem[df_origem[col_ref].dt.to_period('M') == mes_referencia_dt.to_period('M')].copy()

        if df.empty:
            meses_disp = sorted(df_origem[col_ref].dropna().dt.strftime('%Y-%m').unique())
            log.append(f"AVISO: Nenhum dado para '{mes_referencia_dt.strftime('%Y-%m')}'. Meses disponíveis: {meses_disp}"); return None, "\n".join(log)
        log.append(f"Linhas no mês de referência: {len(df)}")
        
        col_valor_emissao_opts = ('Valor enviado para emissão', 'Valor enviado p/ emissão', 'Valor Enviado para Emissao')
        col_valor = pick_col(df, *col_valor_emissao_opts)
        if not col_valor: raise KeyError("Coluna de Valor para Emissão não encontrada.")
        df['_valor_numerico'] = df[col_valor].apply(to_num)
        
        # Registrando o total de linhas antes do filtro
        total_linhas_antes = len(df)
        log.append(f"Total de linhas antes do filtro: {total_linhas_antes}")
        
        # Aplicando o filtro de valor mínimo (apenas cobrar valores >= R$5,00)
        df = df[df['_valor_numerico'] >= 5].copy()
        log.append(f"Linhas após filtro de valor >= R$5.00: {len(df)}")
        
        if df.empty:
            log.append("AVISO: Nenhuma linha restou após o filtro."); return None, "\n".join(log)
            
        dfp = pd.DataFrame(index=df.index)
        colunas_finais = ['instalacao','distribuidora','mesReferencia','valorTotal','vencimento','creditoAcumulado','creditoConsumidoQuantidade','creditoConsumidoTarifa','creditoConsumidoValor','energiaConsumidaQuantidade','energiaConsumidaTarifa','energiaConsumidaValor','tarifaCobradaGera','outrosCustosFatura','ajusteRetroativo','descontoExtra','economiaAcumulada','economiaReais','valorCobradoDistribuidora','custoTotalComGd','custoTotalSemGd','motivo','observacao','tipoCalculo']
        
        def col_to_numeric_local(df_in, col_options):
            col_name = pick_col(df_in, *col_options)
            if col_name: return df_in[col_name].apply(to_num)
            return 0.0
        
        fatura_c_gd = col_to_numeric_local(df, ('FATURA C/GD COM RESTITUIÇÃO','FATURA C/GD COM RESTITUICAO'))
        valor_enviado = df['_valor_numerico']
        custo_s_gd = col_to_numeric_local(df, ('CUSTO_S_GD',))

        dfp['instalacao'] = df[pick_col(df, 'Instalação','Nº Instalação','Instalacao')]
        dfp['distribuidora'] = 'energisa_ms'
        dfp['mesReferencia'] = mes_referencia_dt.strftime('%Y-%m')
        dfp['valorTotal'] = valor_enviado
        dfp['vencimento'] = pd.to_datetime(vencimento_str).strftime('%d/%m/%Y')
        dfp['creditoAcumulado'] = col_to_numeric_local(df, ('CREDITO ACUMULADO_FP','CRÉDITO ACUMULADO_FP')) + col_to_numeric_local(df, ('CREDITO ACUMULADO_P','CRÉDITO ACUMULADO_P'))
        dfp['creditoConsumidoQuantidade'] = col_to_numeric_local(df, ('CRÉD. CONSUMIDO_FP','CRED. CONSUMIDO_FP'))
        dfp['creditoConsumidoTarifa'] = col_to_numeric_local(df, ('TARIFA_Comp_FP','TARIFA COMP FP'))
        dfp['energiaConsumidaQuantidade'] = col_to_numeric_local(df, ('CONSUMO_FP',))
        dfp['energiaConsumidaTarifa'] = col_to_numeric_local(df, ('TARIFA FP','Tarifa FP'))
        dfp['tarifaCobradaGera'] = col_to_numeric_local(df, ('Tarifa Média Projeto','Tarifa Media Projeto'))
        dfp['outrosCustosFatura'] = col_to_numeric_local(df, ('OUTROS','Outros'))
        dfp['economiaAcumulada'] = col_to_numeric_local(df, ('Ganho Total (R$) Padrão','Ganho Total (R$) Padrao'))
        dfp['valorCobradoDistribuidora'] = fatura_c_gd
        dfp['custoTotalSemGd'] = custo_s_gd
        dfp['custoTotalComGd'] = (fatura_c_gd + valor_enviado).round(2)
        dfp['economiaReais'] = (custo_s_gd - dfp['custoTotalComGd']).round(2)
        dfp['creditoConsumidoValor'] = (dfp['creditoConsumidoQuantidade'] * dfp['creditoConsumidoTarifa']).round(2)
        dfp['energiaConsumidaValor'] = (dfp['energiaConsumidaQuantidade'] * dfp['energiaConsumidaTarifa']).round(2)
        
        for col in ['ajusteRetroativo', 'descontoExtra', 'motivo', 'observacao', 'tipoCalculo']:
            if col not in dfp.columns: dfp[col] = 0.0 if 'valor' in col.lower() else ""

        dfp = dfp.reindex(columns=colunas_finais).fillna(0)
        log.append("Transformação concluída.")
        
        output_buffer = io.BytesIO()
        dfp.to_excel(output_buffer, index=False)
        output_buffer.seek(0)
        log.append(f"Linhas exportadas: {len(dfp)}. Sucesso!")
        return output_buffer.getvalue(), "\n".join(log)

    except KeyError as e:
        log.append(f"\nERRO DE MAPEAMENTO: {e}")
        return None, "\n".join(log)
    except Exception as e:
        import traceback
        log.append(f"\nERRO INESPERADO: {traceback.format_exc()}")
        return None, "\n".join(log)

# ============================================
# LÓGICA DO GERADOR DE FATURAS
# ============================================
CO2_PER_KWH = 0.07
TREES_PER_TON_CO2 = 8
FALLBACK_TARIFA_DIST = 0.916370
FALLBACK_TARIFA_COMP_EV = 0.716045

def month_period(dt: datetime):
    return pd.to_datetime(dt).to_period("M") if pd.notna(dt) else None

def compute_row_metrics(row, cols, vencimento_iso: str):
    consumo_qtd    = to_num(row.get(cols.get('consumo_qtd'), 0))
    comp_qtd       = to_num(row.get(cols.get('comp_qtd'), 0))
    tarifa_cons_raw = to_num(row.get(cols.get('tarifa_consumo'), None)) if cols.get('tarifa_consumo') else 0.0
    used_fallback_tar_cons = tarifa_cons_raw <= 0
    tarifa_cons = tarifa_cons_raw if tarifa_cons_raw > 0 else FALLBACK_TARIFA_DIST
    tarifa_comp_ev = to_num(row.get(cols.get('tarifa_comp_ev'), 0))
    tarifa_comp_dist_raw = to_num(row.get(cols.get('tarifa_comp_dist'), None)) if cols.get('tarifa_comp_dist') else 0.0
    tarifa_comp_dist = tarifa_comp_dist_raw if tarifa_comp_dist_raw > 0 else (tarifa_comp_ev or FALLBACK_TARIFA_COMP_EV)
    consumo_total_val   = consumo_qtd * tarifa_cons
    comp_total_val_dist = comp_qtd * tarifa_comp_dist
    fatura_dist_real = to_num(row.get(cols.get('fatura_c_gd'), 0))
    dist_outros_val = max(0.0, round(fatura_dist_real - (consumo_total_val - comp_total_val_dist), 2))
    dist_total = fatura_dist_real
    boleto_ev = to_num(row.get(cols.get('boleto_ev'), 0))
    if boleto_ev > 0:
        contrib_total = boleto_ev
        det_credito_tar = 0.0
        det_credito_total = contrib_total
    else:
        det_credito_tar = tarifa_comp_ev or FALLBACK_TARIFA_COMP_EV
        det_credito_total = comp_qtd * det_credito_tar
        contrib_total = det_credito_total
    econ_total_sem = consumo_total_val + dist_outros_val
    econ_total_com = dist_total + contrib_total
    co2_kg = comp_qtd * CO2_PER_KWH
    tarifa_efetiva = (contrib_total / comp_qtd) if comp_qtd > 0 else 0.0
    calc_dist_total = consumo_total_val - comp_total_val_dist + dist_outros_val
    diff = abs(calc_dist_total - dist_total)
    
    def r(x, d): return round(float(x or 0), d)
    return {
        "dist_consumo_qtd": r(consumo_qtd, 2), "dist_consumo_tar": r(tarifa_cons, 4), "dist_consumo_total": r(consumo_total_val, 2),
        "dist_comp_qtd": r(comp_qtd, 2), "dist_comp_tar": r(tarifa_comp_dist, 4), "dist_comp_total": r(-comp_total_val_dist, 2),
        "dist_outros": r(dist_outros_val, 2), "dist_total": r(dist_total, 2), "det_credito_qtd": r(comp_qtd, 2),
        "det_credito_tar": r(det_credito_tar, 4), "det_credito_total": r(det_credito_total, 2), "totalPagar": r(contrib_total, 2),
        "econ_total_sem": r(econ_total_sem, 2), "econ_total_com": r(econ_total_com, 2), "co2Evitado": r(co2_kg, 2),
        "arvoresEquivalentes": r((co2_kg / 1000.0) * TREES_PER_TON_CO2, 2), "vencimento_iso": vencimento_iso,
        "emissao_iso": datetime.now().strftime('%Y-%m-%d'), "det_credito_tar_efetiva": r(tarifa_efetiva, 4),
        "used_fallback_tar_cons": used_fallback_tar_cons, "_divergencia_calculo": r(diff, 2)
    }

def accumulate_economy(df_calc, cols_map):
    comp_qtd_series = df_calc[cols_map.get('comp_qtd')].apply(to_num) if cols_map.get('comp_qtd') and cols_map.get('comp_qtd') in df_calc.columns else pd.Series([0.0]*len(df_calc))
    tarifa_comp_ev_series = df_calc[cols_map.get('tarifa_comp_ev')].apply(to_num) if cols_map.get('tarifa_comp_ev') and cols_map.get('tarifa_comp_ev') in df_calc.columns else pd.Series([FALLBACK_TARIFA_COMP_EV]*len(df_calc))
    valor_boleto_series = df_calc[cols_map.get('boleto_ev')].apply(to_num) if cols_map.get('boleto_ev') and cols_map.get('boleto_ev') in df_calc.columns else pd.Series([0.0]*len(df_calc))
    custo_s_gd_series = df_calc[cols_map.get('custo_s_gd')].apply(to_num) if cols_map.get('custo_s_gd') and cols_map.get('custo_s_gd') in df_calc.columns else pd.Series([0.0]*len(df_calc))
    fatura_c_gd_series = df_calc[cols_map.get('fatura_c_gd')].apply(to_num) if cols_map.get('fatura_c_gd') and cols_map.get('fatura_c_gd') in df_calc.columns else pd.Series([0.0]*len(df_calc))

    valor_final_series = valor_boleto_series.where(valor_boleto_series > 0, (comp_qtd_series * tarifa_comp_ev_series))
    df_calc['_econ_mes_raw'] = (custo_s_gd_series - (fatura_c_gd_series + valor_final_series)).round(2)
    df_calc['_econ_mes'] = df_calc['_econ_mes_raw'].clip(lower=0)
    col_inst, col_ref = cols_map.get('inst'), cols_map.get('ref')
    if col_inst and col_ref and col_inst in df_calc.columns and col_ref in df_calc.columns:
        df_calc[col_ref] = safe_parse_date_column(df_calc[col_ref])
        df_calc.sort_values(by=[col_inst, col_ref], inplace=True)
        df_calc['_econ_acum'] = df_calc.groupby(col_inst)['_econ_mes'].cumsum().fillna(0)
    else:
        df_calc['_econ_acum'] = df_calc['_econ_mes']
    return df_calc

def processar_relatorio_para_fatura(file_content, mes_referencia_str, vencimento_str):
    try:
        xls = pd.ExcelFile(io.BytesIO(file_content), engine='openpyxl')
        aba_consumo, header_consumo = find_sheet_and_header(xls, ["REF", "Instalação", "CRÉD. CONSUMIDO_FP"], prefer_name="Detalhe Por UC")
        if not aba_consumo: return json.dumps({"error": "Aba com dados de consumo não encontrada."})

        df = pd.read_excel(xls, sheet_name=aba_consumo, header=header_consumo)
        df.columns = [str(c).strip() for c in df.columns]
        
        def col(*alts): return pick_col(df, *alts)
        cols_map = {'ref': col("REF (sempre dia 01 de cada mês)", "REF"), 'inst': col("Instalação", "Nº Instalação"), 'nome': col("Nome Cliente", "Nome/Razão Social"), 'doc': col("Documento", "CPF/CNPJ"), 'consumo_qtd': col("CONSUMO_FP"), 'comp_qtd': col("CRÉD. CONSUMIDO_FP"), 'tarifa_consumo': col("TARIFA FP"), 'tarifa_comp_ev': col("TARIFA_Comp_FP"), 'tarifa_comp_dist': col("TARIFA DE ENERGIA COMPENSADA"), 'outros': col("OUTROS"), 'boleto_ev': col("Boleto Hube definido para a ref. Mensal", "Valor enviado para emissão"), 'num_conta': col("Número da conta"), 'endereco': col("Endereço"), 'bairro': col("Bairro"), 'cidade': col("Cidade"), 'custo_s_gd': col("CUSTO_S_GD"), 'fatura_c_gd': col("FATURA C/GD COM RESTITUIÇÃO", "FATURA C/GD COM RESTITUICAO")}
        if not cols_map['ref']: return json.dumps({"error": "Coluna de referência (REF) não encontrada."})

        df_calc = accumulate_economy(df.copy(), cols_map)
        mes_dt = safe_parse_date_column(pd.Series([mes_referencia_str]))[0]
        df_calc[cols_map.get('ref')] = safe_parse_date_column(df_calc[cols_map.get('ref')])
        df_mes = df_calc[df_calc[cols_map.get('ref')].dt.to_period("M") == month_period(mes_dt)].copy()
        if df_mes.empty: return json.dumps({"error": f"Nenhum dado para o mês {mes_referencia_str}."})

        # =================================================================
        # CORREÇÃO FINAL: Filtro para cobranças acima de R$5,00
        # Garante que a lógica de filtro seja IDÊNTICA à da função `processar_planilha_py`
        col_valor_opts = ('Valor enviado para emissão', 'Valor enviado p/ emissão', 'Valor Enviado para Emissao')
        col_valor_emissao = pick_col(df_mes, *col_valor_opts)

        if not col_valor_emissao or col_valor_emissao not in df_mes.columns:
            return json.dumps({"error": "Coluna 'Valor enviado para emissão' não foi encontrada para filtrar as faturas."})

        df_mes['_valor_para_filtrar'] = df_mes[col_valor_emissao].apply(to_num)
        df_mes = df_mes[df_mes['_valor_para_filtrar'] >= 5].copy()
        # =================================================================

        if df_mes.empty: return json.dumps({"error": f"Nenhum dado com valor superior a R$5,00 para o mês {mes_referencia_str}."})

        venc_iso = safe_parse_date_column(pd.Series([vencimento_str]))[0].strftime('%Y-%m-%d')
        clientes = []
        for _, row in df_mes.iterrows():
            metrics = compute_row_metrics(row, cols_map, venc_iso)
            endereco_parts = []
            col_endereco = cols_map.get('endereco')
            if col_endereco and pd.notna(row.get(col_endereco)): endereco_parts.append(str(row.get(col_endereco)))
            col_bairro = cols_map.get('bairro')
            if col_bairro and pd.notna(row.get(col_bairro)): endereco_parts.append(str(row.get(col_bairro)))
            col_cidade = cols_map.get('cidade')
            if col_cidade and pd.notna(row.get(col_cidade)): endereco_parts.append(str(row.get(col_cidade)))
            endereco = ' '.join(endereco_parts).strip()

            cliente_data = {
                "nome": str(row.get(cols_map.get('nome'), "")), "documento": str(row.get(cols_map.get('doc'), "")),
                "endereco": endereco, "instalacao": str(row.get(cols_map.get('inst'), "")),
                "economiaMes": row.get('_econ_mes', 0), "economiaTotal": row.get('_econ_acum', 0),
                "_econ_mes_raw": row.get('_econ_mes_raw', 0),
                "custo_s_gd": to_num(row.get(cols_map.get('custo_s_gd'), 0)),
                "fatura_c_gd": to_num(row.get(cols_map.get('fatura_c_gd'), 0)),
            }
            cliente_data.update(metrics)
            clientes.append(cliente_data)
        return json.dumps(clientes)
    except Exception as e:
        import traceback
        return json.dumps({"error": f"Erro inesperado no Python: {traceback.format_exc()}"})
</script>

<!-- UNIFIED JAVASCRIPT -->
<script>
// ===================================
// STATE & DOM ELEMENTS
// ===================================
let pyodide;
let pythonLoaded = false;
let selectedFile = null;
let clientData = [];
let lastUrl = null;

const DOM = {
    loadingOverlay: document.getElementById('loading-overlay'), loadingStatus: document.getElementById('loading-status'),
    loadingProgress: document.getElementById('loading-progress'), loadingTip: document.getElementById('loading-tip'),
    fileUpload: document.getElementById('file-upload'), dropZone: document.getElementById('drop-zone'),
    fileSelected: document.getElementById('file-selected'), fileError: document.getElementById('file-error'),
    mesReferencia: document.getElementById('mes-referencia'), dataVencimento: document.getElementById('data-vencimento'),
    processFaturasBtn: document.getElementById('process-faturas-btn'), processPlanilhaBtn: document.getElementById('process-planilha-btn'),
    resetBtn: document.getElementById('reset-btn'),
    outputGerador: document.getElementById('output-gerador'), outputProcessador: document.getElementById('output-processador'),
    emptyState: document.getElementById('empty-state'), searchContainer: document.getElementById('search-container'),
    searchInput: document.getElementById('search-client'), resultList: document.getElementById('result-list'),
    downloadAllArea: document.getElementById('download-all-area'), downloadAllZipBtn: document.getElementById('download-all-zip-btn'),
    downloadAllIndividualBtn: document.getElementById('download-all-individual-btn'), resLog: document.getElementById('res-log'),
    resError: document.getElementById('res-error'), downloadArea: document.getElementById('download-area'),
    downloadLink: document.getElementById('download-link'), toast: document.getElementById('toast'),
    pdfTemplateContainer: document.getElementById('pdf-template-container'),
    resultContent: document.getElementById('result-content'),
    toggleResultBtn: document.getElementById('toggle-result'),
};

// ===================================
// CONFIGURAÇÕES GLOBAIS
// ===================================
const CONFIG = {
    // Limites de arquivo
    MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB em bytes
    ALLOWED_FILE_TYPES: ['.xlsx', '.xlsm', '.xls', '.csv'],
    
    // Configurações de processamento
    BATCH_SIZE: 1000, // Número de linhas a processar por lote
    PYODIDE_PACKAGES: ['pandas', 'micropip'],
    PYODIDE_URL: 'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/',
    
    // Configurações de UI
    TOAST_DURATION: 4000, // Duração das mensagens toast em ms
    PAGINATION_SIZE: 10, // Número de itens por página
};

// ===================================
// INITIALIZATION
// ===================================
async function initPyodide() {
    const status = DOM.loadingStatus, bar = DOM.loadingProgress, tip = DOM.loadingTip;
    const steps = [ 
        { label: 'Baixando runtime...', weight: 35 }, 
        { label: 'Carregando pacotes...', weight: 20 }, 
        { label: 'Instalando openpyxl...', weight: 25 }, 
        { label: 'Compilando código...', weight: 15 }, 
        { label: 'Aquecendo ambiente...', weight: 5 }
    ];
    const totalWeight = steps.reduce((a, s) => a + s.weight, 0); 
    let accWeight = 0;
    
    const updateProgress = (stepIndex) => { 
        status.textContent = steps[stepIndex].label; 
        accWeight += steps[stepIndex].weight; 
        bar.style.width = `${Math.min(100, (accWeight / totalWeight) * 100)}%`; 
    };
    
    try {
        // Otimização: Carregar Pyodide com cache
        updateProgress(0); 
        pyodide = await loadPyodide({ 
            indexURL: CONFIG.PYODIDE_URL,
            fullStdLib: false // Carrega apenas o necessário da stdlib
        });
        
        // Carregar apenas os pacotes necessários
        updateProgress(1); 
        await pyodide.loadPackage(CONFIG.PYODIDE_PACKAGES);
        
        // Instalar openpyxl via micropip
        updateProgress(2); 
        await pyodide.pyimport('micropip').install('openpyxl');
        
        // Executar o código Python
        updateProgress(3); 
        pyodide.runPython(document.querySelector('script[type="text/python"]').textContent);
        
        updateProgress(4); 
        pythonLoaded = true;
        
        // Pré-carregar funções comuns para melhorar desempenho
        pyodide.runPython(`
            # Pré-inicializar funções comuns
            import pandas as pd
            import json
            # Criar um DataFrame vazio para inicializar o pandas
            pd.DataFrame()
        `);
    } catch (e) {
        status.textContent = 'Falha ao carregar o ambiente: ' + e.message; 
        console.error("Erro Pyodide:", e);
        showToast("Erro ao inicializar o ambiente Python: " + e.message, true);
    } finally {
        DOM.loadingOverlay.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    DOM.mesReferencia.value = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
    const dueDate = new Date(now.getFullYear(), now.getMonth(), 10);
    DOM.dataVencimento.value = `${dueDate.getFullYear()}-${String(dueDate.getMonth() + 1).padStart(2, '0')}-${String(dueDate.getDate()).padStart(2, '0')}`;

    DOM.dropZone.addEventListener('click', () => DOM.fileUpload.click());
    DOM.fileUpload.addEventListener('change', (e) => setSelectedFile(e.target.files[0]));
    ['dragenter','dragover'].forEach(ev => DOM.dropZone.addEventListener(ev, e => {e.preventDefault();DOM.dropZone.classList.add('drop-active');}));
    ['dragleave','drop'].forEach(ev => DOM.dropZone.addEventListener(ev, e => {e.preventDefault();DOM.dropZone.classList.remove('drop-active');}));
    DOM.dropZone.addEventListener('drop', e => setSelectedFile(e.dataTransfer.files[0]));
    [DOM.mesReferencia, DOM.dataVencimento].forEach(el => el.addEventListener('change', validateForm));
    DOM.processFaturasBtn.addEventListener('click', handleGerarFaturas);
    DOM.processPlanilhaBtn.addEventListener('click', handleProcessarPlanilha);
    DOM.resetBtn.addEventListener('click', () => {
        resetOutputArea();
        DOM.resetBtn.classList.add('hidden');
    });
    DOM.searchInput.addEventListener('input', (e) => {
        const q = (e.target.value || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
        const filtered = clientData.filter(c => (c.nome || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').includes(q) || String(c.instalacao || '').includes(q) );
        renderClientList(filtered);
    });
    DOM.resultList.addEventListener('click', handleIndividualPdfClick);
    DOM.downloadAllZipBtn.addEventListener('click', () => downloadAll('zip'));
    DOM.downloadAllIndividualBtn.addEventListener('click', () => downloadAll('individual'));
    DOM.toggleResultBtn.addEventListener('click', () => {
        DOM.resultContent.classList.toggle('collapsed');
        DOM.toggleResultBtn.querySelector('i').classList.toggle('fa-chevron-down');
        DOM.toggleResultBtn.querySelector('i').classList.toggle('fa-chevron-up');
    });
    
    validateForm();
    initPyodide();
});

// ===================================
// UI & STATE MANAGEMENT
// ===================================
function validateForm() {
    // Validação mais rigorosa dos campos
    let isValid = true;
    
    // Validar arquivo
    if (!selectedFile) {
        DOM.fileError.textContent = "Por favor, selecione um arquivo Excel válido.";
        DOM.fileError.classList.remove('hidden');
        isValid = false;
    } else if (!selectedFile.name.match(/\.(xlsx|xlsm|xls|csv)$/i)) {
        DOM.fileError.textContent = "Formato de arquivo inválido. Use apenas .xlsx, .xlsm, .xls ou .csv";
        DOM.fileError.classList.remove('hidden');
        isValid = false;
    } else {
        DOM.fileError.classList.add('hidden');
    }
    
    // Validar mês de referência
    if (!DOM.mesReferencia.value) {
        document.getElementById('mes-referencia-error').classList.remove('hidden');
        isValid = false;
    } else {
        document.getElementById('mes-referencia-error').classList.add('hidden');
    }
    
    // Validar data de vencimento
    if (!DOM.dataVencimento.value) {
        document.getElementById('data-vencimento-error').classList.remove('hidden');
        isValid = false;
    } else {
        document.getElementById('data-vencimento-error').classList.add('hidden');
    }
    
    DOM.processFaturasBtn.disabled = !isValid;
    DOM.processPlanilhaBtn.disabled = !isValid;
    return isValid;
}

function setSelectedFile(file) {
    if (!file) return;
    
    // Validação do tamanho do arquivo (limite de 50MB)
    const maxSize = 50 * 1024 * 1024; // 50MB em bytes
    if (file.size > maxSize) {
        DOM.fileError.textContent = `Arquivo muito grande (${(file.size/1024/1024).toFixed(2)} MB). O limite é 50MB.`;
        DOM.fileError.classList.remove('hidden');
        DOM.fileSelected.classList.add('hidden');
        return;
    }
    
    selectedFile = file;
    DOM.fileSelected.textContent = `${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
    DOM.fileSelected.classList.remove('hidden');
    DOM.fileError.classList.add('hidden');
    validateForm();
}

function showToast(message, isError = false) {
    // Corrigindo a cor do toast para sucesso
    DOM.toast.innerHTML = `${isError ? '<i class="fas fa-exclamation-circle mr-2"></i>' : '<i class="fas fa-check-circle mr-2"></i>'}${message}`;
    DOM.toast.className = `toast show ${isError ? 'bg-red-600' : 'bg-green-600'}`;
    setTimeout(() => { DOM.toast.classList.remove('show'); }, CONFIG.TOAST_DURATION);
}

function resetOutputArea() {
    [DOM.outputGerador, DOM.outputProcessador, DOM.searchContainer, DOM.downloadAllArea, DOM.downloadArea, DOM.resLog, DOM.resError].forEach(el => el.classList.add('hidden'));
    DOM.emptyState.classList.remove('hidden');
    DOM.resultList.innerHTML = ''; DOM.resLog.textContent = ''; DOM.resError.textContent = ''; clientData = [];
    if (lastUrl) { URL.revokeObjectURL(lastUrl); lastUrl = null; }
}

function setButtonsState(enabled, processingBtn = null, originalText = '') {
    DOM.processFaturasBtn.disabled = !enabled;
    DOM.processPlanilhaBtn.disabled = !enabled;
    if(processingBtn) {
        if(enabled) { processingBtn.innerHTML = originalText; } 
        else { processingBtn.innerHTML = '<div class="loader"></div> Processando...'; }
    }
}

// ===================================
// PROCESSING LOGIC
// ===================================
async function handleProcessarPlanilha() {
    if (DOM.processPlanilhaBtn.disabled || !pythonLoaded) return;
    const originalText = DOM.processPlanilhaBtn.innerHTML;
    setButtonsState(false, DOM.processPlanilhaBtn, originalText);
    resetOutputArea();
    try {
        const fileBuffer = await selectedFile.arrayBuffer();
        pyodide.globals.set('file_content_js', pyodide.toPy(new Uint8Array(fileBuffer)));
        pyodide.globals.set('mes_referencia_js', DOM.mesReferencia.value + '-01');
        pyodide.globals.set('vencimento_js', DOM.dataVencimento.value);
        const results = await pyodide.runPythonAsync(`processar_planilha_py(file_content_js, mes_referencia_js, vencimento_js)`);
        const [fileBytesOut, logMessages] = results.toJs();
        
        DOM.emptyState.classList.add('hidden');
        DOM.outputProcessador.classList.remove('hidden');
        DOM.resLog.textContent = logMessages;
        DOM.resLog.classList.remove('hidden');

        if (fileBytesOut) {
            const blob = new Blob([fileBytesOut], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            lastUrl = URL.createObjectURL(blob);
            DOM.downloadLink.href = lastUrl;
            DOM.downloadLink.download = `PROCESSADO_${DOM.mesReferencia.value.replace('-', '')}_${selectedFile.name.split('.')[0]}.xlsx`;
            DOM.downloadArea.classList.remove('hidden');
            showToast('Arquivo processado com sucesso!', false);
        } else {
            DOM.resError.textContent = "[PROCESSADOR] O processamento não gerou um arquivo. Verifique o log.";
            DOM.resError.classList.remove('hidden');
            showToast('Ocorreu um erro no processamento.', true);
        }
    } catch(e) {
        console.error("Erro no Processador:", e);
        DOM.resError.textContent = `[PROCESSADOR] Erro crítico: ${e.message}`;
        DOM.resError.classList.remove('hidden');
        showToast('Ocorreu um erro crítico.', true);
    } finally {
        setButtonsState(true, DOM.processPlanilhaBtn, originalText);
        DOM.resetBtn.classList.remove('hidden');
        validateForm();
    }
}

async function handleGerarFaturas() {
    if (DOM.processFaturasBtn.disabled || !pythonLoaded) return;
    const originalText = DOM.processFaturasBtn.innerHTML;
    setButtonsState(false, DOM.processFaturasBtn, originalText);
    resetOutputArea();
    
    // Adicionar barra de progresso
    DOM.loadingOverlay.style.display = 'flex';
    DOM.loadingStatus.textContent = 'Processando relatório...';
    DOM.loadingProgress.style.width = '0%';
    
    try {
        const fileContent = await selectedFile.arrayBuffer();
        pyodide.globals.set('file_content_js', pyodide.toPy(new Uint8Array(fileContent)));
        pyodide.globals.set('mes_referencia_js', DOM.mesReferencia.value);
        pyodide.globals.set('vencimento_js', DOM.dataVencimento.value);
        pyodide.globals.set('batch_size_js', CONFIG.BATCH_SIZE);
        
        // Modificar o Python para processar em lotes
        pyodide.runPython(`
            # Usar a função original para processar os dados, mas com processamento em lotes
            def processar_em_lotes(file_content, mes_referencia, vencimento, batch_size):
                import io
                import pandas as pd
                import json
                from js import updateProgressBar
                
                try:
                    # Processar o arquivo usando a função original
                    # Isso garante compatibilidade com o código existente
                    result_json = processar_relatorio_para_fatura(file_content, mes_referencia, vencimento)
                    result = json.loads(result_json)
                    
                    # Se houver erro, retornar imediatamente
                    if isinstance(result, dict) and 'error' in result:
                        return json.dumps(result)
                    
                    # Simular processamento em lotes para mostrar progresso
                    total_items = len(result)
                    batch_count = max(1, (total_items // 10))
                    
                    for i in range(10):
                        # Atualizar progresso
                        progress = min(100, (i + 1) * 10)
                        updateProgressBar(progress)
                    
                    return json.dumps(result)
                except Exception as e:
                    error_msg = f"Erro no processamento em lotes: {str(e)}"
                    print(error_msg)
                    return json.dumps({"error": error_msg})
        `);
        
        // Adicionar função para atualizar a barra de progresso
        window.updateProgressBar = (progress) => {
            DOM.loadingProgress.style.width = `${progress}%`;
            DOM.loadingStatus.textContent = `Processando relatório... ${progress}%`;
        };
        
        // Executar o processamento em lotes
        const resultJson = await pyodide.runPythonAsync(
            'processar_em_lotes(file_content_js, mes_referencia_js, vencimento_js, batch_size_js)'
        );
        const result = JSON.parse(resultJson);

        if (result.error) throw new Error(result.error);
        
        DOM.emptyState.classList.add('hidden');
        DOM.outputGerador.classList.remove('hidden');
        clientData = result;
        
        // Implementar paginação para a lista de clientes
        let currentPage = 1;
        const totalPages = Math.ceil(clientData.length / CONFIG.PAGINATION_SIZE);
        
        function renderPage(page) {
            const start = (page - 1) * CONFIG.PAGINATION_SIZE;
            const end = Math.min(start + CONFIG.PAGINATION_SIZE, clientData.length);
            const pageItems = clientData.slice(start, end);
            
            renderClientList(pageItems);
            
            // Adicionar controles de paginação
            if (totalPages > 1) {
                const paginationControls = document.createElement('div');
                paginationControls.className = 'pagination-controls flex justify-center mt-4 space-x-2';
                
                // Botão anterior
                const prevBtn = document.createElement('button');
                prevBtn.className = `px-3 py-1 rounded ${page === 1 ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}`;
                prevBtn.textContent = 'Anterior';
                prevBtn.disabled = page === 1;
                prevBtn.onclick = () => renderPage(page - 1);
                
                // Informação da página
                const pageInfo = document.createElement('span');
                pageInfo.className = 'px-3 py-1';
                pageInfo.textContent = `Página ${page} de ${totalPages}`;
                
                // Botão próximo
                const nextBtn = document.createElement('button');
                nextBtn.className = `px-3 py-1 rounded ${page === totalPages ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}`;
                nextBtn.textContent = 'Próximo';
                nextBtn.disabled = page === totalPages;
                nextBtn.onclick = () => renderPage(page + 1);
                
                paginationControls.appendChild(prevBtn);
                paginationControls.appendChild(pageInfo);
                paginationControls.appendChild(nextBtn);
                
                DOM.resultList.appendChild(paginationControls);
            }
        }
        
        // Renderizar a primeira página
        renderPage(currentPage);
        
        showToast(`${clientData.length} faturas geradas.`, false);
        DOM.searchContainer.classList.remove('hidden');
        DOM.downloadAllArea.classList.remove('hidden');
    } catch(e) {
        console.error("Erro no Gerador de Faturas:", e);
        DOM.emptyState.classList.add('hidden');
        DOM.outputGerador.classList.remove('hidden');
        DOM.resultList.innerHTML = `<p class="text-red-500 p-4">[GERADOR DE FATURAS] ${e.message}</p>`;
        showToast('Erro ao processar o relatório: ' + e.message, true);
    } finally {
        DOM.loadingOverlay.style.display = 'none';
        setButtonsState(true, DOM.processFaturasBtn, originalText);
        DOM.resetBtn.classList.remove('hidden');
        validateForm();
    }
}

// ===================================
// INVOICE GENERATOR HELPERS
// ===================================
function safe(s='') { return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, ''); }
function formatCurrency(v,d=2){return(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:d,maximumFractionDigits:d})}
function formatNumber(value, decimals = 2) { return (value || 0).toFixed(decimals).replace('.',',');}

async function saveFile(blob, filename) {
    if (window.showSaveFilePicker) {
        try {
            const handle = await window.showSaveFilePicker({ suggestedName: filename, types: [{ description: 'PDF files', accept: { 'application/pdf': ['.pdf'] } }] });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            return;
        } catch (err) { if (err.name === 'AbortError') return; }
    }
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 100);
}

async function populateAndGeneratePdfBlob(client, mesReferencia) {
    const element = DOM.pdfTemplateContainer.querySelector('#pdf-page').cloneNode(true);
    document.body.appendChild(element); // Add to body to ensure styles are applied
    const get = (id) => element.querySelector(`#${id}`);
    
    const [y,m] = mesReferencia.split('-').map(Number);
    const refDate = new Date(y, m - 1, 1);
    const emissao = new Date(`${client.emissao_iso}T00:00:00`);
    const venc = new Date(`${client.vencimento_iso}T00:00:00`);
    const mesNome = refDate.toLocaleDateString('pt-BR', { month: 'long' });
    const mesCap = mesNome.charAt(0).toUpperCase() + mesNome.slice(1);
    get('pdf-titulo-p1').textContent = `Sua contribuição de ${mesCap} chegou`;
    get('pdf-nome-cliente-p1').textContent = client.nome;
    get('pdf-cpf-p1').textContent = `CPF/CNPJ: ${client.documento}`;
    get('pdf-endereco-p1').textContent = client.endereco;
    get('pdf-instalacao-p1').textContent = client.instalacao;
    get('pdf-emissao-p1').textContent = emissao.toLocaleDateString('pt-BR');
    get('pdf-total-pagar').textContent = formatCurrency(client.totalPagar);
    get('pdf-vencimento-p1').textContent = venc.toLocaleDateString('pt-BR', { day:'2-digit', month:'long', year:'numeric' });
    get('pdf-economia-mes').textContent = formatCurrency(client.economiaMes);
    get('pdf-economia-acumulada').textContent = formatCurrency(client.economiaTotal);
    get('pdf-arvores').textContent = formatNumber(client.arvoresEquivalentes);
    get('pdf-co2').textContent = `${formatNumber(client.co2Evitado)} kg CO₂`;
    get('pdf-ref-foot').textContent = refDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }).replace('.', '');
    get('pdf-valor-foot').textContent = formatCurrency(client.totalPagar);
    get('pdf-venc-foot').textContent = venc.toLocaleDateString('pt-BR');
    get('pdf-det-credito-label').textContent = Number(client.det_credito_qtd || 0) === 0 && Number(client.totalPagar || 0) > 0 ? 'Contribuição Fixa' : 'Crédito de Energia';
    const tarEl = get('pdf-det-credito-tar');
    const tarToShow = Number(client.det_credito_tar) > 0 ? client.det_credito_tar : client.det_credito_tar_efetiva;
    tarEl.textContent = (Number(client.det_credito_qtd) || 0) > 0 ? formatCurrency(tarToShow, 4) : '—';
    tarEl.title = Number(client.det_credito_tar) <= 0 ? 'Tarifa efetiva (calculada a partir do boleto)' : '';
    get('pdf-det-credito-qtd').textContent = formatNumber(client.det_credito_qtd);
    get('pdf-det-credito-total').textContent = formatCurrency(client.det_credito_total);
    get('pdf-det-total-contrib').textContent = formatCurrency(client.totalPagar);
    get('pdf-dist-consumo-qtd').textContent = `${formatNumber(client.dist_consumo_qtd)} kWh`;
    get('pdf-dist-consumo-tar').textContent = formatCurrency(client.dist_consumo_tar, 4);
    get('pdf-dist-consumo-total').textContent = formatCurrency(client.dist_consumo_total);
    get('pdf-dist-comp-qtd').textContent = `${formatNumber(client.dist_comp_qtd)} kWh`;
    get('pdf-dist-comp-tar').textContent = formatCurrency(client.dist_comp_tar, 4);
    const compTotal = Number(client.dist_comp_total || 0);
    get('pdf-dist-comp-total').textContent = `${compTotal < 0 ? '− ' : ''}${formatCurrency(Math.abs(compTotal))}`;
    get('pdf-dist-outros').textContent = formatCurrency(client.dist_outros);
    get('pdf-dist-total').textContent = formatCurrency(client.dist_total);
    const econTarifaDistEl = get('pdf-econ-tarifa-dist');
    econTarifaDistEl.textContent = `${formatNumber(client.dist_consumo_tar, 4)}`;
    econTarifaDistEl.title = client.used_fallback_tar_cons ? "Tarifa de referência assumida para este cálculo." : "";
    get('pdf-econ-qtd-dist').textContent = `${formatNumber(client.dist_consumo_qtd)} kWh`;
    get('pdf-econ-outros').textContent = formatCurrency(client.dist_outros);
    const econRaw = Number(client._econ_mes_raw || 0);
    const semGD = Number(client.custo_s_gd) > 0 ? Number(client.custo_s_gd) : Number(client.econ_total_sem || 0);
    const comGD = Number(client.custo_s_gd) > 0 ? (Number(client.fatura_c_gd || 0) + Number(client.totalPagar || 0)) : Number(client.econ_total_com || 0);
    const econ  = Number(client.economiaMes ?? (semGD - comGD));
    const econEl = get('pdf-econ-mes-valor');
    econEl.textContent = formatCurrency(econ);
    econEl.title = econRaw < 0 ? `Atenção: economia bruta foi ${formatCurrency(econRaw)}` : '';
    get('pdf-econ-sem-gd').textContent = formatCurrency(semGD);
    get('pdf-econ-com-gd').textContent = formatCurrency(comGD);
    get('pdf-econ-total-sem').textContent = formatCurrency(semGD);
    get('pdf-econ-total-com').textContent = formatCurrency(comGD);
    get('pdf-footer-warning').style.display = Number(client.dist_total || 0) > 0 ? '' : 'none';
    const contrib_total = Number(client.totalPagar || 0), comp_qtd = Number(client.det_credito_qtd || 0);
    const expEl = get('pdf-econ-exp-ev');
    if (comp_qtd > 0) {
        const tarifa_efetiva = client.det_credito_tar_efetiva || (contrib_total / comp_qtd);
        expEl.innerHTML = `(Tarifa R$ ${formatNumber(tarifa_efetiva, 4)}) x Qtd. ${formatNumber(comp_qtd)} kWh) + Total Distribuidora ${formatCurrency(client.dist_total)}`;
    } else {
        expEl.textContent = `Contribuição fixa ${formatCurrency(contrib_total)} + Total Distribuidora ${formatCurrency(client.dist_total)}`;
    }
    const refLabel = refDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }).replace('.', '').replace(/\s+/g, '_');
    const filename = `Fatura_${safe(String(client.instalacao))}_${safe(String(client.nome))}_${safe(refLabel)}`.slice(0,100)+'.pdf';
    const opt = { margin: 0, filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['css','avoid-all'] } };
    
    return new Promise((resolve, reject) => {
        setTimeout(async () => {
            try {
                const worker = html2pdf().from(element).set(opt);
                const pdf = await worker.toPdf().get('pdf');
                if (pdf.getNumberOfPages() > 1) pdf.deletePage(2);
                const pdfBlob = await new Promise((res) => setTimeout(() => res(pdf.output('blob')), 0));
                element.remove(); // Clean up the cloned element
                resolve({ blob: pdfBlob, filename });
            } catch (err) { 
                element.remove(); // Clean up on error too
                reject(err); 
            }
        }, 0);
    });
}

function renderClientList(clientsToRender) {
    let html = '';
    const summary = `<div class="p-2 bg-emerald-50 border border-emerald-200 rounded mb-2 text-sm"><strong>${clientData.length}</strong> cliente(s) • Total a faturar: <strong>${formatCurrency(clientData.reduce((a,c)=>a+Number(c.totalPagar||0),0))}</strong></div>`;
    
    const problemClients = clientData.filter(c => c._divergencia_calculo > 0.10);
    if (problemClients.length > 0) {
        html += `<div class="p-3 bg-yellow-50 border border-yellow-200 rounded mb-3 text-sm">
            <h4 class="font-bold text-yellow-800 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i>Atenção: ${problemClients.length} Cliente(s) com Divergência</h4>
            <p class="text-yellow-700 mt-1">O valor da "Fatura C/GD" na planilha difere do valor calculado. Verifique os clientes destacados abaixo.</p>
        </div>`;
    }
        
    clientsToRender.forEach((client) => {
        const hasDivergence = client._divergencia_calculo > 0.10;
        const itemBg = hasDivergence ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-200';
        const divergenceIcon = hasDivergence ? `<span class="ml-2 text-yellow-600" title="Divergência de ${formatCurrency(client._divergencia_calculo)}"><i class="fas fa-exclamation-triangle"></i></span>` : '';
        html += `<div class="flex items-center justify-between p-2 border rounded-lg ${itemBg}"><div><p class="text-sm font-medium flex items-center">${client.nome}${divergenceIcon}</p><p class="text-xs text-gray-500">Instalação: ${client.instalacao || ''}</p></div><button data-instalacao="${client.instalacao}" class="btn btn-primary btn-sm generate-pdf-btn" aria-label="Gerar PDF para ${client.nome}"><i class="fas fa-file-pdf mr-1"></i> PDF</button></div>`;
    });
    DOM.resultList.innerHTML = summary + html;
    if (clientsToRender.length === 0 && clientData.length > 0) {
      DOM.resultList.innerHTML += '<p class="text-center text-gray-500 p-4">Nenhum cliente encontrado na busca.</p>';
    }
}

async function handleIndividualPdfClick(e) {
    const button = e.target.closest('.generate-pdf-btn');
    if (!button || button.disabled) return;
    const instalacao = button.dataset.instalacao;
    const client = clientData.find(c => String(c.instalacao) === String(instalacao));
    if (client) {
        button.disabled = true; button.innerHTML = '<div class="loader !w-4 !h-4 !border-2"></div>';
        try {
            const { blob, filename } = await populateAndGeneratePdfBlob(client, DOM.mesReferencia.value);
            await saveFile(blob, filename);
            showToast(`PDF gerado: ${client.nome}`, false);
        } catch (err) {
            console.error(`Falha ao gerar PDF para ${client.nome}:`, err);
            showToast(`Erro ao gerar PDF para ${client.nome}.`, true);
        } finally {
            button.disabled = false; button.innerHTML = '<i class="fas fa-file-pdf mr-1"></i> PDF';
        }
    }
}

async function downloadAll(type) {
    const btn = type === 'zip' ? DOM.downloadAllZipBtn : DOM.downloadAllIndividualBtn;
    if (btn.disabled) return;
    const originalText = btn.innerHTML;
    setButtonsState(false, btn, originalText);
    const total = clientData.length; let completed = 0; let errorCount = 0;
    const startTime = Date.now();
    const updateProgress = () => {
        completed++;
        const pct = Math.round((completed / total) * 100);
        const elapsed = (Date.now() - startTime) / 1000; // in seconds
        const eta = Math.ceil((elapsed / completed) * (total - completed));
        btn.innerHTML = `<div class="loader"></div> ${pct}% (${completed}/${total}) • ~${eta}s`;
    };
    if (type === 'zip') {
        const zip = new JSZip();
        for (const client of clientData) {
            try { const {blob, filename} = await populateAndGeneratePdfBlob(client, DOM.mesReferencia.value); zip.file(filename, blob); } 
            catch (e) { errorCount++; console.error(`Falha no PDF (ZIP) para ${client.nome}:`, e); }
            updateProgress();
        }
        const content = await zip.generateAsync({type:"blob"});
        await saveFile(content, `Faturas_${DOM.mesReferencia.value.replace('-', '_')}.zip`);
    } else {
        if (window.showDirectoryPicker) {
            try {
                const dirHandle = await window.showDirectoryPicker();
                for (const client of clientData) {
                    try {
                        const { blob, filename } = await populateAndGeneratePdfBlob(client, DOM.mesReferencia.value);
                        const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob); await writable.close();
                    } catch (e) { errorCount++; console.error(`Falha ao salvar PDF para ${client.nome}:`, e); }
                    updateProgress();
                }
            } catch(e) { if(e.name !== 'AbortError') showToast('Não foi possível salvar na pasta.', true); }
        } else {
            if(!confirm('Cada fatura será baixada individualmente. Deseja continuar?')) { setButtonsState(true, btn, originalText); return; }
            for (const client of clientData) {
                try { const { blob, filename } = await populateAndGeneratePdfBlob(client, DOM.mesReferencia.value); await new Promise(res => setTimeout(res, 300)); await saveFile(blob, filename); } 
                catch (e) { errorCount++; console.error(`Falha ao baixar PDF para ${client.nome}:`, e); }
                updateProgress();
            }
        }
    }
    showToast(errorCount > 0 ? `Concluído, mas ${errorCount} arquivo(s) falharam.` : 'Todos os arquivos foram gerados!', errorCount > 0);
    setButtonsState(true, btn, originalText);
}
</script>

</body>
</html>

