<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Faturas - EGS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Scripts da aplicação -->
    <script type="importmap">
    {
        "imports": {
            "./js/fileHandler.js": "./js/fileHandler.js",
            "./js/pdfGenerator.js": "./js/pdfGenerator.js",
            "./js/uiController.js": "./js/uiController.js"
        }
    }
    </script>
    <script type="module" src="js/app.js"></script>
    <style>
      :root {
        --ink: #0B1220;
        --bg: #F7F8FA;
        --card: #FFFFFF;
        --line: #E7EBF0;
        --pdf-dark-bg: #191948;
        --pdf-dark-box: #12123B;
        --pdf-green: #4CAF50;
      }
      body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--ink); }
      .card {
        background: var(--card); border: 1px solid var(--line);
        border-radius: 14px; box-shadow: 0 1px 2px rgba(16,24,40,.04);
        padding: 24px; margin-bottom: 24px;
      }
      .btn {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;
        transition: all 0.2s;
      }
      .btn-primary { background: #191948; color: #FFFFFF; }
      .btn-primary:hover { background: #12123B; }
      .loader {
        border: 4px solid #e0e0e0; border-top: 4px solid #191948;
        border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      #drop-zone.drop-active { border-color: #191948; background: #eef2ff; }
      .page-break { page-break-before: always; }

      /* ajuda a manter tudo em 1 página */
      #pdf-page * { page-break-inside: avoid; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p id="loading-status" class="mt-4 text-gray-700 font-semibold">Carregando ambiente...</p>
    </div>

    <!-- Sistema de Notificações -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Barra de Progresso -->
    <div id="progress-overlay" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-40 hidden">
        <div class="w-64 bg-gray-200 rounded-full h-2.5 mb-4">
            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p id="progress-status" class="text-gray-700 font-semibold"></p>
        <p id="progress-detail" class="text-gray-500 text-sm mt-2"></p>
    </div>

    <div class="w-full max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <svg class="mx-auto mb-4 h-12 w-auto" viewBox="0 0 200 50" fill="#191948" xmlns="http://www.w3.org/2000/svg">
                <text x="5" y="35" font-family="Poppins, sans-serif" font-size="30" font-weight="bold">EGS</text>
                <text x="65" y="35" font-family="Poppins, sans-serif" font-size="30">energia</text>
            </svg>
            <h1 class="text-4xl font-bold text-gray-800">Gerador de Faturas</h1>
            <p class="text-gray-600 mt-2">Gere as faturas personalizadas dos clientes a partir do relatório.</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-5 gap-6">
            <div class="md:col-span-2">
                <div class="card">
                    <h2 class="text-xl font-semibold">1. Carregar Relatório</h2>
                    <input id="file-upload" type="file" class="hidden" accept=".xlsm,.xlsx,.xls">
                    <div id="drop-zone" class="mt-4 rounded-lg border-2 border-dashed border-gray-300 p-6 text-center text-gray-500 cursor-pointer">
                        <i class="fas fa-cloud-arrow-up text-3xl"></i>
                        <p class="font-semibold mt-2">Arraste e solte ou clique</p>
                    </div>
                    <p id="file-selected" class="mt-3 text-sm font-semibold text-green-700 hidden"></p>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-semibold">2. Parâmetros</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="mes-referencia" class="block text-sm font-medium text-gray-700 mb-1">Mês de Referência</label>
                            <input type="month" id="mes-referencia" class="w-full rounded-lg border border-gray-300 p-2.5">
                        </div>
                        <div>
                            <label for="data-vencimento" class="block text-sm font-medium text-gray-700 mb-1">Data de Vencimento</label>
                            <input type="date" id="data-vencimento" class="w-full rounded-lg border border-gray-300 p-2.5">
                        </div>
                    </div>
                </div>

                <button id="process-btn" class="w-full btn btn-primary text-lg py-3" disabled>
                    <i class="fas fa-cogs mr-2"></i> Processar Relatório
                </button>
            </div>

            <div class="md:col-span-3 card">
                <h2 class="text-xl font-semibold">3. Gerar Faturas</h2>
                <div id="search-container" class="relative mt-4 hidden">
                    <input type="text" id="search-client" placeholder="Procurar cliente..." class="w-full rounded-lg border border-gray-300 p-2 pl-10">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                </div>
                <div id="result-list" class="mt-4 space-y-2 max-h-96 overflow-y-auto">
                    <div id="empty-state" class="text-center text-gray-500 py-10">
                        <i class="fas fa-users text-3xl mb-2 text-gray-300"></i>
                        <p class="font-semibold">Aguardando processamento</p>
                    </div>
                </div>
                <div id="download-all-area" class="mt-4 hidden">
                     <button id="download-all-btn" class="w-full btn bg-gray-700 text-white hover:bg-gray-900 py-2">
                         <i class="fas fa-file-archive mr-2"></i> Baixar Todas (ZIP)
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Template Oculto para Geração do PDF -->
    <div class="fixed -left-[9999px] top-0 opacity-0">
      <div id="pdf-container">
        <!-- ÚNICA PÁGINA -->
        <div id="pdf-page" style="width:210mm;height:296.8mm;background:#fff;color:#0B1220;padding:18mm 14mm;display:flex;flex-direction:column;font-family:'Poppins',sans-serif; font-size:10.5px; line-height:1.25; box-sizing:border-box; overflow:hidden;">
          
          <!-- Cabeçalho -->
          <header class="flex justify-between items-start" style="margin-bottom:6mm;">
            <!-- TOPO: EGS ENERGIA em CAIXA ALTA, alinhado à esquerda, fonte 34px -->
            <div style="display:flex; flex-direction:column; gap:4mm; max-width:120mm;">
              <div style="font-weight:700; font-size:34px; letter-spacing:0.5px; text-align:left;">EGS ENERGIA</div>
              <div id="pdf-titulo-p1" style="font-weight:600; font-size:13px; text-align:left;">
                Sua contribuição de [Mês] chegou
              </div>
            </div>
          
            <!-- Direita: dados do cliente (apenas aqui, sem repetir no meio da página) -->
            <div class="text-right" style="font-size:10px; max-width:72mm;">
              <p id="pdf-nome-cliente-p1" class="font-bold" style="font-size:12px;">[Nome Cliente]</p>
              <p id="pdf-cpf-p1" class="text-gray-600">[CPF/CNPJ]</p>
              <p id="pdf-endereco-p1" class="text-gray-600">[Endereço]</p>
              <p class="mt-1">Código Instalação: <span id="pdf-instalacao-p1" class="font-bold">[Instalação]</span></p>
              <p>Número da conta: <span id="pdf-numconta-p1" class="font-bold">[Num Conta]</span></p>
              <p>Emissão: <span id="pdf-emissao-p1" class="font-bold">[Emissão]</span></p>
            </div>
          </header>
      
            <!-- Faixa superior: Total + Indicadores -->
            <section style="display:grid; grid-template-columns: 1.2fr 1fr; gap:8mm; align-items:start; margin-bottom:6mm;">
              <!-- Total a pagar (igual) -->
              <div class="p-6 rounded-xl" style="background:#12123B; color:#fff;">
                <p style="font-size:12px;">Total a pagar</p>
                <p id="pdf-total-pagar" class="font-bold" style="font-size:34px; margin:6px 0 8px;">R$ 0,00</p>
                <p style="font-size:10px;">Data de vencimento</p>
                <p id="pdf-vencimento-p1" style="font-size:12px; font-weight:600;">[Data]</p>
              </div>
            
              <!-- 4 indicadores em QUADROS como o “Total a pagar” -->
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5mm;">
                <div class="p-3 rounded-lg" style="background:#12123B; color:#fff;">
                  <p id="pdf-economia-mes" class="font-bold" style="font-size:16px;">R$ 0,00</p>
                  <p style="opacity:.9;">Economia Mês</p>
                </div>
                <div class="p-3 rounded-lg" style="background:#12123B; color:#fff;">
                  <p id="pdf-economia-acumulada" class="font-bold" style="font-size:16px;">R$ 0,00</p>
                  <p style="opacity:.9;">Economia acumulada</p>
                </div>
                <div class="p-3 rounded-lg" style="background:#12123B; color:#fff;">
                  <p id="pdf-arvores" class="font-bold" style="font-size:16px;">0,00</p>
                  <p style="opacity:.9;">Árvores preservadas</p>
                </div>
                <div class="p-3 rounded-lg" style="background:#12123B; color:#fff;">
                  <p id="pdf-co2" class="font-bold" style="font-size:16px;">0,00 kg</p>
                  <p style="opacity:.9;">CO2 poupados</p>
                </div>
              </div></section>
              
            <!-- RESUMO DE ECONOMIA (sem percentual) --><section id="pdf-resumo-economia" style="margin:6mm 0 6mm 0;">
              <div class="rounded-lg" style="background:#F3F4F6; padding:10px 12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700; font-size:12px;">Resumo da sua economia</div>
                  <div style="text-align:right;">
                    <div style="font-size:18px; font-weight:800; color:#16A34A;">
                      <span id="pdf-econ-mes-valor">R$ 0,00</span>
                    </div>
                    <div style="font-size:10px; color:#374151; margin-top:2px;">
                      Sem GD: <span id="pdf-econ-sem-gd">R$ 0,00</span> &nbsp; • &nbsp;
                      Com GD: <span id="pdf-econ-com-gd">R$ 0,00</span>
                    </div>
                  </div>
                </div>
              </div></section>
      
            <!-- Duas tabelas lado a lado (o que ficava na página 2) -->
            <section style="display:grid; grid-template-columns: 1fr 1fr; gap:8mm; margin-bottom:6mm; font-size:10px;">
              <!-- Detalhamento Contribuição -->
              <div>
                <h2 class="font-bold" style="font-size:11px; margin-bottom:2mm;">Como calculamos sua contribuição</h2>
                <table class="w-full" style="width:100%; border-collapse:collapse;">
                  <colgroup>
                    <col style="width:44%"><col style="width:16%"><col style="width:20%"><col style="width:20%">
                  </colgroup>
                  <thead>
                    <tr style="border-bottom:1px solid #D1D5DB;">
                      <th class="text-left" style="padding:6px 4px;">Descrição</th>
                      <th class="text-right" style="padding:6px 4px;">Quantidade</th>
                      <th class="text-right" style="padding:6px 4px;">Tarifa de referência</th>
                      <th class="text-right" style="padding:6px 4px;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Crédito de Energia</td>
                      <td id="pdf-det-credito-qtd" class="text-right" style="padding:5px 4px;"></td>
                      <td id="pdf-det-credito-tar" class="text-right" style="padding:5px 4px;"></td>
                      <td id="pdf-det-credito-total" class="text-right" style="padding:5px 4px; font-weight:600;"></td>
                    </tr>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Desconto extra</td>
                      <td class="text-right" style="padding:5px 4px;">0,00</td>
                      <td class="text-right" style="padding:5px 4px;">R$ 0,00</td>
                      <td class="text-right" style="padding:5px 4px; font-weight:600;">R$ 0,00</td>
                    </tr>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Ajuste retroativo</td>
                      <td class="text-right" style="padding:5px 4px;"></td>
                      <td class="text-right" style="padding:5px 4px;"></td>
                      <td class="text-right" style="padding:5px 4px; font-weight:600;">R$ 0,00</td>
                    </tr>
                    <tr style="background:#F3F4F6;">
                      <td style="padding:5px 4px; font-weight:700;">Total da sua contribuição</td>
                      <td class="text-right" style="padding:5px 4px;"></td>
                      <td class="text-right" style="padding:5px 4px;"></td>
                      <td id="pdf-det-total-contrib" class="text-right" style="padding:5px 4px; font-weight:700;"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
      
              <!-- Distribuidora + Como verificar -->
              <div>
                <h2 class="font-bold" style="font-size:11px; margin-bottom:2mm;">Como ficou sua conta da distribuidora</h2>
                <table class="w-full" style="width:100%; border-collapse:collapse; margin-bottom:4mm;">
                  <!-- largura das colunas: dá mais respiro pros números -->
                  <colgroup>
                    <col style="width:44%"><col style="width:16%"><col style="width:20%"><col style="width:20%">
                  </colgroup>
                  <thead>
                    <tr style="border-bottom:1px solid #D1D5DB;">
                      <th class="text-left" style="padding:6px 4px;">Descrição</th>
                      <th class="text-right" style="padding:6px 4px;">Quantidade</th>
                      <th class="text-right" style="padding:6px 4px;">Tarifa</th>
                      <th class="text-right" style="padding:6px 4px;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Energia Consumida</td>
                      <td id="pdf-dist-consumo-qtd" class="text-right" style="padding:5px 4px;"></td>
                      <td id="pdf-dist-consumo-tar" class="text-right" style="padding:5px 4px;"></td>
                      <td id="pdf-dist-consumo-total" class="text-right" style="padding:5px 4px;"></td>
                    </tr>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Energia Compensada</td>
                      <td id="pdf-dist-comp-qtd" class="text-right" style="padding:5px 4px;"></td>
                      <td id="pdf-dist-comp-tar" class="text-right" style="padding:5px 4px;"></td>
                      <td id="pdf-dist-comp-total" class="text-right" style="padding:5px 4px;"></td>
                    </tr>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Contrib. Ilum. Pública e Outros</td>
                      <td class="text-right" style="padding:5px 4px;"></td>
                      <td class="text-right" style="padding:5px 4px;"></td>
                      <td id="pdf-dist-outros" class="text-right" style="padding:5px 4px;"></td>
                    </tr>
                    <tr style="background:#F3F4F6;">
                      <td style="padding:5px 4px; font-weight:700;">Total a pagar na sua fatura da distribuidora</td>
                      <td class="text-right" style="padding:5px 4px;"></td>
                      <td class="text-right" style="padding:5px 4px;"></td>
                      <td id="pdf-dist-total" class="text-right" style="padding:5px 4px; font-weight:700;"></td>
                    </tr>
                  </tbody></table>
              </div>
            </section>

            <!-- Quadros de comparação lado a lado -->
            <section style="margin-bottom:6mm;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5mm; margin-bottom:5mm;">
                <!-- Esquerda: Consumindo da Distribuidora -->
                <div class="rounded-lg" style="background:#F3F4F6; padding:8px 10px; display:flex; justify-content:space-between; align-items:baseline;">
                  <div class="font-bold">Se fosse só distribuidora</div>
                  <div class="text-right">
                    <span id="pdf-econ-total-sem" class="font-bold" style="font-size:12px;">R$ 0,00</span><br>
                    <span class="text-gray-600">(Tarifa <span id="pdf-econ-tarifa-dist"></span> x Qtd. <span id="pdf-econ-qtd-dist"></span>) + Outros <span id="pdf-econ-outros"></span></span>
                  </div>
                </div>
            
                <!-- Direita: Contribuição Mensal -->
                <div class="rounded-lg" style="background:#F3F4F6; padding:8px 10px; display:flex; justify-content:space-between; align-items:baseline;">
                  <div class="font-bold">Com EGS</div>
                  <div class="text-right">
                    <span id="pdf-econ-total-com" class="font-bold" style="font-size:12px;">R$ 0,00</span><br>
                    <span id="pdf-econ-exp-ev" class="text-gray-600"></span>
                  </div>
                </div>
              </div>
            
              <!-- Full-width: Total da sua Economia -->
              <div class="rounded-lg text-center" style="background:#12123B; color:#fff; padding:10px;">
                <p class="font-bold" style="font-size:12px;">Sua economia neste mês</p>
                <p id="pdf-econ-economia-final" class="font-bold" style="font-size:18px;">R$ 0,00</p>
              </div></section>
      
            <!-- Rodapé -->
            <footer style="margin-top:auto; font-size:9.5px; color:#6B7280;">
              <div class="p-2 rounded-lg font-bold text-white" style="background:#12123B; margin-bottom:6px;">
                Atenção! Você ainda precisa pagar a conta da distribuidora.
              </div>
            
              <!-- DEPOIS: apenas a coluna direita com a tabela -->
              <div style="display:grid; grid-template-columns: 1fr; gap:8mm; align-items:start; margin-bottom:6mm;">
                <div>
                  <table style="width:100%; border-collapse:collapse;">
                    <thead>
                      <tr style="border-bottom:1px solid #D1D5DB;">
                        <th class="text-left" style="padding:6px 4px; font-weight:600;">Referência</th>
                        <th class="text-left" style="padding:6px 4px; font-weight:600;">Valor</th>
                        <th class="text-left" style="padding:6px 4px; font-weight:600;">Vencimento</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td id="pdf-ref-foot" style="padding:5px 4px;">[Ref]</td>
                        <td id="pdf-valor-foot" style="padding:5px 4px;">[Valor]</td>
                        <td id="pdf-venc-foot" style="padding:5px 4px;">[Venc]</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <!-- Contatos EGS (rodapé) -->
              <div style="margin-top:4mm;">
                <div class="rounded-lg" style="background:#F3F4F6; padding:8px 10px; display:flex; align-items:center; gap:14px; flex-wrap:wrap;">
                  <div style="display:flex; align-items:center; gap:6px; font-size:10.5px; color:#0B1220;">
                    <i class="fa-solid fa-envelope" aria-hidden="true" style="font-size:12px; color:#12123B;"></i>
                    <span><strong>E-mail:</strong> atendimento@egsenergia.com.br</span>
                  </div>
                  <div style="width:1px; height:14px; background:#D1D5DB;"></div>
                  <div style="display:flex; align-items:center; gap:6px; font-size:10.5px; color:#0B1220;">
                    <i class="fa-brands fa-whatsapp" aria-hidden="true" style="font-size:12px; color:#16A34A;"></i>
                    <span><strong>WhatsApp:</strong> (11) 99670-3826</span>
                  </div>
                </div>
              </div>
            </footer>
    
        </div>
      </div>
    </div>


<script type="text/python">
import pandas as pd
import io
import re
import unicodedata
import json
from datetime import datetime

def processar_relatorio_para_fatura(file_content, mes_referencia_str, vencimento_str):
    import pandas as pd, io, json
    from datetime import datetime

    CO2_PER_KWH = 0.07
    TREES_PER_TON_CO2 = 8
    Fallback_Tarifa_Dist = 0.916370
    Fallback_Tarifa_Comp_EV = 0.716045

    try:
        xls = pd.ExcelFile(io.BytesIO(file_content), engine='openpyxl')

        def find_sheet_and_header(xls, key_cols, prefer_name=None, max_rows=30):
            sheet_names = list(xls.sheet_names)
            if prefer_name and prefer_name in sheet_names:
                sheet_names.insert(0, sheet_names.pop(sheet_names.index(prefer_name)))
            for sheet_name in sheet_names:
                try:
                    df_sample = pd.read_excel(xls, sheet_name=sheet_name, header=None, nrows=max_rows)
                    for i, row in df_sample.iterrows():
                        row_as_string = ' '.join(str(v) for v in row.dropna().values)
                        if all(k in row_as_string for k in key_cols):
                            return sheet_name, i
                except Exception:
                    continue
            return None, -1

        aba_consumo, header_consumo = find_sheet_and_header(xls, ["REF"], prefer_name="Detalhe Por UC")
        if not aba_consumo or header_consumo < 0:
            return json.dumps({"error": "Aba com dados de consumo não encontrada."})

        df = pd.read_excel(xls, sheet_name=aba_consumo, header=header_consumo)
        df.columns = [str(c).strip() for c in df.columns]

        def _norm(s):
            import unicodedata, re
            s = str(s or "")
            s = "".join(c for c in unicodedata.normalize("NFD", s) if unicodedata.category(c) != "Mn")
            return re.sub(r"\s+", " ", s).strip().upper()
        def pick_col(df, *alternativas):
            cols_norm = {_norm(c): c for c in df.columns}
            for alt in alternativas:
                key = _norm(alt)
                if key in cols_norm: return cols_norm[key]
            for k, original in cols_norm.items():
                if any(_norm(a) in k for a in alternativas): return original
            return None
        def to_num(x):
            import re, pandas as pd
            if pd.isna(x): return 0.0
            if isinstance(x, (int, float)): return float(x)
            s = str(x).replace("\u00a0", " ").strip()
            s = re.sub(r"[Rr]\$|\%", "", s).replace(" ", "")
            if s.count(",") == 1 and s.count(".") >= 1: s = s.replace(".", "").replace(",", ".")
            elif s.count(",") == 1 and s.count(".") == 0: s = s.replace(",", ".")
            try: return float(s)
            except Exception: return 0.0

        col_ref = pick_col(df, "REF (sempre dia 01 de cada mês)", "REF")
        col_inst = pick_col(df, "Instalação", "Nº Instalação")
        col_nome = pick_col(df, "Nome Cliente", "Nome/Razão Social")
        col_doc = pick_col(df, "Documento", "CPF/CNPJ")
        col_consumo_qtd = pick_col(df, "CONSUMO_FP")
        col_comp_qtd = pick_col(df, "CRÉD. CONSUMIDO_FP")
        col_tarifa_consumo = pick_col(df, "TARIFA FP")
        col_tarifa_comp_ev = pick_col(df, "TARIFA_Comp_FP")
        col_tarifa_comp_dist = pick_col(df, "TARIFA DE ENERGIA COMPENSADA")
        col_outros = pick_col(df, "OUTROS")
        col_boleto_ev = pick_col(df, "Boleto Hube definido para a ref. Mensal")
        col_num_conta = pick_col(df, "Número da conta")
        col_endereco = pick_col(df, "Endereço")
        col_bairro = pick_col(df, "Bairro")
        col_cidade = pick_col(df, "Cidade")
        col_custo_s_gd = pick_col(df, 'CUSTO_S_GD')
        col_fatura_c_gd = pick_col(df, 'FATURA C/GD COM RESTITUIÇÃO', 'FATURA C/GD COM RESTITUICAO')
        
        if not col_ref:
            return json.dumps({"error": "Coluna de referência (REF) não encontrada."})

        # --- CALCULATION REVISION START ---
        df_calc = df.copy()
        
        # Convert all necessary columns to numeric series first for vectorized operations
        comp_qtd_series = df_calc[col_comp_qtd].apply(to_num) if col_comp_qtd and col_comp_qtd in df_calc.columns else pd.Series([0.0]*len(df_calc), index=df_calc.index)
        tarifa_comp_ev_series = df_calc[col_tarifa_comp_ev].apply(to_num) if col_tarifa_comp_ev and col_tarifa_comp_ev in df_calc.columns else pd.Series([Fallback_Tarifa_Comp_EV]*len(df_calc), index=df_calc.index)
        valor_boleto_series = df_calc[col_boleto_ev].apply(to_num) if col_boleto_ev and col_boleto_ev in df_calc.columns else pd.Series([0.0]*len(df_calc), index=df_calc.index)
        custo_s_gd_series = df_calc[col_custo_s_gd].apply(to_num) if col_custo_s_gd and col_custo_s_gd in df_calc.columns else pd.Series([0.0]*len(df_calc), index=df_calc.index)
        fatura_c_gd_series = df_calc[col_fatura_c_gd].apply(to_num) if col_fatura_c_gd and col_fatura_c_gd in df_calc.columns else pd.Series([0.0]*len(df_calc), index=df_calc.index)

        # Determine the final value sent for billing ('valor_enviado')
        # Use the 'boleto' value if it's positive, otherwise calculate it from credits and tariff
        valor_final_series = valor_boleto_series.where(valor_boleto_series > 0, (comp_qtd_series * tarifa_comp_ev_series))

        # Correct economy calculation based on the logic from "Processador de planilha.html"
        df_calc['_econ_mes'] = (custo_s_gd_series - (fatura_c_gd_series + valor_final_series)).round(2)
        df_calc['_econ_mes'] = df_calc['_econ_mes'].clip(lower=0) # Economy cannot be negative

        # Keep the cumulative economy calculation
        if col_inst and col_ref and col_inst in df_calc.columns and col_ref in df_calc.columns:
            df_calc[col_ref] = pd.to_datetime(df_calc[col_ref], errors='coerce')
            df_calc = df_calc.sort_values(by=[col_inst, col_ref])
            df_calc['_econ_acum'] = df_calc.groupby(col_inst)['_econ_mes'].cumsum().fillna(0)
        else:
            df_calc['_econ_acum'] = df_calc['_econ_mes']
        # --- CALCULATION REVISION END ---

        df_calc[col_ref] = pd.to_datetime(df_calc[col_ref], errors="coerce")
        df_calc["_ref_month"] = df_calc[col_ref].dt.to_period("M")

        mes_referencia_dt = pd.to_datetime(mes_referencia_str)
        df_mes = df_calc[df_calc["_ref_month"] == mes_referencia_dt.to_period("M")].copy()
        
        if df_mes.empty:
            return json.dumps({"error": f"Nenhum dado para o mês {mes_referencia_str}."})
        
        clientes = []
        for _, row in df_mes.iterrows():
            # ---- Leitura básica / conversões ----
            consumo_qtd       = to_num(row.get(col_consumo_qtd, 0))
            comp_qtd          = to_num(row.get(col_comp_qtd, 0))
            tarifa_consumo    = to_num(row.get(col_tarifa_consumo, 0))
            tarifa_comp_ev    = to_num(row.get(col_tarifa_comp_ev, 0))  # tarifa usada para créditos EV
        
            # 1) Tarifa compensada da distribuidora:
            #    use a coluna "TARIFA DE ENERGIA COMPENSADA" se existir; caso contrário, caia para TARIFA_Comp_FP
            tarifa_comp_dist_raw = to_num(row.get(col_tarifa_comp_dist, None)) if col_tarifa_comp_dist else 0.0
            tarifa_comp_dist = tarifa_comp_dist_raw if tarifa_comp_dist_raw > 0 else tarifa_comp_ev
        
            # 2) Totais por item (para exibição/explicação)
            consumo_total_val     = consumo_qtd * tarifa_consumo
            comp_total_val_dist   = comp_qtd * tarifa_comp_dist   # valor "compensado" pela dist.
            
            # 3) FONTE DA VERDADE para o total da distribuidora
            fatura_dist_real = to_num(row.get(col_fatura_c_gd, 0))
        
            # 4) Ajuste de "OUTROS" para a tabela fechar com o total real:
            #    outros_balanceado = fatura_real - (consumo_total - compensado)
            dist_outros_val = fatura_dist_real - (consumo_total_val - comp_total_val_dist)
        
            # 5) Total da distribuidora a exibir na fatura (sempre o real da coluna)
            dist_total = fatura_dist_real
        
            # 6) Contribuição (EGS):
            #    Se boleto > 0, usa boleto e zera a "tarifa de referência" (para não confundir).
            #    Se boleto <= 0, usa créditos * tarifa_comp_ev.
            boleto_ev = to_num(row.get(col_boleto_ev, 0))
            if boleto_ev > 0:
                contrib_total    = boleto_ev
                det_credito_tar  = 0.0              # exibir 0 quando o total veio do boleto (evita confusão)
                det_credito_total= contrib_total
            else:
                det_credito_tar  = tarifa_comp_ev
                det_credito_total= comp_qtd * det_credito_tar
                contrib_total    = det_credito_total
        
            # 7) Quadros comparativos
            econ_total_sem = consumo_total_val + dist_outros_val    # sem GD (sem compensação)
            econ_total_com = dist_total + contrib_total             # com GD (total dist real + contribuição)
        
            # 8) Economia (já calculada antes, mantida)
            economia_mes_calc = row.get('_econ_mes', 0)
            economia_acum     = row.get('_econ_acum', economia_mes_calc)
        
            # 9) Datas e indicadores
            co2_kg        = comp_qtd * CO2_PER_KWH
            emissao_iso   = datetime.now().strftime('%Y-%m-%d')
            vencimento_iso= pd.to_datetime(vencimento_str).strftime('%Y-%m-%d')
        
            # 10) Montagem do objeto do cliente
            clientes.append({
                "nome": str(row.get(col_nome, "")),
                "documento": str(row.get(col_doc, "")),
                "endereco": "",  # sem endereço nesta pasta de trabalho
                "instalacao": str(row.get(col_inst, "")),
                "num_conta": "", # sem nº da conta nesta pasta de trabalho
                "emissao_iso": emissao_iso,
                "vencimento_iso": vencimento_iso,
        
                # EGS
                "totalPagar": contrib_total,
        
                # Indicadores
                "economiaMes": economia_mes_calc,
                "economiaTotal": economia_acum,
                "co2Evitado": co2_kg,
                "arvoresEquivalentes": (co2_kg / 1000.0) * TREES_PER_TON_CO2,
        
                # Detalhamento contribuição (EGS)
                "det_credito_qtd": comp_qtd,
                "det_credito_tar": det_credito_tar,
                "det_credito_total": det_credito_total,
        
                # Distribuidora (tabela explicativa)
                "dist_consumo_qtd": consumo_qtd,
                "dist_consumo_tar": tarifa_consumo,
                "dist_consumo_total": consumo_total_val,
                "dist_comp_qtd": comp_qtd,
                "dist_comp_tar": tarifa_comp_dist,
                "dist_comp_total": -comp_total_val_dist,       # exibir com sinal de menos
                "dist_outros": dist_outros_val,                # balanceado para fechar com o total real
                "dist_total": dist_total,                      # sempre o valor real da coluna
        
                # Comparativos
                "econ_total_sem": econ_total_sem,
                "econ_total_com": econ_total_com,
            })
        return json.dumps(clientes)
    except Exception as e:
        return json.dumps({"error": f"Erro inesperado no Python: {str(e)}"})
</script>

<script>
    const loadingOverlay = document.getElementById('loading-overlay');
    const fileUpload = document.getElementById('file-upload');
    const dropZone = document.getElementById('drop-zone');
    const fileSelectedEl = document.getElementById('file-selected');
    const mesReferenciaEl = document.getElementById('mes-referencia');
    const dataVencimentoEl = document.getElementById('data-vencimento');
    const processBtn = document.getElementById('process-btn');
    const resultList = document.getElementById('result-list');
    const emptyState = document.getElementById('empty-state');
    const downloadAllArea = document.getElementById('download-all-area');
    const searchContainer = document.getElementById('search-container');
    const searchInput = document.getElementById('search-client');
    const downloadAllBtn = document.getElementById('download-all-btn');

    let pyodide, pythonLoaded = false, selectedFile = null, clientData = [];

    async function initPyodide() {
        try {
            pyodide = await loadPyodide();
            document.getElementById('loading-status').textContent = 'Carregando pacotes...';
            await pyodide.loadPackage(['pandas', 'micropip']);
            document.getElementById('loading-status').textContent = 'Instalando dependências...';
            await pyodide.pyimport('micropip').install('openpyxl');
            pyodide.runPython(document.querySelector('script[type="text/python"]').textContent);
            pythonLoaded = true;
        } catch (e) {
             document.getElementById('loading-status').textContent = 'Falha ao carregar.';
             console.error("Erro no Pyodide:", e);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    function setActionsEnabled(enabled) {
      processBtn.disabled = !enabled;
      downloadAllBtn.disabled = !enabled;
      resultList.querySelectorAll('.generate-pdf-btn').forEach(b => b.disabled = !enabled);
    }

    function validateForm() {
        const isReady = selectedFile && mesReferenciaEl.value && dataVencimentoEl.value;
        processBtn.disabled = !isReady;
        processBtn.classList.toggle('opacity-50', !isReady);
    }

    function validateFile(file) {
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      const ALLOWED_TYPES = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
        'application/vnd.ms-excel', // .xls
        'application/vnd.ms-excel.sheet.macroEnabled.12' // .xlsm
      ];

      if (file.size > MAX_FILE_SIZE) {
        showNotification('Arquivo muito grande. O tamanho máximo permitido é 10MB.', 'error');
        return false;
      }

      if (!ALLOWED_TYPES.includes(file.type)) {
        showNotification('Tipo de arquivo inválido. Por favor, selecione um arquivo Excel (.xls, .xlsx ou .xlsm).', 'error');
        return false;
      }

      return true;
    }

    function setSelectedFile(file) {
      if (!validateFile(file)) {
        fileUpload.value = ''; // limpa o input
        return;
      }
      selectedFile = file;
      fileSelectedEl.classList.remove('hidden');
      fileSelectedEl.textContent = `${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
      validateForm();
    }
    
    function formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    function formatNumber(value, decimals = 2) { return (value || 0).toFixed(decimals).replace('.',',');}
    function safe(s=''){ return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9_\-]+/gi,'_'); }
    
    async function populateAndGeneratePdfBlob(client) {
      const refDate = new Date(mesReferenciaEl.value + '-02T00:00:00');
      const emissao = new Date(client.emissao_iso + 'T00:00:00');
      const venc = new Date(client.vencimento_iso + 'T00:00:00');
    
      const mesNome = refDate.toLocaleDateString('pt-BR', { month: 'long', timeZone: 'UTC' });
      const mesCap = mesNome.charAt(0).toUpperCase() + mesNome.slice(1);
      const tituloEl = document.getElementById('pdf-titulo-p1');
      if (tituloEl) tituloEl.textContent = `Sua contribuição de ${mesCap} chegou`;
    
      // —–––– Preenche campos (igual ao seu código) –––––
      document.getElementById('pdf-nome-cliente-p1').textContent = client.nome;
      document.getElementById('pdf-cpf-p1').textContent = `CPF/CNPJ: ${client.documento}`;
      document.getElementById('pdf-endereco-p1').textContent = client.endereco;
      document.getElementById('pdf-instalacao-p1').textContent = client.instalacao;
      document.getElementById('pdf-numconta-p1').textContent = client.num_conta || '';
      document.getElementById('pdf-emissao-p1').textContent = emissao.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
      document.getElementById('pdf-total-pagar').textContent = formatCurrency(client.totalPagar);
      document.getElementById('pdf-vencimento-p1').textContent = venc.toLocaleDateString('pt-BR', { day:'2-digit', month:'long', year:'numeric', timeZone: 'UTC' });
      document.getElementById('pdf-economia-mes').textContent = formatCurrency(client.economiaMes);
      document.getElementById('pdf-economia-acumulada').textContent = formatCurrency(client.economiaTotal);
      document.getElementById('pdf-arvores').textContent = formatNumber(client.arvoresEquivalentes);
      document.getElementById('pdf-co2').textContent = `${formatNumber(client.co2Evitado)} kg`;
    
      document.getElementById('pdf-ref-foot').textContent =
        refDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric', timeZone: 'UTC' }).replace('.', '');
      document.getElementById('pdf-valor-foot').textContent = formatCurrency(client.totalPagar);
      document.getElementById('pdf-venc-foot').textContent = venc.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
    
      document.getElementById('pdf-det-credito-qtd').textContent = formatNumber(client.det_credito_qtd);
      document.getElementById('pdf-det-credito-tar').textContent =
        (Number(client.det_credito_tar) > 0) ? formatCurrency(client.det_credito_tar) : '—';
      document.getElementById('pdf-det-credito-total').textContent = formatCurrency(client.det_credito_total);
      document.getElementById('pdf-det-total-contrib').textContent = formatCurrency(client.totalPagar);
      document.getElementById('pdf-dist-consumo-qtd').textContent = `${formatNumber(client.dist_consumo_qtd)} kWh`;
      document.getElementById('pdf-dist-consumo-tar').textContent = formatCurrency(client.dist_consumo_tar);
      document.getElementById('pdf-dist-consumo-total').textContent = formatCurrency(client.dist_consumo_total);
      document.getElementById('pdf-dist-comp-qtd').textContent = `${formatNumber(client.dist_comp_qtd)} kWh`;
      document.getElementById('pdf-dist-comp-tar').textContent = formatCurrency(client.dist_comp_tar);
      document.getElementById('pdf-dist-comp-total').textContent = `${client.dist_comp_total < 0 ? '-' : ''} ${formatCurrency(Math.abs(client.dist_comp_total))}`;
      document.getElementById('pdf-dist-outros').textContent = formatCurrency(client.dist_outros);
      document.getElementById('pdf-dist-total').textContent = formatCurrency(client.dist_total);
      document.getElementById('pdf-econ-total-sem').textContent = formatCurrency(client.econ_total_sem);
      
      // CORREÇÃO: Restaurando a demonstração do cálculo para o quadro "Se fosse só distribuidora"
      document.getElementById('pdf-econ-tarifa-dist').textContent = `${formatNumber(client.dist_consumo_tar, 6)}`;
      document.getElementById('pdf-econ-qtd-dist').textContent = `${formatNumber(client.dist_consumo_qtd)} kWh`;
      document.getElementById('pdf-econ-outros').textContent = formatCurrency(client.dist_outros);

      document.getElementById('pdf-econ-total-com').textContent = formatCurrency(client.econ_total_com);
      document.getElementById('pdf-econ-economia-final').textContent = formatCurrency(client.economiaMes);
      
      // Explicação do quadro "Com EGS"
      (function(){
        const expEl = document.getElementById('pdf-econ-exp-ev');
        const tEv   = Number(client.det_credito_tar || 0);
        const qtdEv = formatNumber(client.det_credito_qtd);
        const totDt = formatCurrency(client.dist_total);
        const totContrib = formatCurrency(client.totalPagar);
      
        if (tEv <= 0) {
          // Caso de boleto, a contribuição é o valor total do boleto
          expEl.innerHTML = `Boleto EGS ${totContrib} + Total Distribuidora ${totDt}`;
        } else {
          // Caso de cálculo por tarifa
          expEl.innerHTML = `(Tarifa R$ ${formatNumber(tEv, 6)} x Qtd. ${qtdEv}) + Total Distribuidora ${totDt}`;
        }
      })();

      // --- Resumo de economia (sem percentual) ---
      (function(){
        const semGD = Number(client.econ_total_sem || 0);      // quanto pagaria sem GD
        const comGD = Number(client.econ_total_com || 0);      // quanto pagou com GD (dist + EGS)
        const econ  = Number(client.economiaMes ?? (semGD - comGD));

        document.getElementById('pdf-econ-mes-valor').textContent = formatCurrency(econ);
        document.getElementById('pdf-econ-sem-gd').textContent    = formatCurrency(semGD);
        document.getElementById('pdf-econ-com-gd').textContent    = formatCurrency(comGD);
      })();
      // —–––– Fim do preenchimento –––––
    
      const element = document.getElementById('pdf-container');
      const filename = `Fatura_${safe(String(client.instalacao))}_${mesReferenciaEl.value}.pdf`;
      const opt = { 
        margin: 0,
        filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css','avoid-all'] }
      };

      // Nova lógica para gerar e corrigir o PDF
      const worker = html2pdf().from(element).set(opt);
      
      return new Promise(async (resolve) => {
        const pdf = await worker.toPdf().get('pdf');
        
        // Se a biblioteca gerou uma página a mais (o problema clássico), removemos a segunda.
        if (pdf.getNumberOfPages() > 1) {
          pdf.deletePage(2);
        }
        
        const blob = pdf.output('blob');
        resolve({ blob, filename });
      });
    }

    function renderClientList(clientsToRender) {
        resultList.innerHTML = '';
        if (clientsToRender.length === 0) {
            resultList.innerHTML = `<p class="text-gray-500 p-4 text-center">Nenhum cliente encontrado.</p>`;
            return;
        }
        clientsToRender.forEach((client) => {
            const clientDiv = document.createElement('div');
            clientDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
            clientDiv.innerHTML = `
                <div>
                    <p class="text-sm font-medium">${client.nome}</p>
                    <p class="text-xs text-gray-500">Instalação: ${String(client.instalacao || '')}</p>
                </div>
                <button data-instalacao="${client.instalacao}" class="btn btn-primary btn-sm generate-pdf-btn">
                    <i class="fas fa-file-pdf mr-1"></i> Gerar PDF
                </button>
            `;
            resultList.appendChild(clientDiv);
        });
    }

    processBtn.addEventListener('click', async () => {
        if (!pythonLoaded || processBtn.disabled) return;
        
        try {
            if (!selectedFile) {
                throw new Error('Nenhum arquivo selecionado.');
            }

            if (!validateFile(selectedFile)) {
                throw new Error('Arquivo inválido.');
            }
            
            setActionsEnabled(false);
            processBtn.innerHTML = '<div class="loader"></div> Processando...';
            showNotification('Iniciando processamento do arquivo...', 'info');

            const fileContent = await selectedFile.arrayBuffer();
        
            pyodide.globals.set('file_content_js', pyodide.toPy(new Uint8Array(fileContent)));
            pyodide.globals.set('mes_referencia_js', mesReferenciaEl.value + '-01');
            pyodide.globals.set('vencimento_js', dataVencimentoEl.value);
        
        const resultJson = await pyodide.runPythonAsync('processar_relatorio_para_fatura(file_content_js, mes_referencia_js, vencimento_js)');
        clientData = JSON.parse(resultJson);

        if (clientData.error) {
            resultList.innerHTML = `<p class="text-red-500 p-4">${clientData.error}</p>`;
            [searchContainer, downloadAllArea].forEach(el => el.classList.add('hidden'));
        } else if (clientData.length > 0) {
            emptyState.style.display = 'none';
            [searchContainer, downloadAllArea].forEach(el => el.classList.remove('hidden'));
            renderClientList(clientData);
        } else {
             resultList.innerHTML = `<p class="text-gray-500 p-4 text-center">Nenhum cliente para o mês.</p>`;
             [searchContainer, downloadAllArea].forEach(el => el.classList.add('hidden'));
        }
        
        processBtn.innerHTML = '<i class="fas fa-cogs mr-2"></i> Processar Relatório';
        setActionsEnabled(true);
        validateForm();
    });

    resultList.addEventListener('click', (e) => {
        const button = e.target.closest('.generate-pdf-btn');
        if (button) {
            const instalacao = button.dataset.instalacao;
            const client = clientData.find(c => String(c.instalacao) === String(instalacao));
            if (client) {
                button.disabled = true;
                button.innerHTML = '<div class="loader !w-4 !h-4 !border-2"></div>';
                populateAndGeneratePdfBlob(client).then(({blob, filename}) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                }).finally(() => {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-file-pdf mr-1"></i> Gerar PDF';
                });
            }
        }
    });
    
    function showNotification(message, type = 'error') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        const colors = {
            error: 'bg-red-100 border-red-400 text-red-700',
            success: 'bg-green-100 border-green-400 text-green-700',
            warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
            info: 'bg-blue-100 border-blue-400 text-blue-700'
        };
        
        notification.className = `${colors[type]} border px-4 py-3 rounded relative`;
        notification.innerHTML = `
            <span class="block sm:inline">${message}</span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
                <i class="fas fa-times"></i>
            </span>
        `;
        
        // Botão de fechar
        const closeButton = notification.querySelector('span:last-child');
        closeButton.onclick = () => notification.remove();
        
        // Auto-remove após 5 segundos
        container.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }

    function norm(s=''){ return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
    searchInput.addEventListener('input', (e) => {
      const q = norm(e.target.value);
      const filtered = clientData.filter(c => norm(c.nome).includes(q) || norm(String(c.instalacao)).includes(q));
      renderClientList(filtered);
    });

    downloadAllBtn.addEventListener('click', async () => {
        setActionsEnabled(false);
        downloadAllBtn.innerHTML = '<div class="loader"></div> Gerando ZIP... (0%)';

        const zip = new JSZip();
        let count = 0;

        for (const client of clientData) {
            try {
                const {blob, filename} = await populateAndGeneratePdfBlob(client);
                zip.file(filename, blob);
                count++;
                const progress = Math.round((count / clientData.length) * 100);
                downloadAllBtn.innerHTML = `<div class="loader"></div> Gerando ZIP... (${progress}%)`;
            } catch (error) {
                console.error(`Falha ao gerar PDF para ${client.nome}:`, error);
            }
        }

        zip.generateAsync({type:"blob"}).then(function(content) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `Faturas_${mesReferenciaEl.value}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }).finally(() => {
            downloadAllBtn.innerHTML = '<i class="fas fa-file-archive mr-2"></i> Baixar Todas as Faturas (ZIP)';
            setActionsEnabled(true);
        });
    });

    dropZone.addEventListener('click', () => fileUpload.click());
    fileUpload.addEventListener('change', (e) => setSelectedFile(e.target.files[0]));
    mesReferenciaEl.addEventListener('change', validateForm);
    dataVencimentoEl.addEventListener('change', validateForm);
    ['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, e => {e.preventDefault();dropZone.classList.add('drop-active');}));
    ['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, e => {e.preventDefault();dropZone.classList.remove('drop-active');}));
    dropZone.addEventListener('drop', e => setSelectedFile(e.dataTransfer.files[0]));

    document.addEventListener('DOMContentLoaded', () => {
        // Preenche os campos de data com valores padrão inteligentes
        const today = new Date();
        const refDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const previousMonth = refDate.toISOString().slice(0, 7);
        mesReferenciaEl.value = previousMonth;

        const dueDate = new Date(refDate.getFullYear(), refDate.getMonth() + 2, 10); // Dia 10 do mês seguinte ao de referência
        dataVencimentoEl.value = dueDate.toISOString().slice(0, 10);
        
        initPyodide();
        validateForm();
    });
</script>
</body>
</html>

