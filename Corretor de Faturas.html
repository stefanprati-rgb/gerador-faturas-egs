<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corretor de Faturas - EGS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
      :root {
        --brand-blue: rgb(1, 36, 74);
        --brand-green: rgb(94, 177, 86);
        --bg: #F7F8FA;
        --card: #FFFFFF;
        --line: #E7EBF0;
        --ink: #0B1220;
      }
      body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--ink); }
      .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; box-shadow: 0 1px 2px rgba(16,24,40,.04); padding: 24px; margin-bottom: 24px; }
      .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; transition: all 0.2s; }
      .btn-primary { background: var(--brand-blue); color: #fff; }
      .btn-primary:hover { background: rgb(0, 28, 58); }
      .btn-secondary { background: var(--brand-green); color: #fff; }
      .btn-secondary:hover { background: rgb(74, 147, 66); }
      .loader { border: 4px solid #e0e0e0; border-top: 4px solid var(--brand-blue); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      #drop-zone.drop-active { border-color: var(--brand-blue); background: #f0f9ff; }
      /* Estilos do Modal de Edição */
      #edit-modal-backdrop { transition: opacity 0.3s ease-in-out; }
      #edit-modal-panel { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
      .input-group label { display: block; font-size: 0.8rem; font-weight: 500; color: #4A5568; margin-bottom: 4px; }
      .input-group input { width: 100%; border: 1px solid #CBD5E0; border-radius: 6px; padding: 8px; font-size: 0.9rem; }
      .result-value { font-weight: 600; color: var(--brand-blue); }
    </style>
</head>
<body class="p-4 lg:p-8">

    <!-- Tela de Carregamento Inicial -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50">
      <div class="loader"></div>
      <p id="loading-status" class="mt-3 text-gray-700 font-semibold">Inicializando o Corretor...</p>
    </div>

    <div class="w-full max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <svg class="mx-auto mb-4 h-12 w-auto" viewBox="0 0 200 50" fill="rgb(0, 28, 58)" xmlns="http://www.w3.org/2000/svg">
                <text x="5" y="35" font-family="Poppins, sans-serif" font-size="30" font-weight="bold">EGS</text>
                <text x="65" y="35" font-family="Poppins, sans-serif" font-size="30">energia</text>
            </svg>
            <h1 class="text-4xl font-bold text-gray-800">Corretor de Faturas</h1>
            <p class="text-gray-600 mt-2">Carregue, edite e recalcule as faturas dos clientes.</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-5 gap-6">
            <!-- Coluna de Controles (Esquerda) -->
            <div class="md:col-span-2">
                <div class="card">
                    <h2 class="text-xl font-semibold">1. Carregar Relatório</h2>
                    <input id="file-upload" type="file" class="hidden" accept=".xlsx,.xlsm">
                    <div id="drop-zone" role="button" tabindex="0" class="mt-4 rounded-lg border-2 border-dashed border-gray-300 p-6 text-center text-gray-500 cursor-pointer" aria-label="Área para carregar arquivo. Clique ou arraste um arquivo para cá.">
                        <i class="fas fa-cloud-arrow-up text-3xl"></i>
                        <p class="font-semibold mt-2">Arraste e solte ou clique</p>
                    </div>
                    <p id="file-selected" class="mt-3 text-sm font-semibold text-green-700 hidden"></p>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-semibold">2. Parâmetros</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="mes-referencia" class="block text-sm font-medium text-gray-700 mb-1">Mês de Referência</label>
                            <input type="month" id="mes-referencia" class="w-full rounded-lg border border-gray-300 p-2.5">
                        </div>
                        <div>
                            <label for="data-vencimento" class="block text-sm font-medium text-gray-700 mb-1">Data de Vencimento</label>
                            <input type="date" id="data-vencimento" class="w-full rounded-lg border border-gray-300 p-2.5">
                        </div>
                    </div>
                </div>

                <button id="process-btn" class="w-full btn btn-primary text-lg py-3" disabled>
                    <i class="fas fa-cogs mr-2"></i> Processar Relatório
                </button>
            </div>

            <!-- Coluna de Resultados (Direita) -->
            <div class="md:col-span-3 card">
                <h2 class="text-xl font-semibold">3. Faturas Processadas</h2>
                <div id="search-container" class="relative mt-4 hidden">
                    <input type="text" id="search-client" placeholder="Procurar cliente por nome ou instalação..." class="w-full rounded-lg border border-gray-300 p-2 pl-10">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                </div>
                <div id="result-list" class="mt-4 space-y-2 max-h-96 overflow-y-auto">
                    <div id="empty-state" class="text-center text-gray-500 py-10">
                        <i class="fas fa-file-invoice text-3xl mb-2 text-gray-300"></i>
                        <p class="font-semibold">Aguardando processamento do relatório</p>
                    </div>
                </div>
                <div id="download-all-area" class="mt-4 hidden">
                     <button id="download-all-btn" class="w-full btn bg-gray-700 text-white hover:bg-gray-900 py-2">
                         <i class="fas fa-file-archive mr-2"></i> Baixar Todas (ZIP)
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Edição de Fatura -->
    <div id="edit-modal" class="fixed inset-0 z-40 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
      <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- Fundo do Modal -->
        <div id="edit-modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <!-- Painel do Modal -->
        <div id="edit-modal-panel" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                <i class="fas fa-pencil-alt text-blue-600"></i>
              </div>
              <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Corrigir Fatura</h3>
                <p id="modal-client-info" class="text-sm text-gray-500 mt-1">Editando dados para a instalação: [NOME]</p>
              </div>
            </div>
            
            <!-- Corpo do Modal com Inputs e Resultados -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Coluna de Inputs -->
                <div class="space-y-4 p-4 border border-gray-200 rounded-lg">
                    <h4 class="font-semibold text-gray-700 border-b pb-2">Valores Editáveis</h4>
                    <div class="input-group">
                        <label for="edit-comp_qtd">Crédito Consumido (kWh)</label>
                        <input type="number" id="edit-comp_qtd" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="edit-tarifa_comp_ev">Tarifa de Referência EGS (R$)</label>
                        <input type="number" id="edit-tarifa_comp_ev" step="0.000001">
                    </div>
                    <div class="input-group">
                        <label for="edit-boleto_ev">Boleto Fixo (R$)</label>
                        <input type="number" id="edit-boleto_ev" step="0.01">
                         <p class="text-xs text-gray-500 mt-1">Preencha se for um valor fixo. Zere para usar a tarifa.</p>
                    </div>
                    <div class="input-group">
                        <label for="edit-dist_outros">Outros Custos Distribuidora (R$)</label>
                        <input type="number" id="edit-dist_outros" step="0.01">
                    </div>
                </div>

                <!-- Coluna de Resultados -->
                <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-700 border-b pb-2">Resultados Recalculados</h4>
                    
                    <div class="text-sm">
                        <strong>Total da Contribuição EGS:</strong>
                        <span id="res-total_contribuicao" class="result-value float-right">R$ 0,00</span>
                    </div>
                     <div class="text-sm">
                        <strong>Total Fatura Distribuidora:</strong>
                        <span id="res-total_distribuidora" class="result-value float-right">R$ 0,00</span>
                    </div>
                    <hr>
                    <div class="text-lg font-bold">
                        TOTAL A PAGAR (EGS + DIST.):
                        <span id="res-total_com_gd" class="result-value float-right">R$ 0,00</span>
                    </div>
                     <div class="text-sm text-gray-600">
                        Custo se fosse só Distribuidora:
                        <span id="res-total_sem_gd" class="result-value float-right">R$ 0,00</span>
                    </div>
                    <div class="text-lg font-bold text-green-600 bg-green-100 p-2 rounded-md text-center">
                        ECONOMIA DO MÊS:
                        <span id="res-economia_mes" class="float-right">R$ 0,00</span>
                    </div>
                </div>
            </div>

          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button id="modal-save-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
              <i class="fas fa-save mr-2"></i> Salvar e Gerar PDF
            </button>
            <button id="modal-cancel-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Template Oculto para Geração do PDF (igual ao anterior) -->
    <div class="fixed -left-[9999px] top-0 opacity-0">
      <div id="pdf-container">
        <div id="pdf-page" style="width:210mm; min-height:296.8mm; background:#fff; color:#0B1220; padding:16mm 14mm; display:grid; grid-template-rows: auto auto auto auto auto auto; row-gap: 5mm; font-family:'Helvetica', Arial, sans-serif; font-size:10.5px; line-height:1.25; box-sizing:border-box; overflow:hidden;">
          <!-- O conteúdo do template do PDF permanece o mesmo do gerador original -->
           <header class="flex justify-between items-start" style="margin-bottom:0;">
            <div style="display:flex; flex-direction:column; gap:4mm; max-width:120mm;">
              <div style="font-weight:700; font-size:34px; letter-spacing:0.5px; text-align:left;">
                <span style="color: var(--brand-blue);">EGS</span>
                <span style="color: var(--brand-green);"> energia</span>
              </div>
              <div id="pdf-titulo-p1" style="font-weight:600; font-size:13px; text-align:left;">
                Sua contribuição de [Mês] chegou
              </div>
            </div>
            <div class="text-right" style="font-size:10px; max-width:72mm;">
              <p id="pdf-nome-cliente-p1" class="font-bold" style="font-size:12px;">[Nome Cliente]</p>
              <p id="pdf-cpf-p1" class="text-gray-600">[CPF/CNPJ]</p>
              <p id="pdf-endereco-p1" class="text-gray-600">[Endereço]</p>
              <p class="mt-1">Código Instalação: <span id="pdf-instalacao-p1" class="font-bold">[Instalação]</span></p>
              <p>Emissão: <span id="pdf-emissao-p1" class="font-bold">[Emissão]</span></p>
            </div>
          </header>
            <section style="display:grid; grid-template-columns: 1.2fr 1fr; gap:6mm; align-items:stretch;">
              <div class="p-6 rounded-xl" style="background:var(--brand-blue); color:#fff;">
                <p style="font-size:12px;">Total a pagar</p>
                <p id="pdf-total-pagar" class="font-bold" style="font-size:40px; margin:6px 0 8px;">R$ 0,00</p>
                <p style="font-size:10px;">Data de vencimento</p>
                <p id="pdf-vencimento-p1" style="font-size:12px; font-weight:600;">[Data]</p>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5mm;">
                <div class="p-3 rounded-lg" style="background:var(--brand-blue); color:#fff;">
                  <p id="pdf-economia-mes" class="font-bold" style="font-size:16px;">R$ 0,00</p>
                  <p style="opacity:.9;">Economia Mês</p>
                </div>
                <div class="p-3 rounded-lg" style="background:var(--brand-blue); color:#fff;">
                  <p id="pdf-economia-acumulada" class="font-bold" style="font-size:16px;">R$ 0,00</p>
                  <p style="opacity:.9;">Economia acumulada</p>
                </div>
                <div class="p-3 rounded-lg" style="background:var(--brand-blue); color:#fff;">
                  <p id="pdf-arvores" class="font-bold" style="font-size:16px;">0,00</p>
                  <p style="opacity:.9;">Árvores preservadas</p>
                </div>
                <div class="p-3 rounded-lg" style="background:var(--brand-blue); color:#fff;">
                  <p id="pdf-co2" class="font-bold" style="font-size:16px;"></p>
                  <p style="opacity:.9;">CO2 poupados</p>
                </div>
              </div>
            </section>
            <section id="pdf-resumo-economia" style="margin:0;">
              <div class="rounded-lg" style="background:#F3F4F6; padding:8px 10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700; font-size:12px;">Resumo da sua economia</div>
                  <div style="text-align:right;">
                    <div id="pdf-econ-mes-valor" style="font-size:18px; font-weight:800; color:var(--brand-green);">
                      R$ 0,00
                    </div>
                    <div style="font-size:10px; color:#374151; margin-top:2px;">
                      Sem GD: <span id="pdf-econ-sem-gd">R$ 0,00</span> &nbsp; • &nbsp;
                      Com GD: <span id="pdf-econ-com-gd">R$ 0,00</span>
                    </div>
                  </div>
                </div>
              </div>
            </section>
            <section style="display:grid; grid-template-columns: 1fr 1fr; gap:6mm; font-size:10px;">
              <div>
                <h2 class="font-bold" style="font-size:11px; margin-bottom:2mm;">Como calculamos sua contribuição</h2>
                <table class="w-full" style="width:100%; border-collapse:collapse;">
                  <thead>
                    <tr style="border-bottom:1px solid #D1D5DB;">
                      <th class="text-left" style="padding:6px 4px;">Descrição</th>
                      <th class="text-right" style="padding:6px 4px;">Quantidade</th>
                      <th class="text-right" style="padding:6px 4px;">Tarifa de referência</th>
                      <th class="text-right" style="padding:6px 4px;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td id="pdf-det-credito-label" style="padding:5px 4px;">Crédito de Energia</td>
                      <td id="pdf-det-credito-qtd" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td id="pdf-det-credito-tar" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td id="pdf-det-credito-total" class="text-right" style="padding:5px 4px; font-weight:600; white-space:nowrap;"></td>
                    </tr>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Desconto extra</td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;">0,00</td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;">R$ 0,00</td>
                      <td class="text-right" style="padding:5px 4px; font-weight:600; white-space:nowrap;">R$ 0,00</td>
                    </tr>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Ajuste retroativo</td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td class="text-right" style="padding:5px 4px; font-weight:600; white-space:nowrap;">R$ 0,00</td>
                    </tr>
                    <tr style="background:#F3F4F6;">
                      <td style="padding:5px 4px; font-weight:700;">Total da sua contribuição</td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td id="pdf-det-total-contrib" class="text-right" style="padding:5px 4px; font-weight:700; white-space:nowrap;"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div>
                <h2 class="font-bold" style="font-size:11px; margin-bottom:2mm;">Como ficou sua conta da distribuidora</h2>
                <table class="w-full" style="width:100%; border-collapse:collapse;">
                  <thead>
                    <tr style="border-bottom:1px solid #D1D5DB;">
                      <th class="text-left" style="padding:6px 4px; font-weight:600;">Descrição</th>
                      <th class="text-right" style="padding:6px 4px; font-weight:600;">Quantidade</th>
                      <th class="text-right" style="padding:6px 4px; font-weight:600;">Tarifa</th>
                      <th class="text-right" style="padding:6px 4px; font-weight:600;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Energia Consumida</td>
                      <td id="pdf-dist-consumo-qtd" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td id="pdf-dist-consumo-tar" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td id="pdf-dist-consumo-total" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                    </tr>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Energia Compensada</td>
                      <td id="pdf-dist-comp-qtd" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td id="pdf-dist-comp-tar" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td id="pdf-dist-comp-total" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                    </tr>
                    <tr style="border-bottom:1px solid #E5E7EB;">
                      <td style="padding:5px 4px;">Contrib. Ilum. Pública e Outros</td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td id="pdf-dist-outros" class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                    </tr>
                    <tr style="background:#F3F4F6;">
                      <td style="padding:5px 4px; font-weight:700;">Total a pagar na sua fatura da distribuidora</td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td class="text-right" style="padding:5px 4px; white-space:nowrap;"></td>
                      <td id="pdf-dist-total" class="text-right" style="padding:5px 4px; font-weight:700; white-space:nowrap;"></td>
                    </tr>
                  </tbody></table>
              </div>
            </section>
            <section style="margin:0;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6mm;">
                <div class="rounded-lg" style="background:#F3F4F6; padding:10px; display:flex; justify-content:space-between; align-items:baseline;">
                  <div class="font-bold">Se fosse só distribuidora</div>
                  <div class="text-right">
                    <span id="pdf-econ-total-sem" class="font-bold" style="font-size:12px;">R$ 0,00</span><br>
                    <span class="text-gray-600">(Tarifa <span id="pdf-econ-tarifa-dist"></span> x Qtd. <span id="pdf-econ-qtd-dist"></span>) + Outros <span id="pdf-econ-outros"></span></span>
                  </div>
                </div>
                <div class="rounded-lg" style="background:#F3F4F6; padding:10px; display:flex; justify-content:space-between; align-items:baseline;">
                  <div class="font-bold">Com EGS</div>
                  <div class="text-right">
                    <span id="pdf-econ-total-com" class="font-bold" style="font-size:12px;">R$ 0,00</span><br>
                    <span id="pdf-econ-exp-ev" class="text-gray-600"></span>
                  </div>
                </div>
              </div>
            </section>
            <footer style="margin-top:0; font-size:14px; color:#6B7280; text-align:center;">
                <div id="pdf-footer-warning" class="rounded-lg font-bold" style="display:inline-block; background: var(--brand-green); color: #000; margin-bottom: 6px; padding: 10px 16px;">
                    Atenção! Você ainda precisa pagar a conta da distribuidora.
                </div>
                 <div style="display:grid; grid-template-columns: 1fr; gap:4mm;">
                    <div>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                        <tr style="border-bottom:1px solid #D1D5DB;">
                            <th class="text-center" style="padding:6px 4px; font-weight:600;">Referência</th>
                            <th class="text-center" style="padding:6px 4px; font-weight:600;">Valor</th>
                            <th class="text-center" style="padding:6px 4px; font-weight:600;">Vencimento</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td id="pdf-ref-foot" style="padding:5px 4px;">[Ref]</td>
                            <td id="pdf-valor-foot" style="padding:5px 4px;">[Valor]</td>
                            <td id="pdf-venc-foot" style="padding:5px 4px;">[Venc]</td>
                        </tr>
                        </tbody>
                    </table>
                    </div>
                </div>
                <div style="margin-top:4mm;">
                    <div class="rounded-lg" style="background:#F3F4F6; padding:8px 10px; display:flex; align-items:center; gap:14px; flex-wrap:wrap; justify-content:center;">
                    <div style="display:flex; align-items:center; gap:6px; font-size:10.5px; color:#0B1220;">
                        <i class="fa-solid fa-envelope" aria-hidden="true" style="font-size:12px; color: var(--brand-color-darker);"></i>
                        <span><strong>E-mail:</strong> atendimento@egsenergia.com.br</span>
                    </div>
                    <div style="width:1px; height:14px; background:#D1D5DB;"></div>
                    <div style="display:flex; align-items:center; gap:6px; font-size:10.5px; color:#0B1220;">
                        <i class="fa-brands fa-whatsapp" aria-hidden="true" style="font-size:12px; color:var(--brand-green);"></i>
                        <span><strong>WhatsApp:</strong> (11) 99670-3826</span>
                    </div>
                    </div>
                </div>
            </footer>
        </div>
      </div>
    </div>

<!-- O script Python permanece o mesmo para o processamento inicial -->
<script type="text/python">
import pandas as pd
import io, re, json, unicodedata
from datetime import datetime

# =========================
# Constantes do domínio
# =========================
CO2_PER_KWH = 0.07
TREES_PER_TON_CO2 = 8
FALLBACK_TARIFA_DIST = 0.916370
FALLBACK_TARIFA_COMP_EV = 0.716045

# =========================
# Utils: parsing e normalização
# =========================
def _norm(s: str) -> str:
    s = str(s or "")
    s = "".join(c for c in unicodedata.normalize("NFD", s) if unicodedata.category(c) != "Mn")
    return re.sub(r"\s+", " ", s).strip().upper()

def parse_brl_number(x) -> float:
    if pd.isna(x): return 0.0
    if isinstance(x, (int, float)): return float(x)
    s = str(x).strip()
    if not s or s in ['—', '--']: return 0.0
    s = re.sub(r"[Rr]\$\s?", "", s).replace(".", "").replace(",", ".")
    try: return float(s)
    except (ValueError, TypeError): return 0.0

def safe_parse_date_column(series):
    def parse_single(val):
        if pd.isna(val): return pd.NaT
        if isinstance(val, (int, float)):
            try: return pd.Timestamp('1899-12-30') + pd.Timedelta(days=val)
            except: return pd.NaT
        try: return pd.to_datetime(str(val)[:10], errors='coerce')
        except: return pd.NaT
    return series.apply(parse_single)

def month_period(dt: datetime):
    return pd.to_datetime(dt).to_period("M") if pd.notna(dt) else None

# =========================
# Utils: colunas e planilha
# =========================
def find_sheet_and_header(xls: pd.ExcelFile, key_cols, prefer_name=None, max_rows=30):
    sheet_names = list(xls.sheet_names)
    if prefer_name and prefer_name in sheet_names:
        sheet_names.insert(0, sheet_names.pop(sheet_names.index(prefer_name)))
    for sheet_name in sheet_names:
        try:
            df_sample = pd.read_excel(xls, sheet_name=sheet_name, header=None, nrows=max_rows)
            for i, row in df_sample.iterrows():
                row_as_string = " ".join(str(v) for v in row.dropna().values)
                if all(k in row_as_string for k in key_cols):
                    return sheet_name, i
        except Exception:
            continue
    return None, -1

def pick_col(df: pd.DataFrame, *alternativas) -> str|None:
    cols_norm = {_norm(c): c for c in df.columns}
    for alt in alternativas:
        key = _norm(alt)
        if key in cols_norm: return cols_norm[key]
    for k, original in cols_norm.items():
        for alt in alternativas:
            if re.search(rf"\b{re.escape(_norm(alt))}\b", k): return original
    return None

# =========================
# Pipeline principal
# =========================
def processar_relatorio_para_fatura(file_content, mes_referencia_str, vencimento_str):
    try:
        xls = pd.ExcelFile(io.BytesIO(file_content), engine='openpyxl')

        aba_consumo, header_consumo = find_sheet_and_header(xls, ["REF", "Instalação", "CRÉD. CONSUMIDO_FP"], prefer_name="Detalhe Por UC")
        if not aba_consumo or header_consumo < 0:
            return json.dumps({"error": "Aba com dados de consumo não encontrada. Verifique se as colunas 'REF', 'Instalação' e 'CRÉD. CONSUMIDO_FP' existem."})

        df = pd.read_excel(xls, sheet_name=aba_consumo, header=header_consumo)
        df.columns = [str(c).strip() for c in df.columns]

        def col(*alts): return pick_col(df, *alts)
        
        cols_map = {
            'ref': col("REF (sempre dia 01 de cada mês)", "REF"),
            'inst': col("Instalação", "Nº Instalação"),
            'nome': col("Nome Cliente", "Nome/Razão Social"),
            'doc': col("Documento", "CPF/CNPJ"),
            'consumo_qtd': col("CONSUMO_FP"),
            'comp_qtd': col("CRÉD. CONSUMIDO_FP"),
            'tarifa_consumo': col("TARIFA FP"),
            'tarifa_comp_ev': col("TARIFA_Comp_FP"),
            'tarifa_comp_dist': col("TARIFA DE ENERGIA COMPENSADA"),
            'boleto_ev': col("Boleto Hube definido para a ref. Mensal"),
            'endereco': col("Endereço"), 'bairro': col("Bairro"), 'cidade': col("Cidade"),
            'custo_s_gd': col("CUSTO_S_GD"),
            'fatura_c_gd': col("FATURA C/GD COM RESTITUIÇÃO", "FATURA C/GD COM RESTITUICAO"),
        }

        required_cols = ['ref', 'inst', 'nome', 'consumo_qtd', 'comp_qtd']
        missing = [k for k, v in cols_map.items() if k in required_cols and not v]
        if missing:
            return json.dumps({"error": f"Colunas essenciais não encontradas: {', '.join(missing)}"})

        df_calc = df.copy()
        
        # Filtro do mês de referência
        mes_dt = safe_parse_date_column(pd.Series([mes_referencia_str]))[0]
        df_calc[cols_map['ref']] = safe_parse_date_column(df_calc[cols_map['ref']])
        df_calc["_ref_month"] = df_calc[cols_map['ref']].dt.to_period("M")
        df_mes = df_calc[df_calc["_ref_month"] == month_period(mes_dt)].copy()
        
        if df_mes.empty:
            return json.dumps({"error": f"Nenhum dado encontrado para o mês {mes_referencia_str}."})

        venc_iso = safe_parse_date_column(pd.Series([vencimento_str]))[0].strftime('%Y-%m-%d')
        emissao_iso = datetime.now().strftime('%Y-%m-%d')
        
        clientes = []
        for _, row in df_mes.iterrows():
            # Apenas extrai os dados brutos. O cálculo será feito no JavaScript.
            endereco_parts = [str(row.get(cols_map[k], '') or '') for k in ['endereco', 'bairro', 'cidade']]
            
            # Valores que não mudam com a edição
            cliente_base = {
                "nome": str(row.get(cols_map['nome'], "")),
                "documento": str(row.get(cols_map['doc'], "")),
                "endereco": ' '.join(filter(None, endereco_parts)).strip(),
                "instalacao": str(row.get(cols_map['inst'], "")),
                "emissao_iso": emissao_iso,
                "vencimento_iso": venc_iso,
                 # Dados brutos para cálculo no JS
                "_raw": {
                  "consumo_qtd": parse_brl_number(row.get(cols_map['consumo_qtd'])),
                  "comp_qtd": parse_brl_number(row.get(cols_map['comp_qtd'])),
                  "tarifa_consumo": parse_brl_number(row.get(cols_map['tarifa_consumo'], FALLBACK_TARIFA_DIST)),
                  "tarifa_comp_dist": parse_brl_number(row.get(cols_map['tarifa_comp_dist'], FALLBACK_TARIFA_COMP_EV)),
                  "tarifa_comp_ev": parse_brl_number(row.get(cols_map['tarifa_comp_ev'], FALLBACK_TARIFA_COMP_EV)),
                  "boleto_ev": parse_brl_number(row.get(cols_map['boleto_ev'])),
                  "fatura_c_gd": parse_brl_number(row.get(cols_map['fatura_c_gd'])),
                  "custo_s_gd": parse_brl_number(row.get(cols_map['custo_s_gd'])),
                }
            }
            # Garante que tarifas tenham um fallback se forem zero
            if cliente_base["_raw"]["tarifa_consumo"] <= 0: cliente_base["_raw"]["tarifa_consumo"] = FALLBACK_TARIFA_DIST
            if cliente_base["_raw"]["tarifa_comp_dist"] <= 0: cliente_base["_raw"]["tarifa_comp_dist"] = FALLBACK_TARIFA_COMP_EV
            if cliente_base["_raw"]["tarifa_comp_ev"] <= 0: cliente_base["_raw"]["tarifa_comp_ev"] = FALLBACK_TARIFA_COMP_EV

            clientes.append(cliente_base)

        return json.dumps(clientes)

    except Exception as e:
        import traceback
        return json.dumps({"error": f"Erro inesperado no Python: {traceback.format_exc()}"})

</script>

<script>
    // --- MÓDULO DE CÁLCULO (JavaScript) ---
    // Recria a lógica de cálculo do Python para reatividade instantânea no front-end.
    function recalculateInvoice(clientData) {
        const d = { ...clientData }; // Cria uma cópia para não modificar o objeto original
        const raw = d._raw;
        
        // CORREÇÃO: Se o cliente ainda não foi editado, inicializa o objeto _editor com os valores originais do relatório.
        // Este bloco previne o erro "Cannot read properties of undefined" que causava a falha grave.
        if (!d._editor) {
            const consumo_total_val_inicial = raw.consumo_qtd * raw.tarifa_consumo;
            const comp_total_val_dist_inicial = raw.comp_qtd * raw.tarifa_comp_dist;
            // Calcula o valor inicial de "outros" com base na fatura real da distribuidora
            const dist_outros_inicial = Math.max(0, raw.fatura_c_gd - (consumo_total_val_inicial - comp_total_val_dist_inicial));
            
            d._editor = {
                comp_qtd: raw.comp_qtd,
                tarifa_comp_ev: raw.tarifa_comp_ev,
                boleto_ev: raw.boleto_ev,
                dist_outros: parseFloat(dist_outros_inicial.toFixed(2)) // Arredonda para 2 casas decimais
            };
        }
        
        const editor = d._editor; // Dados modificados pelo usuário (agora garantido que existe)

        const comp_qtd = editor.comp_qtd;
        const consumo_qtd = raw.consumo_qtd;
        const tarifa_cons = raw.tarifa_consumo;
        const tarifa_comp_dist = raw.tarifa_comp_dist;
        
        // Lógica da contribuição EGS
        let det_credito_total, det_credito_tar;
        if (editor.boleto_ev > 0) {
            det_credito_total = editor.boleto_ev;
            det_credito_tar = (comp_qtd > 0) ? editor.boleto_ev / comp_qtd : 0;
        } else {
            det_credito_total = comp_qtd * editor.tarifa_comp_ev;
            det_credito_tar = editor.tarifa_comp_ev;
        }

        // Lógica da fatura da distribuidora
        const consumo_total_val = consumo_qtd * tarifa_cons;
        const comp_total_val_dist = comp_qtd * tarifa_comp_dist;
        const dist_total = consumo_total_val - comp_total_val_dist + editor.dist_outros;

        // Lógica da Economia
        const econ_total_com = dist_total + det_credito_total;
        const econ_total_sem = consumo_total_val + editor.dist_outros;
        const economiaMes = Math.max(0, econ_total_sem - econ_total_com);
        
        // Impactos ambientais
        const co2_kg = comp_qtd * 0.07;
        const arvores = (co2_kg / 1000.0) * 8;
        
        // Retorna um objeto completo com todos os valores calculados
        return {
            ...d, // Mantém dados base como nome, instalação, etc.
            totalPagar: det_credito_total,
            economiaMes: economiaMes,
            co2Evitado: co2_kg,
            arvoresEquivalentes: arvores,
            // Detalhes para o PDF
            det_credito_qtd: comp_qtd,
            det_credito_tar: det_credito_tar,
            det_credito_total: det_credito_total,
            dist_consumo_qtd: consumo_qtd,
            dist_consumo_tar: tarifa_cons,
            dist_consumo_total: consumo_total_val,
            dist_comp_qtd: comp_qtd,
            dist_comp_tar: tarifa_comp_dist,
            dist_comp_total: -comp_total_val_dist,
            dist_outros: editor.dist_outros,
            dist_total: dist_total,
            econ_total_sem: econ_total_sem,
            econ_total_com: econ_total_com,
            // Mantemos a economia total (acumulada) do processamento original, pois não podemos recalcular o histórico.
            economiaTotal: d.economiaTotal || economiaMes 
        };
    }

    // --- MÓDULO PRINCIPAL (APP.JS) ---
    // Elementos da UI
    const loadingOverlay = document.getElementById('loading-overlay');
    const fileUpload = document.getElementById('file-upload');
    const dropZone = document.getElementById('drop-zone');
    const fileSelectedEl = document.getElementById('file-selected');
    const mesReferenciaEl = document.getElementById('mes-referencia');
    const dataVencimentoEl = document.getElementById('data-vencimento');
    const processBtn = document.getElementById('process-btn');
    const resultList = document.getElementById('result-list');
    const emptyState = document.getElementById('empty-state');
    const downloadAllArea = document.getElementById('download-all-area');
    const searchContainer = document.getElementById('search-container');
    const searchInput = document.getElementById('search-client');
    const downloadAllBtn = document.getElementById('download-all-btn');

    // Elementos do Modal
    const modal = document.getElementById('edit-modal');
    const modalClientInfo = document.getElementById('modal-client-info');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    
    // Inputs do Modal
    const inputs = {
        comp_qtd: document.getElementById('edit-comp_qtd'),
        tarifa_comp_ev: document.getElementById('edit-tarifa_comp_ev'),
        boleto_ev: document.getElementById('edit-boleto_ev'),
        dist_outros: document.getElementById('edit-dist_outros'),
    };
    
    // Resultados do Modal
    const results = {
        total_contribuicao: document.getElementById('res-total_contribuicao'),
        total_distribuidora: document.getElementById('res-total_distribuidora'),
        total_com_gd: document.getElementById('res-total_com_gd'),
        total_sem_gd: document.getElementById('res-total_sem_gd'),
        economia_mes: document.getElementById('res-economia_mes'),
    };

    // Estado da Aplicação
    let pyodide = null;
    let selectedFile = null;
    let clientData = [];
    let currentEditingClient = null;

    // --- Funções Utilitárias ---
    function formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    function norm(s=''){ return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
    function toast(msg, type='info') {
      const t = document.createElement('div');
      const colors = { info: 'bg-blue-600', success: 'bg-green-600', error: 'bg-red-600'};
      t.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white ${colors[type] || 'bg-gray-800'}`;
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 4000);
    }

    // --- Lógica de Inicialização ---
    async function initPyodide() {
        if (pyodide) return pyodide;
        try {
            loadingOverlay.style.display = 'flex';
            pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/' });
            await pyodide.loadPackage(['pandas', 'micropip']);
            const micropip = pyodide.pyimport('micropip');
            await micropip.install('openpyxl');
            pyodide.runPython(document.querySelector('script[type="text/python"]').textContent);
            return pyodide;
        } catch (e) {
            console.error('Erro no Pyodide:', e);
            toast('Falha ao inicializar o ambiente de processamento.', 'error');
            throw e;
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    // --- Lógica de UI Principal ---
    function validateForm() {
        const isReady = selectedFile && mesReferenciaEl.value && dataVencimentoEl.value;
        processBtn.disabled = !isReady;
        processBtn.classList.toggle('opacity-50', !isReady);
    }

    function setSelectedFile(file) {
      if (!file) return;
      selectedFile = file;
      fileSelectedEl.classList.remove('hidden');
      fileSelectedEl.textContent = `${file.name}`;
      validateForm();
    }
    
    function renderClientList(clientsToRender = clientData) {
        if (clientData.length === 0) {
            emptyState.style.display = 'block';
            [searchContainer, downloadAllArea].forEach(el => el.classList.add('hidden'));
            resultList.innerHTML = '';
            return;
        }

        emptyState.style.display = 'none';
        [searchContainer, downloadAllArea].forEach(el => el.classList.remove('hidden'));
        
        const total = clientData.length;
        const soma = clientData.reduce((a,c)=>a + (c.totalPagar || 0), 0);
        let html = `<div class="p-2 bg-blue-50 border border-blue-200 rounded mb-2 text-sm">
            <strong>${total}</strong> fatura(s) processada(s) • Total a faturar: <strong>${formatCurrency(soma)}</strong>
        </div>`;

        clientsToRender.forEach((client) => {
            html += `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm">
                <div>
                    <p class="text-sm font-medium">${client.nome}</p>
                    <p class="text-xs text-gray-500">Instalação: ${client.instalacao} | Total: <strong>${formatCurrency(client.totalPagar)}</strong></p>
                </div>
                <button data-instalacao="${client.instalacao}" class="btn btn-secondary btn-sm edit-btn">
                    <i class="fas fa-pencil-alt mr-1"></i> Corrigir
                </button>
            </div>`;
        });
        resultList.innerHTML = html;
    }

    // --- Lógica do Modal de Edição ---
    function updateEditorResults() {
        const editorValues = {
            comp_qtd: parseFloat(inputs.comp_qtd.value) || 0,
            tarifa_comp_ev: parseFloat(inputs.tarifa_comp_ev.value) || 0,
            boleto_ev: parseFloat(inputs.boleto_ev.value) || 0,
            dist_outros: parseFloat(inputs.dist_outros.value) || 0,
        };
        
        currentEditingClient._editor = editorValues;
        const recalculated = recalculateInvoice(currentEditingClient);
        
        results.total_contribuicao.textContent = formatCurrency(recalculated.totalPagar);
        results.total_distribuidora.textContent = formatCurrency(recalculated.dist_total);
        results.total_com_gd.textContent = formatCurrency(recalculated.econ_total_com);
        results.total_sem_gd.textContent = formatCurrency(recalculated.econ_total_sem);
        results.economia_mes.textContent = formatCurrency(recalculated.economiaMes);
    }
    
    function openEditModal(client) {
        currentEditingClient = JSON.parse(JSON.stringify(client)); // Deep copy

        modalClientInfo.textContent = `Editando dados para: ${currentEditingClient.nome} (${currentEditingClient.instalacao})`;
        
        // Popula os inputs com os valores atuais do editor
        inputs.comp_qtd.value = currentEditingClient._editor.comp_qtd;
        inputs.tarifa_comp_ev.value = currentEditingClient._editor.tarifa_comp_ev;
        inputs.boleto_ev.value = currentEditingClient._editor.boleto_ev;
        inputs.dist_outros.value = currentEditingClient._editor.dist_outros;
        
        updateEditorResults(); // Faz o cálculo inicial e exibe
        modal.classList.remove('hidden');
    }

    function closeEditModal() {
        modal.classList.add('hidden');
        currentEditingClient = null;
    }

    function saveAndGenerate() {
        if (!currentEditingClient) return;
        
        // Aplica os valores do editor e recalcula final
        currentEditingClient._editor.comp_qtd = parseFloat(inputs.comp_qtd.value) || 0;
        currentEditingClient._editor.tarifa_comp_ev = parseFloat(inputs.tarifa_comp_ev.value) || 0;
        currentEditingClient._editor.boleto_ev = parseFloat(inputs.boleto_ev.value) || 0;
        currentEditingClient._editor.dist_outros = parseFloat(inputs.dist_outros.value) || 0;

        const finalClientData = recalculateInvoice(currentEditingClient);

        // Atualiza o dado na lista principal
        const index = clientData.findIndex(c => c.instalacao === finalClientData.instalacao);
        if (index !== -1) {
            clientData[index] = finalClientData;
        }

        renderClientList(); // Re-renderiza a lista para mostrar o valor atualizado
        toast('Fatura corrigida com sucesso!', 'success');
        
        // Gera o PDF com os dados corrigidos
        const btn = modalSaveBtn;
        btn.disabled = true;
        btn.innerHTML = '<div class="loader !w-4 !h-4 !border-2"></div> Gerando...';
        
        // Utiliza o gerador de PDF existente, que será importado
        populateAndGeneratePdfBlob(finalClientData, mesReferenciaEl.value).then(({blob, filename}) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }).catch(err => {
            console.error(`Falha ao gerar PDF para ${finalClientData.nome}:`, err);
            toast(`Não foi possível gerar o PDF.`, 'error');
        }).finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar e Gerar PDF';
            closeEditModal();
        });
    }

    // --- Event Listeners ---
    processBtn.addEventListener('click', async () => {
        if (processBtn.disabled) return;
        processBtn.innerHTML = '<div class="loader"></div> Processando...';
        try {
            await initPyodide();
            const fileContent = await selectedFile.arrayBuffer();
            pyodide.globals.set('file_content_js', pyodide.toPy(new Uint8Array(fileContent)));
            pyodide.globals.set('mes_referencia_js', mesReferenciaEl.value);
            pyodide.globals.set('vencimento_js', dataVencimentoEl.value);
            
            const resultJson = await pyodide.runPythonAsync('processar_relatorio_para_fatura(file_content_js, mes_referencia_js, vencimento_js)');
            const result = JSON.parse(resultJson);

            if (result.error) {
                toast(`Erro: ${result.error}`, 'error');
                clientData = [];
            } else {
                // Roda o cálculo inicial em JS para cada cliente
                clientData = result.map(client => recalculateInvoice(client));
                toast(`Relatório processado com ${clientData.length} faturas.`, 'success');
            }
        } catch (e) {
            toast("Falha grave ao processar o arquivo.", 'error');
        } finally {
            renderClientList();
            processBtn.innerHTML = '<i class="fas fa-cogs mr-2"></i> Processar Relatório';
            validateForm();
        }
    });

    resultList.addEventListener('click', (e) => {
        const button = e.target.closest('.edit-btn');
        if (!button) return;
        const instalacao = button.dataset.instalacao;
        const client = clientData.find(c => c.instalacao === instalacao);
        if (client) openEditModal(client);
    });
    
    searchInput.addEventListener('input', (e) => {
      const q = norm(e.target.value);
      const filtered = clientData.filter(c => norm(c.nome).includes(q) || norm(c.instalacao).includes(q));
      renderClientList(filtered);
    });

    // Event Listeners do Modal
    modalCancelBtn.addEventListener('click', closeEditModal);
    modalSaveBtn.addEventListener('click', saveAndGenerate);
    Object.values(inputs).forEach(input => {
        input.addEventListener('input', updateEditorResults);
    });

    // Listeners de Upload
    dropZone.addEventListener('click', () => fileUpload.click());
    fileUpload.addEventListener('change', (e) => setSelectedFile(e.target.files[0]));
    ['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, e => {e.preventDefault();dropZone.classList.add('drop-active');}));
    ['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, e => {e.preventDefault();dropZone.classList.remove('drop-active');}));
    dropZone.addEventListener('drop', e => setSelectedFile(e.dataTransfer.files[0]));
    
    // Setup inicial da página
    document.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        mesReferenciaEl.value = `${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`; // Mês anterior
        dataVencimentoEl.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-10`;
        [mesReferenciaEl, dataVencimentoEl].forEach(el => el.addEventListener('change', validateForm));
        initPyodide();
        validateForm();
    });

    // --- Lógica de Geração de PDF (reutilizada) ---
    // A função populateAndGeneratePdfBlob é grande e idêntica à do Gerador.
    // Para manter o código limpo, vamos declará-la aqui.
    async function populateAndGeneratePdfBlob(client, mesReferencia) {
        // Esta função é EXATAMENTE a mesma do script anterior.
        // Ela pega um objeto 'client' já calculado e preenche o template HTML.
        const element = document.getElementById('pdf-page');
        const [y, m] = mesReferencia.split('-').map(Number);
        const refDate = new Date(y, m - 1, 1);
        const mesNome = refDate.toLocaleDateString('pt-BR', { month: 'long' });
        
        document.getElementById('pdf-titulo-p1').textContent = `Sua contribuição de ${mesNome.charAt(0).toUpperCase() + mesNome.slice(1)} chegou`;
        document.getElementById('pdf-nome-cliente-p1').textContent = client.nome;
        document.getElementById('pdf-cpf-p1').textContent = `CPF/CNPJ: ${client.documento}`;
        document.getElementById('pdf-endereco-p1').textContent = client.endereco;
        document.getElementById('pdf-instalacao-p1').textContent = client.instalacao;
        document.getElementById('pdf-emissao-p1').textContent = new Date(`${client.emissao_iso}T12:00:00`).toLocaleDateString('pt-BR');
        document.getElementById('pdf-total-pagar').textContent = formatCurrency(client.totalPagar);
        document.getElementById('pdf-vencimento-p1').textContent = new Date(`${client.vencimento_iso}T12:00:00`).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

        document.getElementById('pdf-economia-mes').textContent = formatCurrency(client.economiaMes);
        document.getElementById('pdf-economia-acumulada').textContent = formatCurrency(client.economiaTotal);
        document.getElementById('pdf-arvores').textContent = (client.arvoresEquivalentes || 0).toFixed(2).replace('.',',');
        document.getElementById('pdf-co2').textContent = `${(client.co2Evitado || 0).toFixed(2).replace('.',',')} kg CO₂`;

        document.getElementById('pdf-det-credito-qtd').textContent = (client.det_credito_qtd || 0).toFixed(2).replace('.',',');
        document.getElementById('pdf-det-credito-tar').textContent = formatCurrency(client.det_credito_tar || 0, 6);
        document.getElementById('pdf-det-credito-total').textContent = formatCurrency(client.det_credito_total);
        document.getElementById('pdf-det-total-contrib').textContent = formatCurrency(client.totalPagar);

        document.getElementById('pdf-dist-consumo-qtd').textContent = `${(client.dist_consumo_qtd || 0).toFixed(2).replace('.',',')} kWh`;
        document.getElementById('pdf-dist-consumo-tar').textContent = formatCurrency(client.dist_consumo_tar || 0, 6);
        document.getElementById('pdf-dist-consumo-total').textContent = formatCurrency(client.dist_consumo_total);
        document.getElementById('pdf-dist-comp-qtd').textContent = `${(client.dist_comp_qtd || 0).toFixed(2).replace('.',',')} kWh`;
        document.getElementById('pdf-dist-comp-tar').textContent = formatCurrency(client.dist_comp_tar || 0, 6);
        document.getElementById('pdf-dist-comp-total').textContent = (client.dist_comp_total > 0 ? '' : '- ') + formatCurrency(Math.abs(client.dist_comp_total || 0));
        document.getElementById('pdf-dist-outros').textContent = formatCurrency(client.dist_outros);
        document.getElementById('pdf-dist-total').textContent = formatCurrency(client.dist_total);

        document.getElementById('pdf-econ-mes-valor').textContent = formatCurrency(client.economiaMes);
        document.getElementById('pdf-econ-sem-gd').textContent = formatCurrency(client.econ_total_sem);
        document.getElementById('pdf-econ-com-gd').textContent = formatCurrency(client.econ_total_com);
        document.getElementById('pdf-econ-total-sem').textContent = formatCurrency(client.econ_total_sem);
        document.getElementById('pdf-econ-total-com').textContent = formatCurrency(client.econ_total_com);
        
        document.getElementById('pdf-ref-foot').textContent = refDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }).replace('.', '');
        document.getElementById('pdf-valor-foot').textContent = formatCurrency(client.totalPagar);
        document.getElementById('pdf-venc-foot').textContent = new Date(`${client.vencimento_iso}T12:00:00`).toLocaleDateString('pt-BR');


        const opt = { 
            margin: 0,
            filename: `FaturaCorrigida_${client.instalacao}_${client.nome.split(' ')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        return new Promise((resolve) => {
            setTimeout(async () => {
                const worker = html2pdf().from(element).set(opt);
                const pdf = await worker.toPdf().get('pdf');
                if (pdf.getNumberOfPages() > 1) {
                  pdf.deletePage(2);
                }
                const blob = pdf.output('blob');
                resolve({ blob: blob, filename: opt.filename });
            }, 0);
        });
    }

</script>
</body>
</html>

